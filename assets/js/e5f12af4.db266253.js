"use strict";(self.webpackChunknoobtechnote_github_io_source=self.webpackChunknoobtechnote_github_io_source||[]).push([[3943],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var l=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,l)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,l,i=function(e,t){if(null==e)return{};var a,l,i={},n=Object.keys(e);for(l=0;l<n.length;l++)a=n[l],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(l=0;l<n.length;l++)a=n[l],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=l.createContext({}),c=function(e){var t=l.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=c(e.components);return l.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return l.createElement(l.Fragment,{},t)}},g=l.forwardRef((function(e,t){var a=e.components,i=e.mdxType,n=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(a),g=i,m=u["".concat(s,".").concat(g)]||u[g]||d[g]||n;return a?l.createElement(m,r(r({ref:t},p),{},{components:a})):l.createElement(m,r({ref:t},p))}));function m(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var n=a.length,r=new Array(n);r[0]=g;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[u]="string"==typeof e?e:i,r[1]=o;for(var c=2;c<n;c++)r[c]=a[c];return l.createElement.apply(null,r)}return l.createElement.apply(null,a)}g.displayName="MDXCreateElement"},58072:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>d,frontMatter:()=>n,metadata:()=>o,toc:()=>c});var l=a(87462),i=(a(67294),a(3905));const n={title:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_label:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_position:1},r="\u7b2c\u4e8c\u90e8\u5206: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",o={unversionedId:"sg/ddia/ch5",id:"sg/ddia/ch5",title:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",description:"\u7b2c\u4e00\u90e8\u5206\u662f\u5132\u5b58\u8cc7\u6599\u7684\u6642\u6240\u61c9\u8a72\u8003\u616e\u7684\u5404\u7a2e\u9762\u5411\uff0c\u7b2c\u4e8c\u90e8\u5206\u8a0e\u8ad6\uff1a\u5982\u679c\u8cc7\u6599\u5132\u5b58\u548c\u6aa2\u7d22\u6d89\u53ca\u5230\u591a\u53f0\u6a5f\u5668\uff0c\u6703\u600e\u9ebc\u6a23\uff1f",source:"@site/docs/sg/ddia/ch5.mdx",sourceDirName:"sg/ddia",slug:"/sg/ddia/ch5",permalink:"/docs/sg/ddia/ch5",draft:!1,editUrl:"https://github.com/NoobTechNote/NoobTechNote.github.io/tree/main/docs/sg/ddia/ch5.mdx",tags:[],version:"current",lastUpdatedBy:"mingyen066@gmail.com",lastUpdatedAt:1715045977,formattedLastUpdatedAt:"May 7, 2024",sidebarPosition:1,frontMatter:{title:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_label:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Ch4: \u8cc7\u6599\u7de8\u78bc\u8207\u6f14\u5316",permalink:"/docs/sg/ddia/ch4"},next:{title:"\u9cf3\u51f0\u67b6\u69cb",permalink:"/docs/sg/fenix-architecture/"}},s={},c=[{value:"Scaling to Higher Load",id:"scaling-to-higher-load",level:3},{value:"Scaling up vs. Scaling out",id:"scaling-up-vs-scaling-out",level:4},{value:"Replication vs. Partition",id:"replication-vs-partition",level:3},{value:"Overview",id:"overview",level:2},{value:"Leader and Follower",id:"leader-and-follower",level:2},{value:"Sync vs. Async Replication",id:"sync-vs-async-replication",level:2},{value:"Setting Up New Followers",id:"setting-up-new-followers",level:2},{value:"Follower failure: Catch-up recovery",id:"follower-failure-catch-up-recovery",level:2},{value:"Leader failure: Failover",id:"leader-failure-failover",level:2},{value:"Implementation of Replication Logs",id:"implementation-of-replication-logs",level:2},{value:"\ud83d\udc4e Statement-based replication",id:"-statement-based-replication",level:3},{value:"\ud83d\udc4e Write-ahead log (WAL) shipping",id:"-write-ahead-log-wal-shipping",level:3},{value:"\ud83d\udc4d Logical (row-based) log replication",id:"-logical-row-based-log-replication",level:3},{value:"\ud83d\ude10 Trigger-based replication",id:"-trigger-based-replication",level:3}],p={toc:c},u="wrapper";function d(e){let{components:t,...n}=e;return(0,i.kt)(u,(0,l.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"\u7b2c\u4e8c\u90e8\u5206-\u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71"},"\u7b2c\u4e8c\u90e8\u5206: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71"),(0,i.kt)("p",null,"\u7b2c\u4e00\u90e8\u5206\u662f\u5132\u5b58\u8cc7\u6599\u7684\u6642\u6240\u61c9\u8a72\u8003\u616e\u7684\u5404\u7a2e\u9762\u5411\uff0c\u7b2c\u4e8c\u90e8\u5206\u8a0e\u8ad6\uff1a\u5982\u679c\u8cc7\u6599\u5132\u5b58\u548c\u6aa2\u7d22\u6d89\u53ca\u5230\u591a\u53f0\u6a5f\u5668\uff0c\u6703\u600e\u9ebc\u6a23\uff1f"),(0,i.kt)("p",null,"\u8003\u616e\u4f7f\u7528\u591a\u53f0\u6a5f\u5668\u7684\u6642\u6a5f:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Scalability"),(0,i.kt)("li",{parentName:"ul"},"Fault tolerance/High availability"),(0,i.kt)("li",{parentName:"ul"},"Latency")),(0,i.kt)("h3",{id:"scaling-to-higher-load"},"Scaling to Higher Load"),(0,i.kt)("h4",{id:"scaling-up-vs-scaling-out"},"Scaling up vs. Scaling out"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Scaling up \u53c8\u88ab\u7a31\u70ba vertical scaling"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Share memory \u9650\u5236: \u5f88\u8cb4\uff0c\u5bb9\u932f\u4e0d\u597d\uff0c\u5c31\u7b97\u63d0\u4f9b\u71b1\u63d2\u62d4\u7684 disk, memory\uff0c\u5730\u7406\u4e0a\u4e5f\u4e00\u5b9a\u6703\u6709\u9650\u5236"),(0,i.kt)("li",{parentName:"ul"},"Share disk \u9650\u5236: race condition \u6642\u6703\u6709 lock \u958b\u92b7"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"shared-nothing architecture\uff0c\u53c8\u88ab\u7a31\u70ba horizontal scaling \u6216\u7a31\u70ba scaling out"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"\u57f7\u884c\u8cc7\u6599\u5eab\u8edf\u9ad4\u7684\u6bcf\u81fa\u6a5f\u5668 / \u865b\u64ec\u6a5f\u5668\u90fd\u7a31\u70ba \u7bc0\u9ede\uff08node\uff09\u3002\u6bcf\u500b\u7bc0\u9ede\u53ea\u4f7f\u7528\u5404\u81ea\u7684\u8655\u7406\u5668\uff0c\u8a18\u61b6\u9ad4\u548c\u78c1\u789f\u3002\u7bc0\u9ede\u4e4b\u9593\u7684\u4efb\u4f55\u5354\u8abf\uff0c\u90fd\u662f\u5728\u8edf\u9ad4\u5c64\u9762\u4f7f\u7528\u50b3\u7d71\u7db2\u8def\u5be6\u73fe\u7684\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u7b2c\u4e8c\u90e8\u5206\u4e3b\u8981\u90fd\u5728\u8a0e\u8ad6\u7121\u5171\u4eab\u67b6\u69cb\u6240\u6703\u7522\u751f\u7684\u554f\u984c\u4ee5\u53ca\u6b0a\u8861")))),(0,i.kt)("h3",{id:"replication-vs-partition"},"Replication vs. Partition"),(0,i.kt)("p",null,"\u8cc7\u6599\u5206\u4f48\u5728\u591a\u500b\u7bc0\u9ede\u4e0a\u6709\u5169\u7a2e\u5e38\u898b\u7684\u65b9\u5f0f\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Replication")),(0,i.kt)("p",null,"\u5728\u5e7e\u500b\u4e0d\u540c\u7684\u7bc0\u9ede\u4e0a\u5132\u5b58\u8cc7\u6599\u7684\u76f8\u540c\u526f\u672c\uff0c\u53ef\u80fd\u653e\u5728\u4e0d\u540c\u7684\u4f4d\u7f6e\u3002Replication \u63d0\u4f9b\u4e86\u5197\u9918\uff1a\u5982\u679c\u4e00\u4e9b\u7bc0\u9ede\u4e0d\u53ef\u7528\uff0c\u5269\u9918\u7684\u7bc0\u9ede\u4ecd\u7136\u53ef\u4ee5\u63d0\u4f9b\u8cc7\u6599\u670d\u52d9\u3002Replication \u4e5f\u6709\u52a9\u65bc\u6539\u5584\u6548\u80fd\u3002\u7b2c\u4e94\u7ae0\u5c07\u8a0e\u8ad6 Replication\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Partitioning")),(0,i.kt)("p",null,"\u5c07\u4e00\u500b\u5927\u578b\u8cc7\u6599\u5eab\u62c6\u5206\u6210\u8f03\u5c0f\u7684\u5b50\u96c6\uff08\u7a31\u70ba \u5206\u5272\u69fd\uff0c\u5373 partitions\uff09\uff0c\u5f9e\u800c\u4e0d\u540c\u7684\u5206\u5272\u69fd\u53ef\u4ee5\u6307\u6d3e\u7d66\u4e0d\u540c\u7684 \u7bc0\u9ede\uff08nodes\uff0c\u4ea6\u7a31 \u5206\u7247\uff0c\u5373 sharding\uff09\u3002\u7b2c\u516d\u7ae0\u5c07\u8a0e\u8ad6Partitioning\u3002"),(0,i.kt)("p",null,"\u8907\u88fd\u548c\u5206\u5272\u69fd\u662f\u4e0d\u540c\u7684\u6a5f\u5236\uff0c\u4f46\u5b83\u5011\u7d93\u5e38\u540c\u6642\u4f7f\u7528\u3002\u5982\u4e0b\u5716\u6240\u793a\u3002"),(0,i.kt)("p",null,"\u4e00\u500b Database \u5207\u5206\u70ba\u5169\u500b Partition\uff0c\u6bcf\u500b Partition \u90fd\u6709\u5169\u500b Replication\n",(0,i.kt)("img",{src:a(26665).Z,width:"1122",height:"636"})),(0,i.kt)("p",null,"\u7406\u89e3\u4e86\u9019\u4e9b\u6982\u5ff5\uff0c\u5c31\u53ef\u4ee5\u958b\u59cb\u8a0e\u8ad6\u5728\u5206\u6563\u5f0f\u7cfb\u7d71\u4e2d\u9700\u8981\u505a\u51fa\u7684\u56f0\u96e3\u6289\u64c7\u3002\u7b2c\u4e03\u7ae0 \u5c07\u8a0e\u8ad6 \u4e8b\u52d9\uff08Transaction\uff09\uff0c\u9019\u5c0d\u65bc\u77ad\u89e3\u8cc7\u6599\u7cfb\u7d71\u4e2d\u53ef\u80fd\u51fa\u73fe\u7684\u5404\u7a2e\u554f\u984c\uff0c\u4ee5\u53ca\u6211\u5011\u53ef\u4ee5\u505a\u4e9b\u4ec0\u9ebc\u5f88\u6709\u5e6b\u52a9\u3002\u7b2c\u516b\u7ae0 \u548c \u7b2c\u4e5d\u7ae0 \u5c07\u8a0e\u8ad6\u5206\u6563\u5f0f\u7cfb\u7d71\u7684\u6839\u672c\u4fb7\u9650\u6027\u3002"),(0,i.kt)("h1",{id:"chapter-5-replication"},"Chapter 5 Replication"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(16211).Z,width:"660",height:"816"})),(0,i.kt)("p",null,"The major difference between a thing that might go wrong and a thing that cannot possibly\ngo wrong is that when a thing that cannot possibly go wrong goes wrong it usually turns out\nto be impossible to get at or repair. \u2014Douglas Adams, Mostly Harmless (1992)"),(0,i.kt)("p",null,"Replication \u610f\u5473\u8457\u5728\u900f\u904e\u7db2\u8def\u9023\u7dda\u7684\u591a\u81fa\u6a5f\u5668\u4e0a\u4fdd\u7559\u76f8\u540c\u8cc7\u6599\u7684\u526f\u672c"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"To keep data geographically close to your users (and thus reduce latency)"),(0,i.kt)("li",{parentName:"ul"},"To allow the system to continue working even if some of its parts have failed (and thus increase availability)"),(0,i.kt)("li",{parentName:"ul"},"To scale out the number of machines that can serve read queries (and thus increase read throughput)")),(0,i.kt)("h2",{id:"overview"},"Overview"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Single Leader replication"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Sync vs. Async Replication"),(0,i.kt)("li",{parentName:"ul"},"Leader / Follower failure handling",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Follower failure: catch-up recovery"),(0,i.kt)("li",{parentName:"ul"},"Lead failure: Failover"))),(0,i.kt)("li",{parentName:"ul"},"Replication log and its implementation",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Statement-based replication"),(0,i.kt)("li",{parentName:"ul"},"Write-ahead log(WAL) shipping"),(0,i.kt)("li",{parentName:"ul"},"Logical (row-based) log replication"),(0,i.kt)("li",{parentName:"ul"},"Trigger-based replication"))),(0,i.kt)("li",{parentName:"ul"},"Solution of Replication Lags",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Reading Your Own Writes"),(0,i.kt)("li",{parentName:"ul"},"Monotonic Reads"),(0,i.kt)("li",{parentName:"ul"},"Consistent Prefix Reads"),(0,i.kt)("li",{parentName:"ul"},"Solutions for Replication Lag"))))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Multi Leader replication"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Client offline edit / collaborative editing"),(0,i.kt)("li",{parentName:"ul"},"Conflict detection / avoidance / resolve"),(0,i.kt)("li",{parentName:"ul"},"Conflict definition"),(0,i.kt)("li",{parentName:"ul"},"Multi-leader topology")))),(0,i.kt)("h2",{id:"leader-and-follower"},"Leader and Follower"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(13196).Z,width:"1116",height:"434"}),"\n\u9019\u7a2e\u8907\u88fd\u6a21\u5f0f\u662f\u8a31\u591a\u95dc\u4fc2\u8cc7\u6599\u5eab\u7684\u5167\u5efa\u529f\u80fd\uff0c\u5982 PostgreSQL\uff08\u5f9e 9.0 \u7248\u672c\u958b\u59cb\uff09\u3001MySQL\u3001Oracle Data Guard \u548c SQL Server \u7684 AlwaysOn Availability Groups\u3002\u5b83\u4e5f\u88ab\u7528\u65bc\u4e00\u4e9b Nonrelational DB\uff0c\u5305\u62ec MongoDB\u3002\u6700\u5f8c\uff0c\u57fa\u65bc\u9818\u5c0e\u8005\u7684\u8907\u88fd\u4e26\u4e0d\u50c5\u9650\u65bc\u8cc7\u6599\u5eab\uff1a\u50cf Kafka\u548c RabbitMQ high available queues \u9019\u6a23\u7684\u5206\u6563\u5f0fmessage brokers \u4e5f\u4f7f\u7528\u5b83\u3002\u67d0\u4e9b\u7db2\u8def\u6a94\u6848\u7cfb\u7d71\uff0c\u4f8b\u5982 DRBD \u9019\u6a23\u7684replicated block devices\u4e5f\u8207\u4e4b\u985e\u4f3c\u3002"),(0,i.kt)("h2",{id:"sync-vs-async-replication"},"Sync vs. Async Replication"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(11634).Z,width:"1122",height:"552"}),"\n",(0,i.kt)("strong",{parentName:"p"},"Special case:"),"\n",(0,i.kt)("a",{parentName:"p",href:"https://www.cs.cornell.edu/home/rvr/papers/OSDI04.pdf"},"Chain Replication"),"\n(used in Azure Storage and Amazon EBS)"),(0,i.kt)("h2",{id:"setting-up-new-followers"},"Setting Up New Followers"),(0,i.kt)("p",null,"\u7c21\u55ae\u5730\u5c07\u8cc7\u6599\u6a94\u6848\u5f9e\u4e00\u500b\u7bc0\u9ede\u8907\u88fd\u5230\u53e6\u4e00\u500b\u7bc0\u9ede\u901a\u5e38\u662f\u4e0d\u5920\u7684\uff1a\u56e0\u70ba\u5ba2\u6236\u7aef\u6703\u4e0d\u65b7\u5411\u8cc7\u6599\u5eab\u5beb\u5165\u8cc7\u6599"),(0,i.kt)("p",null,"\u53ef\u4ee5\u900f\u904e Lock \u8cc7\u6599\u5eab\u4f86\u4f7f\u78c1\u789f\u4e0a\u7684\u6a94\u6848\u4fdd\u6301\u4e00\u81f4(\u50cf\u9280\u884c\u7cfb\u7d71) \uff0c\u4f46\u662f\u9019\u6703\u9055\u80cc\u9ad8\u53ef\u7528\u7684\u76ee\u6a19\u3002"),(0,i.kt)("p",null,"\u597d\u96aa\u8a2d\u5b9a\u65b0 Follower \u901a\u5e38\u4e26\u4e0d\u9700\u8981\u505c\u6a5f\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Take a consistent snapshot of the leader's database"),(0,i.kt)("li",{parentName:"ol"},"Copy snapshot to follower"),(0,i.kt)("li",{parentName:"ol"},"\u5f9e follower \u9023\u7dda\u5230 leader\uff0c\u4e26\u62c9\u53d6\u5feb\u7167\u4e4b\u5f8c\u767c\u751f\u7684\u6240\u6709\u8cc7\u6599\u8b8a\u66f4\u3002\u9019\u8981\u6c42\u5feb\u7167\u8207leader replication log \u4e2d\u7684\u4f4d\u7f6e\u7cbe\u78ba\u95dc\u806f\u3002PostgreSQL \u5c07\u5176\u7a31\u70ba log sequence number\uff0cMySQL \u5c07\u5176\u7a31\u70ba binlog coordinates\u3002")),(0,i.kt)("p",null,"\u7576 follower \u8655\u7406\u5b8c\u5feb\u7167\u4e4b\u5f8c\u7a4d\u7d2f\u7684\u8cc7\u6599\u8b8a\u66f4\uff0c\u6211\u5011\u5c31\u8aaa\u5b83 caught up \u4e86"),(0,i.kt)("p",null,"\u5efa\u7acbfollower\u7684\u5be6\u969b\u6b65\u9a5f\u56e0\u8cc7\u6599\u5eab\u800c\u7570\u3002\u6709\u53ef\u80fd\u624b\u52d5\u6216\u81ea\u52d5\u6216\u8005\u4e00\u4e9b\u795e\u79d8\u7684\u5de5\u4f5c\u6d41\u7a0b"),(0,i.kt)("h2",{id:"follower-failure-catch-up-recovery"},"Follower failure: Catch-up recovery"),(0,i.kt)("p",null,"\u6bcf\u500b Follower \u5728 disk \u4e0a\u8a18\u9304\u5f9e Leader \u6536\u5230\u7684\u8cc7\u6599\u8b8a\u66f4\u3002\u5982\u679c Follower \u58de\u6389\u91cd\u65b0\u555f\u52d5\u6216\u65b7\u7db2\uff0c\u5247 Follower \u53ef\u4ee5\u5f9e\u65e5\u8a8c\u4e2d\u77e5\u9053\u5728\u767c\u751f\u6545\u969c\u4e4b\u524d\u8655\u7406\u7684\u6700\u5f8c\u4e00\u500bTransaction\u3002\u4e4b\u5f8c Follower \u53ef\u4ee5\u9023\u7dda\u5230 Leader\uff0c\u4e26\u8acb\u6c42\u5728\u58de\u6389\u671f\u9593\u767c\u751f\u7684\u6240\u6709\u8cc7\u6599\u8b8a\u66f4\u3002"),(0,i.kt)("h2",{id:"leader-failure-failover"},"Leader failure: Failover"),(0,i.kt)("p",null,"\u5176\u4e2d\u4e00\u500b Follower \u8981\u88ab promote \u70ba\u65b0\u7684 Leader\uff0c\u9700\u8981\u91cd\u65b0\u914d\u7f6e\u5ba2\u6236\u7aef\uff0c\u4ee5\u5c07\u5b83\u5011\u7684\u5beb\u64cd\u4f5c\u50b3\u9001\u7d66\u65b0\u7684 Leader\uff0c\u5176\u4ed6 Follower \u9700\u8981\u958b\u59cb\u62c9\u53d6\u4f86\u81ea\u65b0 Leader \u7684\u8cc7\u6599\u8b8a\u66f4\u3002\u9019\u500b\u904e\u7a0b\u88ab\u7a31\u70ba failover"),(0,i.kt)("p",null,"failover\u53ef\u4ee5\u624b\u52d5\u6216\u81ea\u52d5\u3002\u81ea\u52d5\u7684failover\u6b65\u9a5f\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u78ba\u8a8d Leader \u5931\u6548\u3002\u6709\u5f88\u591a\u4e8b\u60c5\u53ef\u80fd\u6703\u51fa\u932f\uff1a\u5d29\u6f70\u3001\u505c\u96fb\u3001\u7db2\u8def\u554f\u984c\u7b49\u7b49\u3002\u6c92\u6709\u842c\u7121\u4e00\u5931\u7684\u65b9\u6cd5\uff0c\u6240\u4ee5\u5927\u591a\u6578\u7cfb\u7d71\u53ea\u662f\u7c21\u55ae\u4f7f\u7528Timeout"),(0,i.kt)("li",{parentName:"ol"},"\u9078\u64c7\u4e00\u500b\u65b0\u7684 Leader \u3002\u9019\u53ef\u4ee5\u900f\u904e\u9078\u8209\u904e\u7a0b\uff08 Leader \u7531\u5269\u9918 Follower \u4ee5\u591a\u6578\u9078\u8209\u7522\u751f\uff09\u4f86\u5b8c\u6210(\u9700\u8981\u5171\u8b58\u6f14\u7b97\u6cd5)\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u91cd\u65b0\u914d\u7f6e\u7cfb\u7d71\u4ee5\u555f\u7528\u65b0\u7684 Leader\u3002\u5ba2\u6236\u7aef\u73fe\u5728\u9700\u8981\u5c07\u5b83\u5011\u7684\u5beb\u8acb\u6c42\u50b3\u9001\u7d66\u65b0 Leader\u3002\u5982\u679c\u820a Leader \u6062\u5fa9\uff0c\u53ef\u80fd\u4ecd\u7136\u8a8d\u70ba\u81ea\u5df1\u662f Leader \uff0c\u800c\u6c92\u6709\u610f\u8b58\u5230\u5176\u4ed6\u526f\u672c\u5df2\u7d93\u8b93\u5b83\u5931\u53bb\u9818\u5c0e\u6b0a\u4e86\u3002\u7cfb\u7d71\u9700\u8981\u78ba\u4fdd\u820a Leader \u610f\u8b58\u5230\u65b0 Leader \u7684\u5b58\u5728\uff0c\u4f75\u6210\u70ba\u4e00\u500b Follower \u3002")),(0,i.kt)("p",null,"\u6545\u969c\u5207\u63db\u7684\u904e\u7a0b\u4e2d\u6709\u5f88\u591a\u5730\u65b9\u53ef\u80fd\u51fa\u932f\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u65b0 Leader \u6c92\u6709\u6536\u5230\u8001 Leader \u639b\u6389\u524d\u6700\u5f8c\u7684\u5beb\u5165\u64cd\u4f5c\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u8cc7\u6599\u5eab\u9700\u8981\u548c\u5176\u4ed6\u5916\u90e8\u5132\u5b58\u76f8\u5354\u8abf\uff0c\u90a3\u9ebc\u4e1f\u68c4\u5beb\u5165\u5167\u5bb9\u662f\u6975\u5176\u5371\u96aa\u7684\u64cd\u4f5c\u3002 Example: \u4f8b\u5982\u5728 GitHub \u7684\u4e00\u5834\u4e8b\u6545\u4e2d\uff0c\u4e00\u500b\u904e\u6642\u7684 MySQL Follower \u88ab\u63d0\u5347\u70baLeader\u3002\u8cc7\u6599\u5eab\u4f7f\u7528\u81ea\u589e ID \u4f5c\u70baPrimary\uff0c\u56e0\u70ba\u65b0\u4e3b\u5eab\u7684\u8a08\u6578\u5668\u843d\u5f8c\u65bc\u8001\u4e3b\u5eab\u7684\u8a08\u6578\u5668\uff0c\u6240\u4ee5\u65b0\u4e3b\u5eab\u91cd\u65b0\u5206\u914d\u4e86\u4e00\u4e9b\u5df2\u7d93\u88ab\u8001\u4e3b\u5eab\u5206\u914d\u6389\u7684 ID \u4f5c\u70ba\u4e3b\u9375\u3002\u9019\u4e9b\u4e3b\u9375\u4e5f\u5728 Redis \u4e2d\u4f7f\u7528\uff0c\u4e3b\u9375\u91cd\u7528\u4f7f\u5f97 MySQL \u548c Redis \u4e2d\u7684\u8cc7\u6599\u7522\u751f\u4e0d\u4e00\u81f4\uff0c\u6700\u5f8c\u5c0e\u81f4\u4e00\u4e9b\u79c1\u6709\u8cc7\u6599\u6d29\u6f0f\u5230\u932f\u8aa4\u7684\u4f7f\u7528\u8005\u624b\u4e2d\u3002"),(0,i.kt)("li",{parentName:"ul"},"Split brain"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u4f55\u77e5\u9053 Leader \u662f\u771f\u7684\u639b\u6389\u4e86\uff0c\u5982\u679c\u53ea\u662fSpike\uff0c\u53cd\u800c\u6703\u52a0\u91cd\u8ca0\u64d4")),(0,i.kt)("h2",{id:"implementation-of-replication-logs"},"Implementation of Replication Logs"),(0,i.kt)("h3",{id:"-statement-based-replication"},"\ud83d\udc4e Statement-based replication"),(0,i.kt)("p",null,"\u8907\u88fd\u6bcf\u500b statement \u5230 follower \u57f7\u884c\uff0c\u50cf SQL statement\uff0c\u4f46\u662f\u5f88\u591a\u60c5\u6cc1\u6703\u5c0e\u81f4 replication \u58de\u6389"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"nondeterministic function, such as NOW() or RAND() is likely to generate a different value on each replica."),(0,i.kt)("li",{parentName:"ol"},"If statements depend on the existing data in the database (e.g., UPDATE ... WHERE ...),  must be executed in exactly the same order on each replica"),(0,i.kt)("li",{parentName:"ol"},"side effects (e.g., triggers, stored procedures, user-defined functions)")),(0,i.kt)("h3",{id:"-write-ahead-log-wal-shipping"},"\ud83d\udc4e Write-ahead log (WAL) shipping"),(0,i.kt)("p",null,"usually every write to a database is appended to a log"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"In SSTables and LSM-Trees, WAL is the main place for storage. Log segments are compacted in the background."),(0,i.kt)("li",{parentName:"ul"},"In B-tree, every modification is first written to a WAL so that the index can be restored to a consistent state after a crash.")),(0,i.kt)("p",null,"\u597d\u8655\uff1aWAL \u5305\u542b\u4e86\u6240\u6709\u8cc7\u6599\u5eab\u5beb\u5165\u7684append-only sequence of bytes\u3002\u53ef\u4ee5\u4f7f\u7528\u5b8c\u5168\u76f8\u540c\u7684\u65e5\u8a8c\u5728\u53e6\u4e00\u500b\u7bc0\u9ede\u4e0a\u69cb\u5efa\u4e00\u6a21\u4e00\u6a23\u7684 replica"),(0,i.kt)("p",null,"\u7f3a\u9ede\uff1a\u975e\u5e38\u5e95\u5c64\uff0c\u7121\u6cd5\u770b\u61c2\uff0c\u8ddfstorage engine\u8026\u5408\uff0c\u63db\u7248\u672c\u6216\u63dbstorage engine\u53ef\u80fd\u6703\u6709downtime"),(0,i.kt)("h3",{id:"-logical-row-based-log-replication"},"\ud83d\udc4d Logical (row-based) log replication"),(0,i.kt)("p",null,"\u4e0d\u7d81\u5b9astorage engine\uff0c\u53ef\u4ee5\u53ea\u5132\u5b58\u4f5creplication\u6240\u9700\u8981\u7684\u5fc5\u8981\u8cc7\u8a0a\nlogical log  is usually at the granularity of a row:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For an inserted row, the log contains the new values of all columns."),(0,i.kt)("li",{parentName:"ul"},"For a deleted row, the log contains enough information to uniquely identify the\nrow that was deleted. Typically this would be the primary key, but if there is no\nprimary key on the table, the old values of all columns need to be logged."),(0,i.kt)("li",{parentName:"ul"},"For an updated row, the log contains enough information to uniquely identify\nthe updated row, and the new values of all columns (or at least the new values of\nall columns that changed).")),(0,i.kt)("p",null,"Ref:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.postgresql.org/docs/current/logical-replication.html"},"https://www.postgresql.org/docs/current/logical-replication.html")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://dev.mysql.com/doc/refman/8.0/en/replication.html"},"https://dev.mysql.com/doc/refman/8.0/en/replication.html"))),(0,i.kt)("h3",{id:"-trigger-based-replication"},"\ud83d\ude10 Trigger-based replication"),(0,i.kt)("p",null,"\u5ba2\u88fd\u5316\u5de5\u5177\uff0c\u53ea\u9700\u8907\u88fd\u81ea\u5df1\u6307\u5b9a\u7bc4\u570d\u7684\u8cc7\u6599\uff0c\u6216\u8005\u5728\u81ea\u5df1\u60f3\u8981\u7684\u6642\u9593trigger"),(0,i.kt)("p",null,"For Example:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.oracle.com/integration/goldengate/"},"Oracle GoldenGate")),(0,i.kt)("li",{parentName:"ul"},"Store procedure"),(0,i.kt)("li",{parentName:"ul"},"triggers")),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(93809).Z,width:"1114",height:"542"}),"\n",(0,i.kt)("img",{src:a(73749).Z,width:"1102",height:"660"}),"\n",(0,i.kt)("img",{src:a(93485).Z,width:"1102",height:"596"}),"\n",(0,i.kt)("img",{src:a(14517).Z,width:"1104",height:"544"}),"\n",(0,i.kt)("img",{src:a(8872).Z,width:"1104",height:"376"}),"\n",(0,i.kt)("img",{src:a(46453).Z,width:"1106",height:"714"})))}d.isMDXComponent=!0},26665:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-1-combine-partition-and-replication-8c142d49bc23362230859996328fb9cd.png"},46453:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-10-wrong-order-arrive-26d40fb44b68434ec82e921c0ba6d4d3.jpg"},16211:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-2-ch5-7a9232a9b9fe741836c5f7b212f02e9c.jpg"},13196:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-3-leader-based-replication-4dfc89caadd89f8be2800015eccba2e1.jpg"},11634:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-4-sync-versus-async-follower-2cc0f2137c4981f53cbc92a8a449e2b5.jpg"},93809:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-5-write-but-read-nothing-33c88ccb0b133045f329a9822b1314f9.jpg"},73749:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-6-time-go-backward-4867763ad3407dac97f40605b12e16d3.jpg"},93485:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-7-multi-leader-52a90b584cbdb2766d087faeb81aa70a.jpg"},14517:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-8-write-conflict-2944fc788bb4e7790fce1d8fdcbcb699.jpg"},8872:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-9-topology-7a0187f0bcf726fd9e69c27e8dfd032a.jpg"}}]);