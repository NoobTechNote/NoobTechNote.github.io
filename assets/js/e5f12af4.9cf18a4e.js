"use strict";(self.webpackChunknoobtechnote_github_io_source=self.webpackChunknoobtechnote_github_io_source||[]).push([[3943],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>g});var l=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function n(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,l)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?n(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,l,i=function(e,t){if(null==e)return{};var a,l,i={},n=Object.keys(e);for(l=0;l<n.length;l++)a=n[l],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(l=0;l<n.length;l++)a=n[l],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var s=l.createContext({}),c=function(e){var t=l.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},p=function(e){var t=c(e.components);return l.createElement(s.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return l.createElement(l.Fragment,{},t)}},m=l.forwardRef((function(e,t){var a=e.components,i=e.mdxType,n=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=c(a),m=i,g=u["".concat(s,".").concat(m)]||u[m]||d[m]||n;return a?l.createElement(g,r(r({ref:t},p),{},{components:a})):l.createElement(g,r({ref:t},p))}));function g(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var n=a.length,r=new Array(n);r[0]=m;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[u]="string"==typeof e?e:i,r[1]=o;for(var c=2;c<n;c++)r[c]=a[c];return l.createElement.apply(null,r)}return l.createElement.apply(null,a)}m.displayName="MDXCreateElement"},58072:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>d,frontMatter:()=>n,metadata:()=>o,toc:()=>c});var l=a(87462),i=(a(67294),a(3905));const n={title:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_label:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_position:4},r="\u7b2c\u4e8c\u90e8\u5206: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",o={unversionedId:"sg/ddia/ch5",id:"sg/ddia/ch5",title:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",description:"\u7b2c\u4e00\u90e8\u5206\u662f\u5132\u5b58\u8cc7\u6599\u7684\u6642\u6240\u61c9\u8a72\u8003\u616e\u7684\u5404\u7a2e\u9762\u5411\uff0c\u7b2c\u4e8c\u90e8\u5206\u8a0e\u8ad6\uff1a\u5982\u679c\u8cc7\u6599\u5132\u5b58\u548c\u6aa2\u7d22\u6d89\u53ca\u5230\u591a\u53f0\u6a5f\u5668\uff0c\u6703\u600e\u9ebc\u6a23\uff1f",source:"@site/docs/sg/ddia/ch5.mdx",sourceDirName:"sg/ddia",slug:"/sg/ddia/ch5",permalink:"/docs/sg/ddia/ch5",draft:!1,editUrl:"https://github.com/NoobTechNote/NoobTechNote.github.io/tree/main/docs/sg/ddia/ch5.mdx",tags:[],version:"current",lastUpdatedBy:"David C Tsai",lastUpdatedAt:1716947824,formattedLastUpdatedAt:"May 29, 2024",sidebarPosition:4,frontMatter:{title:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_label:"Ch5: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Ch4: \u8cc7\u6599\u7de8\u78bc\u8207\u6f14\u5316",permalink:"/docs/sg/ddia/ch4"},next:{title:"Ch5: \u8907\u88fd:\u7121\u4e3b\u8907\u88fd",permalink:"/docs/sg/ddia/ch5-leaderless"}},s={},c=[{value:"Scaling to Higher Load",id:"scaling-to-higher-load",level:3},{value:"Scaling up vs. Scaling out",id:"scaling-up-vs-scaling-out",level:4},{value:"Replication vs. Partition",id:"replication-vs-partition",level:3},{value:"Overview",id:"overview",level:2},{value:"Leader and Follower",id:"leader-and-follower",level:2},{value:"Sync vs. Async Replication",id:"sync-vs-async-replication",level:3},{value:"Setting Up New Followers",id:"setting-up-new-followers",level:3},{value:"Follower failure: Catch-up recovery",id:"follower-failure-catch-up-recovery",level:3},{value:"Leader failure: Failover",id:"leader-failure-failover",level:3},{value:"Implementation of Replication Logs",id:"implementation-of-replication-logs",level:3},{value:"\ud83d\udc4e Statement-based replication",id:"-statement-based-replication",level:4},{value:"\ud83d\udc4e Write-ahead log (WAL) shipping",id:"-write-ahead-log-wal-shipping",level:4},{value:"\ud83d\udc4d Logical (row-based) log replication",id:"-logical-row-based-log-replication",level:4},{value:"\ud83d\ude10 Trigger-based replication",id:"-trigger-based-replication",level:3},{value:"Problems with Replication Lag",id:"problems-with-replication-lag",level:2},{value:"Read Your Own Writes",id:"read-your-own-writes",level:3},{value:"Solutions:",id:"solutions",level:4},{value:"Consistent Prefix Reads",id:"consistent-prefix-reads",level:3},{value:"Solutions for Replication Lag",id:"solutions-for-replication-lag",level:3},{value:"Multi-Leader Replication",id:"multi-leader-replication",level:2},{value:"Use Cases for Multi-Leader Replication",id:"use-cases-for-multi-leader-replication",level:3},{value:"Multi-datacenter operation",id:"multi-datacenter-operation",level:4},{value:"Clients with offline operation",id:"clients-with-offline-operation",level:4},{value:"Collaborative editing",id:"collaborative-editing",level:4},{value:"Handling Write Conflicts",id:"handling-write-conflicts",level:3},{value:"Synchronous versus asynchronous conflict detection",id:"synchronous-versus-asynchronous-conflict-detection",level:4},{value:"Conflict avoidance",id:"conflict-avoidance",level:4},{value:"Converging toward a consistent state",id:"converging-toward-a-consistent-state",level:4},{value:"Custom conflict resolution logic",id:"custom-conflict-resolution-logic",level:4},{value:"Automatic Conflict Resolution",id:"automatic-conflict-resolution",level:4},{value:"Multi-Leader Replication Topologies",id:"multi-leader-replication-topologies",level:3}],p={toc:c},u="wrapper";function d(e){let{components:t,...n}=e;return(0,i.kt)(u,(0,l.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"\u7b2c\u4e8c\u90e8\u5206-\u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71"},"\u7b2c\u4e8c\u90e8\u5206: \u5206\u6563\u5f0f\u8cc7\u6599\u7cfb\u7d71"),(0,i.kt)("p",null,"\u7b2c\u4e00\u90e8\u5206\u662f\u5132\u5b58\u8cc7\u6599\u7684\u6642\u6240\u61c9\u8a72\u8003\u616e\u7684\u5404\u7a2e\u9762\u5411\uff0c\u7b2c\u4e8c\u90e8\u5206\u8a0e\u8ad6\uff1a\u5982\u679c\u8cc7\u6599\u5132\u5b58\u548c\u6aa2\u7d22\u6d89\u53ca\u5230\u591a\u53f0\u6a5f\u5668\uff0c\u6703\u600e\u9ebc\u6a23\uff1f"),(0,i.kt)("p",null,"\u8003\u616e\u4f7f\u7528\u591a\u53f0\u6a5f\u5668\u7684\u6642\u6a5f:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Scalability"),(0,i.kt)("li",{parentName:"ul"},"Fault tolerance/High availability"),(0,i.kt)("li",{parentName:"ul"},"Latency")),(0,i.kt)("h3",{id:"scaling-to-higher-load"},"Scaling to Higher Load"),(0,i.kt)("h4",{id:"scaling-up-vs-scaling-out"},"Scaling up vs. Scaling out"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Scaling up \u53c8\u88ab\u7a31\u70ba vertical scaling"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Share memory \u9650\u5236: \u5f88\u8cb4\uff0c\u5bb9\u932f\u4e0d\u597d\uff0c\u5c31\u7b97\u63d0\u4f9b\u71b1\u63d2\u62d4\u7684 disk, memory\uff0c\u5730\u7406\u4e0a\u4e5f\u4e00\u5b9a\u6703\u6709\u9650\u5236"),(0,i.kt)("li",{parentName:"ul"},"Share disk \u9650\u5236: race condition \u6642\u6703\u6709 lock \u958b\u92b7"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"shared-nothing architecture\uff0c\u53c8\u88ab\u7a31\u70ba horizontal scaling \u6216\u7a31\u70ba scaling out"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"\u57f7\u884c\u8cc7\u6599\u5eab\u8edf\u9ad4\u7684\u6bcf\u81fa\u6a5f\u5668 / \u865b\u64ec\u6a5f\u5668\u90fd\u7a31\u70ba \u7bc0\u9ede\uff08node\uff09\u3002\u6bcf\u500b\u7bc0\u9ede\u53ea\u4f7f\u7528\u5404\u81ea\u7684\u8655\u7406\u5668\uff0c\u8a18\u61b6\u9ad4\u548c\u78c1\u789f\u3002\u7bc0\u9ede\u4e4b\u9593\u7684\u4efb\u4f55\u5354\u8abf\uff0c\u90fd\u662f\u5728\u8edf\u9ad4\u5c64\u9762\u4f7f\u7528\u50b3\u7d71\u7db2\u8def\u5be6\u73fe\u7684\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u7b2c\u4e8c\u90e8\u5206\u4e3b\u8981\u90fd\u5728\u8a0e\u8ad6\u7121\u5171\u4eab\u67b6\u69cb\u6240\u6703\u7522\u751f\u7684\u554f\u984c\u4ee5\u53ca\u6b0a\u8861")))),(0,i.kt)("h3",{id:"replication-vs-partition"},"Replication vs. Partition"),(0,i.kt)("p",null,"\u8cc7\u6599\u5206\u4f48\u5728\u591a\u500b\u7bc0\u9ede\u4e0a\u6709\u5169\u7a2e\u5e38\u898b\u7684\u65b9\u5f0f\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Replication")),(0,i.kt)("p",null,"\u5728\u5e7e\u500b\u4e0d\u540c\u7684\u7bc0\u9ede\u4e0a\u5132\u5b58\u8cc7\u6599\u7684\u76f8\u540c\u526f\u672c\uff0c\u53ef\u80fd\u653e\u5728\u4e0d\u540c\u7684\u4f4d\u7f6e\u3002Replication \u63d0\u4f9b\u4e86\u5197\u9918\uff1a\u5982\u679c\u4e00\u4e9b\u7bc0\u9ede\u4e0d\u53ef\u7528\uff0c\u5269\u9918\u7684\u7bc0\u9ede\u4ecd\u7136\u53ef\u4ee5\u63d0\u4f9b\u8cc7\u6599\u670d\u52d9\u3002Replication \u4e5f\u6709\u52a9\u65bc\u6539\u5584\u6548\u80fd\u3002\u7b2c\u4e94\u7ae0\u5c07\u8a0e\u8ad6 Replication\u3002"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Partitioning")),(0,i.kt)("p",null,"\u5c07\u4e00\u500b\u5927\u578b\u8cc7\u6599\u5eab\u62c6\u5206\u6210\u8f03\u5c0f\u7684\u5b50\u96c6\uff08\u7a31\u70ba \u5206\u5272\u69fd\uff0c\u5373 partitions\uff09\uff0c\u5f9e\u800c\u4e0d\u540c\u7684\u5206\u5272\u69fd\u53ef\u4ee5\u6307\u6d3e\u7d66\u4e0d\u540c\u7684 \u7bc0\u9ede\uff08nodes\uff0c\u4ea6\u7a31 \u5206\u7247\uff0c\u5373 sharding\uff09\u3002\u7b2c\u516d\u7ae0\u5c07\u8a0e\u8ad6Partitioning\u3002"),(0,i.kt)("p",null,"\u8907\u88fd\u548c\u5206\u5272\u69fd\u662f\u4e0d\u540c\u7684\u6a5f\u5236\uff0c\u4f46\u5b83\u5011\u7d93\u5e38\u540c\u6642\u4f7f\u7528\u3002\u5982\u4e0b\u5716\u6240\u793a\u3002"),(0,i.kt)("p",null,"\u4e00\u500b Database \u5207\u5206\u70ba\u5169\u500b Partition\uff0c\u6bcf\u500b Partition \u90fd\u6709\u5169\u500b Replication\n",(0,i.kt)("img",{src:a(26665).Z,width:"1122",height:"636"})),(0,i.kt)("p",null,"\u7406\u89e3\u4e86\u9019\u4e9b\u6982\u5ff5\uff0c\u5c31\u53ef\u4ee5\u958b\u59cb\u8a0e\u8ad6\u5728\u5206\u6563\u5f0f\u7cfb\u7d71\u4e2d\u9700\u8981\u505a\u51fa\u7684\u56f0\u96e3\u6289\u64c7\u3002\u7b2c\u4e03\u7ae0 \u5c07\u8a0e\u8ad6 \u4e8b\u52d9\uff08Transaction\uff09\uff0c\u9019\u5c0d\u65bc\u77ad\u89e3\u8cc7\u6599\u7cfb\u7d71\u4e2d\u53ef\u80fd\u51fa\u73fe\u7684\u5404\u7a2e\u554f\u984c\uff0c\u4ee5\u53ca\u6211\u5011\u53ef\u4ee5\u505a\u4e9b\u4ec0\u9ebc\u5f88\u6709\u5e6b\u52a9\u3002\u7b2c\u516b\u7ae0 \u548c \u7b2c\u4e5d\u7ae0 \u5c07\u8a0e\u8ad6\u5206\u6563\u5f0f\u7cfb\u7d71\u7684\u6839\u672c\u4fb7\u9650\u6027\u3002"),(0,i.kt)("h1",{id:"chapter-5-replication"},"Chapter 5 Replication"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(16211).Z,width:"660",height:"816"})),(0,i.kt)("p",null,"The major difference between a thing that might go wrong and a thing that cannot possibly\ngo wrong is that when a thing that cannot possibly go wrong goes wrong it usually turns out\nto be impossible to get at or repair. \u2014Douglas Adams, Mostly Harmless (1992)"),(0,i.kt)("p",null,"Replication \u610f\u5473\u8457\u5728\u900f\u904e\u7db2\u8def\u9023\u7dda\u7684\u591a\u81fa\u6a5f\u5668\u4e0a\u4fdd\u7559\u76f8\u540c\u8cc7\u6599\u7684\u526f\u672c"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"To keep data geographically close to your users (and thus reduce latency)"),(0,i.kt)("li",{parentName:"ul"},"To allow the system to continue working even if some of its parts have failed (and thus increase availability)"),(0,i.kt)("li",{parentName:"ul"},"To scale out the number of machines that can serve read queries (and thus increase read throughput)")),(0,i.kt)("h2",{id:"overview"},"Overview"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Single Leader replication"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Sync vs. Async Replication"),(0,i.kt)("li",{parentName:"ul"},"Leader / Follower failure handling",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Follower failure: catch-up recovery"),(0,i.kt)("li",{parentName:"ul"},"Lead failure: Failover"))),(0,i.kt)("li",{parentName:"ul"},"Replication log and its implementation",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Statement-based replication"),(0,i.kt)("li",{parentName:"ul"},"Write-ahead log(WAL) shipping"),(0,i.kt)("li",{parentName:"ul"},"Logical (row-based) log replication"),(0,i.kt)("li",{parentName:"ul"},"Trigger-based replication"))),(0,i.kt)("li",{parentName:"ul"},"Replication Lag Problems and Solution",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Reading Your Own Writes"),(0,i.kt)("li",{parentName:"ul"},"Monotonic Reads"),(0,i.kt)("li",{parentName:"ul"},"Consistent Prefix Reads"),(0,i.kt)("li",{parentName:"ul"},"Solutions for Replication Lag"))))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Multi Leader replication"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Client offline edit / collaborative editing"),(0,i.kt)("li",{parentName:"ul"},"Conflict detection / avoidance / resolve"),(0,i.kt)("li",{parentName:"ul"},"Conflict definition"),(0,i.kt)("li",{parentName:"ul"},"Multi-leader topology")))),(0,i.kt)("h2",{id:"leader-and-follower"},"Leader and Follower"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(13196).Z,width:"1116",height:"434"}),"\n\u9019\u7a2e\u8907\u88fd\u6a21\u5f0f\u662f\u8a31\u591a\u95dc\u4fc2\u8cc7\u6599\u5eab\u7684\u5167\u5efa\u529f\u80fd\uff0c\u5982 PostgreSQL\uff08\u5f9e 9.0 \u7248\u672c\u958b\u59cb\uff09\u3001MySQL\u3001Oracle Data Guard \u548c SQL Server \u7684 AlwaysOn Availability Groups\u3002\u5b83\u4e5f\u88ab\u7528\u65bc\u4e00\u4e9b Nonrelational DB\uff0c\u5305\u62ec MongoDB\u3002\u6700\u5f8c\uff0c\u57fa\u65bc\u9818\u5c0e\u8005\u7684\u8907\u88fd\u4e26\u4e0d\u50c5\u9650\u65bc\u8cc7\u6599\u5eab\uff1a\u50cf Kafka\u548c RabbitMQ high available queues \u9019\u6a23\u7684\u5206\u6563\u5f0fmessage brokers \u4e5f\u4f7f\u7528\u5b83\u3002\u67d0\u4e9b\u7db2\u8def\u6a94\u6848\u7cfb\u7d71\uff0c\u4f8b\u5982 DRBD \u9019\u6a23\u7684replicated block devices\u4e5f\u8207\u4e4b\u985e\u4f3c\u3002"),(0,i.kt)("h3",{id:"sync-vs-async-replication"},"Sync vs. Async Replication"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(11634).Z,width:"1122",height:"552"}),"\n",(0,i.kt)("strong",{parentName:"p"},"Special case:"),"\n",(0,i.kt)("a",{parentName:"p",href:"https://www.cs.cornell.edu/home/rvr/papers/OSDI04.pdf"},"Chain Replication"),"\n(used in Azure Storage and Amazon EBS)"),(0,i.kt)("h3",{id:"setting-up-new-followers"},"Setting Up New Followers"),(0,i.kt)("p",null,"\u7c21\u55ae\u5730\u5c07\u8cc7\u6599\u6a94\u6848\u5f9e\u4e00\u500b\u7bc0\u9ede\u8907\u88fd\u5230\u53e6\u4e00\u500b\u7bc0\u9ede\u901a\u5e38\u662f\u4e0d\u5920\u7684\uff1a\u56e0\u70ba\u5ba2\u6236\u7aef\u6703\u4e0d\u65b7\u5411\u8cc7\u6599\u5eab\u5beb\u5165\u8cc7\u6599"),(0,i.kt)("p",null,"\u53ef\u4ee5\u900f\u904e Lock \u8cc7\u6599\u5eab\u4f86\u4f7f\u78c1\u789f\u4e0a\u7684\u6a94\u6848\u4fdd\u6301\u4e00\u81f4(\u50cf\u9280\u884c\u7cfb\u7d71) \uff0c\u4f46\u662f\u9019\u6703\u9055\u80cc\u9ad8\u53ef\u7528\u7684\u76ee\u6a19\u3002"),(0,i.kt)("p",null,"\u597d\u96aa\u8a2d\u5b9a\u65b0 Follower \u901a\u5e38\u4e26\u4e0d\u9700\u8981\u505c\u6a5f\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Take a consistent snapshot of the leader's database"),(0,i.kt)("li",{parentName:"ol"},"Copy snapshot to follower"),(0,i.kt)("li",{parentName:"ol"},"\u5f9e follower \u9023\u7dda\u5230 leader\uff0c\u4e26\u62c9\u53d6\u5feb\u7167\u4e4b\u5f8c\u767c\u751f\u7684\u6240\u6709\u8cc7\u6599\u8b8a\u66f4\u3002\u9019\u8981\u6c42\u5feb\u7167\u8207leader replication log \u4e2d\u7684\u4f4d\u7f6e\u7cbe\u78ba\u95dc\u806f\u3002PostgreSQL \u5c07\u5176\u7a31\u70ba log sequence number\uff0cMySQL \u5c07\u5176\u7a31\u70ba binlog coordinates\u3002")),(0,i.kt)("p",null,"\u7576 follower \u8655\u7406\u5b8c\u5feb\u7167\u4e4b\u5f8c\u7a4d\u7d2f\u7684\u8cc7\u6599\u8b8a\u66f4\uff0c\u6211\u5011\u5c31\u8aaa\u5b83 caught up \u4e86"),(0,i.kt)("p",null,"\u5efa\u7acbfollower\u7684\u5be6\u969b\u6b65\u9a5f\u56e0\u8cc7\u6599\u5eab\u800c\u7570\u3002\u6709\u53ef\u80fd\u624b\u52d5\u6216\u81ea\u52d5\u6216\u8005\u4e00\u4e9b\u795e\u79d8\u7684\u5de5\u4f5c\u6d41\u7a0b"),(0,i.kt)("h3",{id:"follower-failure-catch-up-recovery"},"Follower failure: Catch-up recovery"),(0,i.kt)("p",null,"\u6bcf\u500b Follower \u5728 disk \u4e0a\u8a18\u9304\u5f9e Leader \u6536\u5230\u7684\u8cc7\u6599\u8b8a\u66f4\u3002\u5982\u679c Follower \u58de\u6389\u91cd\u65b0\u555f\u52d5\u6216\u65b7\u7db2\uff0c\u5247 Follower \u53ef\u4ee5\u5f9e\u65e5\u8a8c\u4e2d\u77e5\u9053\u5728\u767c\u751f\u6545\u969c\u4e4b\u524d\u8655\u7406\u7684\u6700\u5f8c\u4e00\u500bTransaction\u3002\u4e4b\u5f8c Follower \u53ef\u4ee5\u9023\u7dda\u5230 Leader\uff0c\u4e26\u8acb\u6c42\u5728\u58de\u6389\u671f\u9593\u767c\u751f\u7684\u6240\u6709\u8cc7\u6599\u8b8a\u66f4\u3002"),(0,i.kt)("h3",{id:"leader-failure-failover"},"Leader failure: Failover"),(0,i.kt)("p",null,"\u5176\u4e2d\u4e00\u500b Follower \u8981\u88ab promote \u70ba\u65b0\u7684 Leader\uff0c\u9700\u8981\u91cd\u65b0\u914d\u7f6e\u5ba2\u6236\u7aef\uff0c\u4ee5\u5c07\u5b83\u5011\u7684\u5beb\u64cd\u4f5c\u50b3\u9001\u7d66\u65b0\u7684 Leader\uff0c\u5176\u4ed6 Follower \u9700\u8981\u958b\u59cb\u62c9\u53d6\u4f86\u81ea\u65b0 Leader \u7684\u8cc7\u6599\u8b8a\u66f4\u3002\u9019\u500b\u904e\u7a0b\u88ab\u7a31\u70ba failover"),(0,i.kt)("p",null,"failover\u53ef\u4ee5\u624b\u52d5\u6216\u81ea\u52d5\u3002\u81ea\u52d5\u7684failover\u6b65\u9a5f\uff1a"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"\u78ba\u8a8d Leader \u5931\u6548\u3002\u6709\u5f88\u591a\u4e8b\u60c5\u53ef\u80fd\u6703\u51fa\u932f\uff1a\u5d29\u6f70\u3001\u505c\u96fb\u3001\u7db2\u8def\u554f\u984c\u7b49\u7b49\u3002\u6c92\u6709\u842c\u7121\u4e00\u5931\u7684\u65b9\u6cd5\uff0c\u6240\u4ee5\u5927\u591a\u6578\u7cfb\u7d71\u53ea\u662f\u7c21\u55ae\u4f7f\u7528Timeout"),(0,i.kt)("li",{parentName:"ol"},"\u9078\u64c7\u4e00\u500b\u65b0\u7684 Leader \u3002\u9019\u53ef\u4ee5\u900f\u904e\u9078\u8209\u904e\u7a0b\uff08 Leader \u7531\u5269\u9918 Follower \u4ee5\u591a\u6578\u9078\u8209\u7522\u751f\uff09\u4f86\u5b8c\u6210(\u9700\u8981\u5171\u8b58\u6f14\u7b97\u6cd5)\u3002"),(0,i.kt)("li",{parentName:"ol"},"\u91cd\u65b0\u914d\u7f6e\u7cfb\u7d71\u4ee5\u555f\u7528\u65b0\u7684 Leader\u3002\u5ba2\u6236\u7aef\u73fe\u5728\u9700\u8981\u5c07\u5b83\u5011\u7684\u5beb\u8acb\u6c42\u50b3\u9001\u7d66\u65b0 Leader\u3002\u5982\u679c\u820a Leader \u6062\u5fa9\uff0c\u53ef\u80fd\u4ecd\u7136\u8a8d\u70ba\u81ea\u5df1\u662f Leader \uff0c\u800c\u6c92\u6709\u610f\u8b58\u5230\u5176\u4ed6\u526f\u672c\u5df2\u7d93\u8b93\u5b83\u5931\u53bb\u9818\u5c0e\u6b0a\u4e86\u3002\u7cfb\u7d71\u9700\u8981\u78ba\u4fdd\u820a Leader \u610f\u8b58\u5230\u65b0 Leader \u7684\u5b58\u5728\uff0c\u4f75\u6210\u70ba\u4e00\u500b Follower \u3002")),(0,i.kt)("p",null,"\u6545\u969c\u5207\u63db\u7684\u904e\u7a0b\u4e2d\u6709\u5f88\u591a\u5730\u65b9\u53ef\u80fd\u51fa\u932f\uff1a"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u65b0 Leader \u6c92\u6709\u6536\u5230\u8001 Leader \u639b\u6389\u524d\u6700\u5f8c\u7684\u5beb\u5165\u64cd\u4f5c\u3002"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u8cc7\u6599\u5eab\u9700\u8981\u548c\u5176\u4ed6\u5916\u90e8\u5132\u5b58\u76f8\u5354\u8abf\uff0c\u90a3\u9ebc\u4e1f\u68c4\u5beb\u5165\u5167\u5bb9\u662f\u6975\u5176\u5371\u96aa\u7684\u64cd\u4f5c\u3002 Example: \u4f8b\u5982\u5728 GitHub \u7684\u4e00\u5834\u4e8b\u6545\u4e2d\uff0c\u4e00\u500b\u904e\u6642\u7684 MySQL Follower \u88ab\u63d0\u5347\u70baLeader\u3002\u8cc7\u6599\u5eab\u4f7f\u7528\u81ea\u589e ID \u4f5c\u70baPrimary\uff0c\u56e0\u70ba\u65b0Leader\u7684\u8a08\u6578\u5668\u843d\u5f8c\u65bc\u8001Leader\u7684\u8a08\u6578\u5668\uff0c\u6240\u4ee5\u65b0Leader\u91cd\u65b0\u5206\u914d\u4e86\u4e00\u4e9b\u5df2\u7d93\u88ab\u8001Leader\u5206\u914d\u6389\u7684 ID \u4f5c\u70ba\u4e3b\u9375\u3002\u9019\u4e9b\u4e3b\u9375\u4e5f\u5728 Redis \u4e2d\u4f7f\u7528\uff0c\u4e3b\u9375\u91cd\u7528\u4f7f\u5f97 MySQL \u548c Redis \u4e2d\u7684\u8cc7\u6599\u7522\u751f\u4e0d\u4e00\u81f4\uff0c\u6700\u5f8c\u5c0e\u81f4\u4e00\u4e9b\u79c1\u6709\u8cc7\u6599\u6d29\u6f0f\u5230\u932f\u8aa4\u7684\u4f7f\u7528\u8005\u624b\u4e2d\u3002"),(0,i.kt)("li",{parentName:"ul"},"Split brain"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u4f55\u77e5\u9053 Leader \u662f\u771f\u7684\u639b\u6389\u4e86\uff0c\u5982\u679c\u53ea\u662fSpike\uff0c\u53cd\u800c\u6703\u52a0\u91cd\u8ca0\u64d4")),(0,i.kt)("h3",{id:"implementation-of-replication-logs"},"Implementation of Replication Logs"),(0,i.kt)("h4",{id:"-statement-based-replication"},"\ud83d\udc4e Statement-based replication"),(0,i.kt)("p",null,"\u8907\u88fd\u6bcf\u500b statement \u5230 follower \u57f7\u884c\uff0c\u50cf SQL statement\uff0c\u4f46\u662f\u5f88\u591a\u60c5\u6cc1\u6703\u5c0e\u81f4 replication \u58de\u6389"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"nondeterministic function, such as NOW() or RAND() is likely to generate a different value on each replica."),(0,i.kt)("li",{parentName:"ol"},"If statements depend on the existing data in the database (e.g., UPDATE ... WHERE ...),  must be executed in exactly the same order on each replica"),(0,i.kt)("li",{parentName:"ol"},"side effects (e.g., triggers, stored procedures, user-defined functions)")),(0,i.kt)("h4",{id:"-write-ahead-log-wal-shipping"},"\ud83d\udc4e Write-ahead log (WAL) shipping"),(0,i.kt)("p",null,"usually every write to a database is appended to a log"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"In SSTables and LSM-Trees, WAL is the main place for storage. Log segments are compacted in the background."),(0,i.kt)("li",{parentName:"ul"},"In B-tree, every modification is first written to a WAL so that the index can be restored to a consistent state after a crash.")),(0,i.kt)("p",null,"\u597d\u8655\uff1aWAL \u5305\u542b\u4e86\u6240\u6709\u8cc7\u6599\u5eab\u5beb\u5165\u7684append-only sequence of bytes\u3002\u53ef\u4ee5\u4f7f\u7528\u5b8c\u5168\u76f8\u540c\u7684\u65e5\u8a8c\u5728\u53e6\u4e00\u500b\u7bc0\u9ede\u4e0a\u69cb\u5efa\u4e00\u6a21\u4e00\u6a23\u7684 replica"),(0,i.kt)("p",null,"\u7f3a\u9ede\uff1a\u975e\u5e38\u5e95\u5c64\uff0c\u7121\u6cd5\u770b\u61c2\uff0c\u8ddfstorage engine\u8026\u5408\uff0c\u63db\u7248\u672c\u6216\u63dbstorage engine\u53ef\u80fd\u6703\u6709downtime"),(0,i.kt)("h4",{id:"-logical-row-based-log-replication"},"\ud83d\udc4d Logical (row-based) log replication"),(0,i.kt)("p",null,"\u4e0d\u7d81\u5b9astorage engine\uff0c\u53ef\u4ee5\u53ea\u5132\u5b58\u4f5creplication\u6240\u9700\u8981\u7684\u5fc5\u8981\u8cc7\u8a0a\uff0c\u4e5f\u9069\u5408\u767c\u7d66\u5916\u90e8\u7cfb\u7d71\u4f5c\u5ba2\u88fd\u5316\u7d22\u5f15\u6216data warehouse\nlogical log  is usually at the granularity of a row:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For an inserted row, the log contains the new values of all columns."),(0,i.kt)("li",{parentName:"ul"},"For a deleted row, the log contains enough information to uniquely identify the\nrow that was deleted. Typically this would be the primary key, but if there is no\nprimary key on the table, the old values of all columns need to be logged."),(0,i.kt)("li",{parentName:"ul"},"For an updated row, the log contains enough information to uniquely identify\nthe updated row, and the new values of all columns (or at least the new values of\nall columns that changed).")),(0,i.kt)("p",null,"Ref:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.postgresql.org/docs/current/logical-replication.html"},"https://www.postgresql.org/docs/current/logical-replication.html")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://dev.mysql.com/doc/refman/8.0/en/replication.html"},"https://dev.mysql.com/doc/refman/8.0/en/replication.html"))),(0,i.kt)("h3",{id:"-trigger-based-replication"},"\ud83d\ude10 Trigger-based replication"),(0,i.kt)("p",null,"\u5ba2\u88fd\u5316\u5de5\u5177\uff0c\u53ea\u9700\u8907\u88fd\u81ea\u5df1\u6307\u5b9a\u7bc4\u570d\u7684\u8cc7\u6599\uff0c\u6216\u8005\u5728\u81ea\u5df1\u60f3\u8981\u7684\u6642\u9593trigger"),(0,i.kt)("p",null,"For Example:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://www.oracle.com/integration/goldengate/"},"Oracle GoldenGate")),(0,i.kt)("li",{parentName:"ul"},"Store procedure"),(0,i.kt)("li",{parentName:"ul"},"triggers")),(0,i.kt)("h2",{id:"problems-with-replication-lag"},"Problems with Replication Lag"),(0,i.kt)("p",null,"Leader-based replication \u9069\u5408\u7528\u5728\u591a\u8b80\u5c11\u5beb\u7684\u60c5\u6cc1\uff0c\u53ef\u4ee5\u5206\u6563\u8b80\u53d6\u7684\u5de5\u4f5c\u8ca0\u8f09\uff0c\u4f46\u5c31\u6703\u9047\u5230\u5fc5\u9808\u4f7f\u7528Async Replication\u6240\u7522\u751f\u7684Lag\u554f\u984c"),(0,i.kt)("p",null,"Term: Eventual consistency"),(0,i.kt)("h3",{id:"read-your-own-writes"},"Read Your Own Writes"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(93809).Z,width:"1114",height:"542"})),(0,i.kt)("p",null,"Read-your-writes (Read-after-write) consistency: \u7576\u4f7f\u7528\u8005\u91cd\u65b0\u8f09\u5165\u9801\u9762\uff0c\u91cd\u65b0\u6574\u7406\u6642\uff0c\u78ba\u4fdd\u4e00\u5b9a\u770b\u5230\u81ea\u5df1\u525b\u525b\u63d0\u4ea4\u7684\u66f4\u65b0\uff0c\u4f46\u4e0d\u4fdd\u8b49\u770b\u5230\u5176\u4ed6\u4f7f\u7528\u8005\u7684\u6700\u65b0\u66f4\u65b0"),(0,i.kt)("h4",{id:"solutions"},"Solutions:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u5982\u679c\u662f\u8b80\u81ea\u5df1\u5beb\u7684\u6771\u897f\uff0c\u5f9e leader \u8b80\uff0c\u5426\u5247\u5f9e follower \u8b80. e.g., twitter, teams"),(0,i.kt)("li",{parentName:"ul"},"\u53ef\u4ee5\u6839\u64da\u7269\u4ef6\u7684last updated time\uff0c\u7136\u5f8c\u518d\u53c3\u8003 follower latency\uff0c\u4f86\u6c7a\u5b9a\u5e7e\u5206\u9418\u4ee5\u5167\u66f4\u65b0\u7684\u8cc7\u6599\u53bb leader \u8b80\u53d6\uff0c"),(0,i.kt)("li",{parentName:"ul"},"\u7d00\u9304\u4f7f\u7528\u8005\u6700\u5f8c\u4e00\u6b21\u57f7\u884c\u5beb\u5165\u7684\u6642\u9593\uff0c\u5982\u679cfollower\u4e0d\u5920\u65b0\uff0c\u5c31\u53bb\u627e\u5176\u4ed6\u53ef\u80fd\u6bd4\u8f03\u65b0\u7684follower\uff0c\u4f46\u9019\u5f88\u4f9d\u9760\u6642\u9593\u540c\u6b65"),(0,i.kt)("li",{parentName:"ul"},"\u5982\u679cReplica\u5728\u4e0d\u540c\u7684data center \u6703\u589e\u52a0\u8907\u96dc\u6027")),(0,i.kt)("p",null,"\u5982\u679c\u662f\u8de8\u88dd\u7f6e\uff0c\u50cf\u96fb\u8166\u8ddf\u624b\u6a5f\u8981\u78ba\u4fdd\u80fd\u5373\u6642\u770b\u5230\u53e6\u4e00\u908a\u7684update\uff0c\u9019\u7a2e\u7684 read-your-writes consistency\u5c31\u6709\u66f4\u591a\u8981\u8003\u616e\u7684\u5730\u65b9"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u7d00\u9304\u4f7f\u7528\u8005timestamp\u4e0d\u53ef\u884c\uff0c\u56e0\u70ba\u88dd\u7f6e\u4e0d\u540c"),(0,i.kt)("li",{parentName:"ul"},"\u7db2\u8def\u4e0d\u540c\uff0c\u8981\u78ba\u4fdd\u9019\u4e9bdevice\u4f7f\u7528\u5230\u540c\u4e00\u500bleader")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Monotonic Read"),"\n",(0,i.kt)("img",{src:a(73749).Z,width:"1102",height:"660"})),(0,i.kt)("p",null,"monotonic reads \u53ef\u4ee5\u4fdd\u8b49\u9019\u7a2e\u7570\u5e38\u4e0d\u6703\u767c\u751f\u3002\u9019\u662f\u4e00\u500b\u6bd4 \u5f37\u4e00\u81f4\u6027\uff08strong consistency\uff09 \u66f4\u5f31\uff0c\u4f46\u6bd4 \u6700\u7d42\u4e00\u81f4\u6027\uff08eventual consistency\uff09 \u66f4\u5f37\u7684\u4fdd\u8b49\u3002\u7576\u8b80\u53d6\u8cc7\u6599\u6642\uff0c\u4f60\u53ef\u80fd\u6703\u770b\u5230\u4e00\u7b87\u820a\u503c\uff1b\u55ae\u8abf\u8b80\u50c5\u610f\u5473\u8457\u5982\u679c\u4e00\u500b\u4f7f\u7528\u8005\u9806\u5e8f\u5730\u9032\u884c\u591a\u6b21\u8b80\u53d6\uff0c\u5247\u4ed6\u5011\u4e0d\u6703\u770b\u5230\u6642\u9593\u56de\u9000\uff0c\u4e5f\u5c31\u662f\u8aaa\uff0c\u5982\u679c\u5df2\u7d93\u8b80\u53d6\u5230\u8f03\u65b0\u7684\u8cc7\u6599\uff0c\u5f8c\u7e8c\u7684\u8b80\u53d6\u4e0d\u6703\u5f97\u5230\u66f4\u820a\u7684\u8cc7\u6599\u3002"),(0,i.kt)("p",null,"\u5be6\u73fe\u65b9\u6cd5\uff1a\u6bcf\u6b21\u540c\u4e00\u500bfollower\u8b80\uff0c\u53ef\u4ee5\u7528hash uid\u4f86\u6307\u5b9afollower"),(0,i.kt)("h3",{id:"consistent-prefix-reads"},"Consistent Prefix Reads"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(35828).Z,width:"1104",height:"796"}),"\nconsistent prefix reads: This guarantee says that if a sequence of writes happens in a certain order,\nthen anyone reading those writes will see them appear in the same order."),(0,i.kt)("p",null,"\u4e00\u7a2e\u89e3\u6c7a\u65b9\u6848\u662f\u4fdd\u8b49\u8cc7\u6599\u90fd\u5beb\u5230\u76f8\u540c\u7684partition\uff0c\u4f46\u53ef\u80fd\u6c92\u6709\u6548\u7387\uff0c\u5f8c\u7e8c\u6709\u4e00\u4e9b\u6f14\u7b97\u6cd5\u8ad6\u8a0e\u8ad6\u95dc\u65bc\u9019\u7a2e\u56e0\u679c\u95dc\u4fc2(causality)\u7684\u554f\u984c"),(0,i.kt)("h3",{id:"solutions-for-replication-lag"},"Solutions for Replication Lag"),(0,i.kt)("p",null,"\u5728\u4f7f\u7528\u6700\u7d42\u4e00\u81f4\u7684\u7cfb\u7d71\u6642\uff0c\u5982\u679c\u8907\u88fd\u5ef6\u9072\u589e\u52a0\u5230\u5e7e\u5206\u9418\u751a\u81f3\u5e7e\u5c0f\u6642\uff0c\u5247\u61c9\u8a72\u8003\u616e\u61c9\u7528\u7a0b\u5f0f\u7684\u884c\u70ba\u3002\u5982\u679c\u7b54\u6848\u662f \u201c\u6c92\u554f\u984c\u201d\uff0c\u90a3\u5f88\u597d\u3002\u4f46\u5982\u679c\u7d50\u679c\u5c0d\u65bc\u4f7f\u7528\u8005\u4f86\u8aaa\u662f\u4e0d\u597d\u7684\u9ad4\u9a57\uff0c\u90a3\u9ebc\u8a2d\u8a08\u7cfb\u7d71\u4f86\u63d0\u4f9b\u66f4\u5f37\u7684\u4fdd\u8b49\u662f\u5f88\u91cd\u8981\u7684\u3002\u660e\u660e\u662f\u975e\u540c\u6b65\u8907\u88fd\u537b\u5047\u8a2d\u8907\u88fd\u662f\u540c\u6b65\u7684\uff0c\u9019\u662f\u5f88\u591a\u9ebb\u7169\u7684\u6839\u6e90\u3002"),(0,i.kt)("p",null,"\u4f46\u5728\u61c9\u7528\u7a0b\u5f0f\u7a0b\u5f0f\u78bc\u4e2d\u8655\u7406\u9019\u4e9b\u554f\u984c\u662f\u8907\u96dc\u7684\uff0c\u5bb9\u6613\u51fa\u932f\u3002"),(0,i.kt)("p",null,"\u5982\u679c\u61c9\u7528\u7a0b\u5f0f\u958b\u767c\u4eba\u54e1\u4e0d\u5fc5\u64d4\u5fc3\u5fae\u5999\u7684\u8907\u88fd\u554f\u984c\uff0c\u4e26\u53ef\u4ee5\u4fe1\u8cf4\u4ed6\u5011\u7684\u8cc7\u6599\u5eab \u201c\u505a\u4e86\u6b63\u78ba\u7684\u4e8b\u60c5\u201d\uff0c\u90a3\u8a72\u591a\u597d\u5440\u3002\u9019\u5c31\u662f transaction \u5b58\u5728\u7684\u539f\u56e0\uff1a\u8cc7\u6599\u5eab\u900f\u904e\u4e8b\u52d9\u63d0\u4f9b\u5f37\u5927\u7684\u4fdd\u8b49\uff0c\u6240\u4ee5\u61c9\u7528\u7a0b\u5f0f\u53ef\u4ee5\u66f4\u52a0\u7c21\u55ae\u3002"),(0,i.kt)("h2",{id:"multi-leader-replication"},"Multi-Leader Replication"),(0,i.kt)("p",null,"Leader-based replication has one major downside: there is only one leader, and all\nwrites must go through it."),(0,i.kt)("p",null,"Multi-leader allow more than one node to accept writes."),(0,i.kt)("p",null,"multi-leader (also known as master\u2013master or active/active replication)."),(0,i.kt)("h3",{id:"use-cases-for-multi-leader-replication"},"Use Cases for Multi-Leader Replication"),(0,i.kt)("p",null,"\u5728\u55ae\u500b\u6578\u64da\u4e2d\u5fc3\u5167\u90e8\u4f7f\u7528\u591a\u500bLeader\u7684\u914d\u7f6e\u6c92\u6709\u592a\u5927\u610f\u7fa9\uff0c\u56e0\u70ba\u5176\u5c0e\u81f4\u7684\u8907\u96dc\u6027\u5df2\u7d93\u8d85\u904e\u4e86\u80fd\u5e36\u4f86\u7684\u597d\u8655\u3002\u4f46\u5728\u4e00\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u9019\u7a2e\u914d\u7f6e\u4e5f\u662f\u5408\u7406\u7684\u3002"),(0,i.kt)("h4",{id:"multi-datacenter-operation"},"Multi-datacenter operation"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(32454).Z,width:"1102",height:"596"}),"\n\u63a5\u4e0b\u4f86\u6bd4\u8f03\u591a\u8cc7\u6599\u4e2d\u5fc3\u60c5\u6cc1\u4e0b\uff0csingle-leader\u8ddfmulti-leader\u7684\u9069\u61c9\u60c5\u6cc1"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null}),(0,i.kt)("th",{parentName:"tr",align:null},"Single-leader"),(0,i.kt)("th",{parentName:"tr",align:null},"Multi-leader"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Performance"),(0,i.kt)("td",{parentName:"tr",align:null},"\u6bcf\u500b\u5beb\u5165\u90fd\u8981\u8de8region\u5beb\u5165\u5230Leader\u6240\u5728\u7684datacenter\uff0c\u9055\u53cd\u4e86\u4f7f\u7528\u591adatacenter\u7684\u76ee\u7684"),(0,i.kt)("td",{parentName:"tr",align:null},"\u76f4\u63a5\u5beb\u5165\u5230\u6700\u8fd1\u7684datacenter\uff0c\u518dreplicate\u5230\u5176\u4ed6datacenter")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Tolerance of datacenter outages"),(0,i.kt)("td",{parentName:"tr",align:null},"Failover \u628a\u5176\u4ed6datacenter\u7684follower\u63d0\u5347\u6210 Leader"),(0,i.kt)("td",{parentName:"tr",align:null},"\u5176\u4ed6datacenter leader\u6b63\u5e38\u57f7\u884c\uff0c\u58de\u6389\u7684datacenter\u5f8c\u4f86\u518dcatch-up")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"Tolerance of network problems"),(0,i.kt)("td",{parentName:"tr",align:null},"\u8de8Datacenter\u7684\u7db2\u8def\u901a\u5e38\u8981\u7d93\u904epublic internet\u6703\u5f88\u4e0d\u7a69\u5b9a"),(0,i.kt)("td",{parentName:"tr",align:null},"\u901a\u5e38\u6703\u6bd4\u8de8datacenter\u50b3\u8f38\u7a69\u5b9a")))),(0,i.kt)("p",null,"\u5404\u8cc7\u6599\u5eab\u591a\u4f7f\u7528\u5916\u90e8\u5de5\u5177\u4f86\u652f\u63f4"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Tungsten Replicator for MySQL"),(0,i.kt)("li",{parentName:"ul"},"BDR for PostgreSQL"),(0,i.kt)("li",{parentName:"ul"},"GoldenGate for Oracle")),(0,i.kt)("p",null,"\u96d6\u7136multi-leader\u6709\u5f88\u591a\u597d\u8655\uff0c\u4f46\u6709\u4e00\u500b\u5927\u7f3a\u9ede\uff1a\u76f8\u540c\u8cc7\u6599\u53ef\u80fd\u5728\u4e0d\u540cdatacenters\u540c\u6642\u88ab\u4fee\u6539\uff0c\u5fc5\u9808\u8981\u89e3conflict\n\u7531\u65bc\u591a\u4e3b\u8907\u88fd\u5728\u8a31\u591a\u8cc7\u6599\u5eab\u4e2d\u90fd\u5c6c\u65bc\u6539\u88dd\u7684\u529f\u80fd\uff0c\u6240\u4ee5\u5e38\u5e38\u5b58\u5728\u5fae\u5999\u7684\u914d\u7f6e\u7f3a\u9677\uff0c\u4e14\u7d93\u5e38\u8207\u5176\u4ed6\u8cc7\u6599\u5eab\u529f\u80fd\u4e4b\u9593\u51fa\u73fe\u610f\u5916\u7684\u53cd\u61c9\u3002\n\u6bd4\u5982"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"autoincrementing keys"),(0,i.kt)("li",{parentName:"ul"},"triggers"),(0,i.kt)("li",{parentName:"ul"},"integrity constraint")),(0,i.kt)("p",null,"\u7b49\u90fd\u53ef\u80fd\u6703\u6709\u9ebb\u7169\u3002\u56e0\u6b64\uff0c\u591a\u4e3b\u8907\u88fd\u5f80\u5f80\u88ab\u8a8d\u70ba\u662f\u5371\u96aa\u7684\u9818\u57df\uff0c\u61c9\u5118\u53ef\u80fd\u907f\u514d"),(0,i.kt)("h4",{id:"clients-with-offline-operation"},"Clients with offline operation"),(0,i.kt)("p",null,"Example: Calendar, notion\n\u6bcf\u500bdevice\u5c31\u50cf\u4e00\u500bdatacenter"),(0,i.kt)("h4",{id:"collaborative-editing"},"Collaborative editing"),(0,i.kt)("p",null,"Example: Google doc, Wiki"),(0,i.kt)("h3",{id:"handling-write-conflicts"},"Handling Write Conflicts"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(34899).Z,width:"1104",height:"544"})),(0,i.kt)("h4",{id:"synchronous-versus-asynchronous-conflict-detection"},"Synchronous versus asynchronous conflict detection"),(0,i.kt)("p",null,"\u57fa\u672c\u4e0a\u4e0d\u53ef\u80fd\u7528sync conflict detection\uff0c\u90a3\u4f60\u4e7e\u8106\u7528single-leader"),(0,i.kt)("h4",{id:"conflict-avoidance"},"Conflict avoidance"),(0,i.kt)("p",null,"\u5982\u679c\u80fd\u4fdd\u8b49\u67d0\u4e9b\u7279\u5b9a\u5beb\u5165\u53ea\u6703\u5230\u540c\u500bLeader\uff0c\u9019\u6a23\u5c31\u6c92\u6709conflict\u4e86\n\u8209\u4f8b\u50cf\u67d0\u4e9b\u5ba2\u6236\u6c38\u9060\u53ea\u5beb\u5165\u7279\u5b9a\u7684Leader\uff0c\u5c0d\u55ae\u4e00\u500b\u5ba2\u6236\u4f86\u8aaa\uff0c\u4ed6\u53ea\u6709single-leader\n\u4f46\u5ba2\u6236\u6709\u53ef\u80fd\u6703\u51fa\u570b\uff0c\u9019\u6642\u5019\u5c31\u6709\u53ef\u80fd\u8981\u63dbdatacenter"),(0,i.kt)("h4",{id:"converging-toward-a-consistent-state"},"Converging toward a consistent state"),(0,i.kt)("p",null,"\u8b93conflict \u6536\u6582\u5230\u4e00\u500b\u503c"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"\u7d66\u6bcf\u500bwrite\u4e00\u500bunique ID (e.g., timestamp, UUID, hash value)\uff0c\u503c\u6bd4\u8f03\u9ad8\u7684\u7372\u52dd\uff0c\u5982\u679c\u4f7f\u7528timestamp\uff0c\u9019\u7a2e\u65b9\u6cd5\u53eb\u505a last write win (LWW)\uff0c\u96d6\u7136LWW\u5f88\u6d41\u884c\uff0c\u4f46\u6709\u53ef\u80fd\u6703\u9020\u6210data loss"),(0,i.kt)("li",{parentName:"ul"},"\u7d66\u6bcf\u500breplica\u4e00\u500bID, \u9ad8\u7684\u8d0f\uff0c\u4e00\u6a23\u6709\u53ef\u80fd\u6709data loss"),(0,i.kt)("li",{parentName:"ul"},"\u628a\u503cmerge\u6216concat\u8d77\u4f86 (e.g., B/C)"),(0,i.kt)("li",{parentName:"ul"},"\u901a\u901a\u5beb\u9032\u53bb\uff0c\u8b80\u51fa\u4f86\u7684\u6642\u5019\u8b93user\u505a\u9078\u64c7")),(0,i.kt)("h4",{id:"custom-conflict-resolution-logic"},"Custom conflict resolution logic"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"On Write: \u5075\u6e2c\u5230conflict\uff0ctrigger conflict handler\uff0c\u8b93\u7528\u6236\u81ea\u5df1\u5beb\u908f\u8f2f\u53bb\u89e3 (e.g., ",(0,i.kt)("a",{parentName:"li",href:"https://bucardo.org/Bucardo/operations/conflict_handling"},"Bucardo"),")"),(0,i.kt)("li",{parentName:"ul"},"On Read: all the conflicting writes are stored. When the data is read, app resolve the conflict, and write the result back to the database. CouchDB works this way.")),(0,i.kt)("h4",{id:"automatic-conflict-resolution"},"Automatic Conflict Resolution"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Conflict-free replicated datatypes (CRDTs)",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://zh.wikipedia.org/zh-tw/%E6%97%A0%E5%86%B2%E7%AA%81%E5%A4%8D%E5%88%B6%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"},"https://zh.wikipedia.org/zh-tw/%E6%97%A0%E5%86%B2%E7%AA%81%E5%A4%8D%E5%88%B6%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://redis.io/active-active/"},"https://redis.io/active-active/")))),(0,i.kt)("li",{parentName:"ul"},"Mergeable persistent data structures"),(0,i.kt)("li",{parentName:"ul"},"Operational transformation",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Operational_transformation"},"https://en.wikipedia.org/wiki/Operational_transformation"))))),(0,i.kt)("p",null,"\u4ec0\u9ebc\u662fconflict\u9019\u4ef6\u4e8b\u6703\u5728Transaction\u90a3\u5f35\u6df1\u523b\u8a0e\u8ad6"),(0,i.kt)("h3",{id:"multi-leader-replication-topologies"},"Multi-Leader Replication Topologies"),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(84535).Z,width:"1104",height:"376"}),"\nThe most general topology is all-to-all.\nMySQL by default supports only a circular topology\n",(0,i.kt)("img",{src:a(6903).Z,width:"1106",height:"714"}),"\nproblem of causality"),(0,i.kt)("p",null,"conflict detection techniques are poorly implemented in many multi-leader\nreplication systems. For example, PostgreSQL BDR does not\nprovide causal ordering of writes, and Tungsten Replicator for MySQL doesn\u2019t\neven try to detect conflicts ","[34]","."),(0,i.kt)("p",null,"If you are using a system with multi-leader replication, it is worth being aware of\nthese issues, carefully reading the documentation, and thoroughly testing your database\nto ensure that it really does provide the guarantees you believe it to have."))}d.isMDXComponent=!0},26665:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-1-combine-partition-and-replication-8c142d49bc23362230859996328fb9cd.png"},84535:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-10-topology-7a0187f0bcf726fd9e69c27e8dfd032a.jpg"},6903:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-11-wrong-order-arrive-26d40fb44b68434ec82e921c0ba6d4d3.jpg"},16211:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-2-ch5-7a9232a9b9fe741836c5f7b212f02e9c.jpg"},13196:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-3-leader-based-replication-4dfc89caadd89f8be2800015eccba2e1.jpg"},11634:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-4-sync-versus-async-follower-2cc0f2137c4981f53cbc92a8a449e2b5.jpg"},93809:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-5-write-but-read-nothing-33c88ccb0b133045f329a9822b1314f9.jpg"},73749:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-6-time-go-backward-4867763ad3407dac97f40605b12e16d3.jpg"},35828:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-7-see-the-future-1d14a50206dd7bedb1e3ba24f0054cff.jpg"},32454:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-8-multi-leader-52a90b584cbdb2766d087faeb81aa70a.jpg"},34899:(e,t,a)=>{a.d(t,{Z:()=>l});const l=a.p+"assets/images/5-9-write-conflict-2944fc788bb4e7790fce1d8fdcbcb699.jpg"}}]);