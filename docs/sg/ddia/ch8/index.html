<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-sg/ddia/ch8">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Ch8: 分散式系統的問題 | Noob Tech Note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://noobtechnote.github.io/docs/sg/ddia/ch8"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ch8: 分散式系統的問題 | Noob Tech Note"><meta data-rh="true" name="description" content="* 「任何可能出錯的事都必然將出錯」- 墨菲定律"><meta data-rh="true" property="og:description" content="* 「任何可能出錯的事都必然將出錯」- 墨菲定律"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://noobtechnote.github.io/docs/sg/ddia/ch8"><link data-rh="true" rel="alternate" href="https://noobtechnote.github.io/docs/sg/ddia/ch8" hreflang="en"><link data-rh="true" rel="alternate" href="https://noobtechnote.github.io/docs/sg/ddia/ch8" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.40771ce4.css">
<link rel="preload" href="/assets/js/runtime~main.20c108ea.js" as="script">
<link rel="preload" href="/assets/js/main.2d5dd4a1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon-144.png" alt="Noob Tech Note" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/icon-144.png" alt="Noob Tech Note" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Noob Tech Note</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/sg">Study Group</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/sg/">Study Group Notes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Study Group Notes&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/clean-architecture/">Clean Architecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Clean Architecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/sg/ddia/ch1">資料密集型應用系統設計</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch1">Ch1: 可靠、可擴展與可維護的系統</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch3">Ch3: 儲存與索引</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch4">Ch4: 資料編碼與演化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch5">Ch5: 分散式資料系統</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch5-leaderless">Ch5: 複製:無主複製</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch6">Ch6: 分區</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch7">Ch7: 交易</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/sg/ddia/ch8">Ch8: 分散式系統的問題</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch10">Ch10: 批次處理</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/fenix-architecture/">鳳凰架構</a><button aria-label="Toggle the collapsible sidebar category &#x27;鳳凰架構&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/five-lines-of-code/">五行程式碼規則</a><button aria-label="Toggle the collapsible sidebar category &#x27;五行程式碼規則&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/fundamentals-of-software-architecture/">軟體架構原理 - 工程方法</a><button aria-label="Toggle the collapsible sidebar category &#x27;軟體架構原理 - 工程方法&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/web-api-the-good-parts/">Web API: The Good Parts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web API: The Good Parts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/sg/"><span itemprop="name">Study Group Notes</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">資料密集型應用系統設計</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Ch8: 分散式系統的問題</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ch8: 分散式系統的問題</h1></header><ul><li>「任何可能出錯的事都必然將出錯」- 墨菲定律</li><li>系統維運人員必須要做最悲觀的假設<ul><li>SRE: Hope is not a strategy</li></ul></li><li>為了打造具有韌性的系統，了解「面臨的挑戰是什麼」是重要的</li><li>本章會以「最悲觀的方式」描述分散式系統可能出現的問題</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hpc--cloud-computing">HPC &amp; Cloud Computing<a href="#hpc--cloud-computing" class="hash-link" aria-label="Direct link to HPC &amp; Cloud Computing" title="Direct link to HPC &amp; Cloud Computing">​</a></h2><table><thead><tr><th></th><th>HPC</th><th>Cloud Computing</th></tr></thead><tbody><tr><td>Example</td><td>天氣預報、科學計算、ML</td><td>商用系統、多租戶資料中心、Web Service</td></tr><tr><td>任務特性</td><td>批次處理、可停止和重新啟動</td><td>低延遲服務</td></tr><tr><td>硬體特性</td><td>專用硬體。遠端直接記憶體存取 (RDMA)</td><td>商用機器，依靠規模經濟，以更低的成本提供同等性能</td></tr><tr><td>網路</td><td>IP &amp; Ethernet，<a href="https://en.wikipedia.org/wiki/Clos_network" target="_blank" rel="noopener noreferrer">Clos Network</a>，專用的拓樸，提供更好的性能</td><td>通用的網路架構，IP, TCP, UDP</td></tr><tr><td>單點失敗處理策略</td><td>將錯誤上報，視為整體失效</td><td>容忍失敗節點，保持整體能繼續工作</td></tr><tr><td>地理部署</td><td>假設是緊密連結的</td><td>不一定在相同地理位置，可能透過Internet連接</td></tr></tbody></table><ul><li>部署規模越大，單點故障的機會就越高。隨著時間推移，HPC最終可能會因為要從錯誤中回復而花費大量時間，而無法執行預期的工作。</li><li>想要讓分散式系統好好工作，需要考慮局部失敗的可能性，做出容錯的系統<ul><li>必須要用「不可靠的元件」搭建出「可靠的系統」</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="不可靠的網路">不可靠的網路<a href="#不可靠的網路" class="hash-link" aria-label="Direct link to 不可靠的網路" title="Direct link to 不可靠的網路">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="同步網路與非同步網路">同步網路與非同步網路<a href="#同步網路與非同步網路" class="hash-link" aria-label="Direct link to 同步網路與非同步網路" title="Direct link to 同步網路與非同步網路">​</a></h3><table><thead><tr><th></th><th>同步網路</th><th>非同步網路</th></tr></thead><tbody><tr><td>Example</td><td>傳統有線電話ISDN</td><td>大部分資料中心的網路</td></tr><tr><td>延遲</td><td>有限的</td><td>有可能是無限的</td></tr><tr><td>訊息遞送保證</td><td>保證，若未遞送成功會立刻知道</td><td>不保證訊息何時會到達目標節點，唯一的保證方法是讓接收方回覆一條回應訊息</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="非同步網路的不可靠性">非同步網路的不可靠性<a href="#非同步網路的不可靠性" class="hash-link" aria-label="Direct link to 非同步網路的不可靠性" title="Direct link to 非同步網路的不可靠性">​</a></h3><p><img loading="lazy" alt="data lost" src="/assets/images/fig8_1-07e15758b17fa99825de2aba98ddb0da.png" width="1122" height="374" class="img_ev3q"></p><p style="text-align:center;width:100%;margin-top:-1.8em">當沒有收到接收方的回應，無法區分是因為a, b, c哪種原因導致資料丟失</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="現實中的網路故障">現實中的網路故障<a href="#現實中的網路故障" class="hash-link" aria-label="Direct link to 現實中的網路故障" title="Direct link to 現實中的網路故障">​</a></h3><ul><li>自營運的資料中心，每個月大約會有12起網路相關的故障發生<ul><li>單機斷網和整個機架斷網各半</li></ul></li><li>人為失誤是網路中斷的主要原因 - 無法透過增加冗餘避免</li><li>ECU因為經常出現短暫的網路故障而臭名昭彰<ul><li><a href="https://queue.acm.org/detail.cfm?id=2655736" target="_blank" rel="noopener noreferrer">The Network is Reliable - An informal survey of real-world communications failures</a><ul><li><code>The outages occurred &quot;2 to 4 times a day.&quot;</code></li></ul></li></ul></li><li>交換機的軟體升級期間，可能會觸發網路拓樸的重構</li><li>海底電纜會斷掉</li><li>NIC可能因故障，而只有單向工作正常；網路鏈路可以單向工作，並不保證它在另一個方向工作正常</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="檢測故障">檢測故障<a href="#檢測故障" class="hash-link" aria-label="Direct link to 檢測故障" title="Direct link to 檢測故障">​</a></h3><ul><li>(書中本小節例子是以TCP/IP為例)</li></ul><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Origin Discussion</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Discuss with OSI Layers</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><ol><li>若能觸及目標機器，但機器上沒有process在監聽目標通訊埠，作業系統會發送RST或FIN封包做為回應並關閉或拒絕TCP連線。</li><li>如果一個節點的process崩潰，但該節點的作業系統還在運作中，可以主動通知其他節點以提升接管的速度。這是HBase採用的做法。</li><li>如果能存取目標機器所在的機房網路交換機，可以用來檢測硬體故障，例如發現機器關閉</li><li>路由器若認為目標IP位址是不可達的，可能會回覆一個ICMP Destination Unreachable</li></ol></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><ol><li>Layer 3有通，但Layer 4找不到dest port。TCP server送RST給client復位</li><li>Application崩潰，藉由另一個監看的Application對叢集內的其他節點送出接管命令</li><li>如果能存取目標機器所在的機房網路交換機，可以用Layer 2 fram檢測目標機器是否通電</li><li>Layer 3 router若認為目標IP位址是不可達的，透過同在Layer 3的ICMP通知發送端Destination Unreachable</li></ol></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="合理的timeout">合理的Timeout<a href="#合理的timeout" class="hash-link" aria-label="Direct link to 合理的Timeout" title="Direct link to 合理的Timeout">​</a></h3><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Discussion</div><div class="admonitionContent_S0QG"><p>如果逾時是檢測故障唯一可靠的方法，那麼逾時時間要多久才對？</p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Discussion</div><div class="admonitionContent_S0QG"><ul><li>Timeout發生了，對方真的出錯了嗎？</li><li>依靠Timeout確認目標節點是否存活，會有什麼問題？</li></ul></div></div><ul><li>d = 傳送接收端之間的「最大延遲」</li><li>r = 接收端處理請求，直到開始發送回應的時間</li><li><strong>timout = 2d + r</strong></li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>Discussion</div><div class="admonitionContent_S0QG"><p>Web application的重要效能指標TTFB (Time to first byte)，在上述代號中應該如何表示？</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="網路擁塞和queue">網路擁塞和Queue<a href="#網路擁塞和queue" class="hash-link" aria-label="Direct link to 網路擁塞和Queue" title="Direct link to 網路擁塞和Queue">​</a></h3><ul><li>如果不同的節點嘗試向同一個目標發送封包(Package)，網路交換器(Switch)必須將資料封包放在佇列中等待<ul><li>如果輸入資料太多，Queue被填滿，資料就會被丟棄，因此需要重新傳送。</li></ul></li><li>封包到達目標機器後，若所有CPU都處於忙碌狀態，也可能導致其被處理的時間延後，而導致不確定性。</li><li>在虛擬環境中，當其他VM要存取CPU資源時，可能會導致數十ms的延遲。<ul><li>在此期間Child OS會無法存取任何CPU資源而導致延遲。</li><li>虛擬機器監視器會需要把傳入VM的資料先放進Queue緩衝，進一步加劇了網路延遲的變化性</li></ul></li><li>TCP flow control，為了避免擁塞或背壓，會限制自己的發送速率，避免讓網路連結或接收節點發生超載。<ul><li>不只是接收端有Queue，發送端也有Queue</li></ul></li></ul><p><img loading="lazy" alt="Switching" src="/assets/images/fig8_2-dda5c2ed6b429d81b3b0e320b0938fa2.png" width="1122" height="444" class="img_ev3q"></p><p style="text-align:center;width:100%;margin-top:-1.8em">Port3若來不及消化queue中的訊息，可能會導致觸發重傳</p><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>L2 &amp; L3 Switch</div><div class="admonitionContent_S0QG"><p>傳統中，Switch是工作在Layer 2的網路設備。會看得懂訊框(Frame)，但不會理會封包(Package) header。</p><p>因運算能力的進步，今天大部分的Switch都是Layer 3 switch，會依照Layer 3的IP Header編制in-switch的destiation table，因此才會有Switch將Package放在Queue中等待的說法</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="不能簡單地讓網路延遲可預測就好嗎">不能簡單地讓網路延遲可預測就好嗎？<a href="#不能簡單地讓網路延遲可預測就好嗎" class="hash-link" aria-label="Direct link to 不能簡單地讓網路延遲可預測就好嗎？" title="Direct link to 不能簡單地讓網路延遲可預測就好嗎？">​</a></h3><ul><li>因物理頻寬有限，而通信需求無限。在通訊底層設計的策略不同而有不同的通訊協定類型</li><li>網路中的「可變延遲」並不是自然規律，而是成本與獲利之間<strong>權衡</strong>下來的結果</li></ul><table><thead><tr><th></th><th>迴路切換式網路</th><th>封包切換式網路</th></tr></thead><tbody><tr><td></td><td>Circuit-switched networks</td><td>Packet-switched protocols</td></tr><tr><td>頻寬利用策略</td><td>固定數量的預留頻帶，當迴路建立時會是專用的</td><td>沒有迴路能獨佔所有頻寬，封包會盡可能利用任何可利用的頻寬</td></tr><tr><td>頻道劃分</td><td>迴路</td><td>虛擬的，由協定額外實現</td></tr><tr><td>頻寬保證</td><td>可提供</td><td>無法提供</td></tr><tr><td>突發流量的支援</td><td>無法支援，每個頻道所擁有的頻寬是固定的</td><td>支援</td></tr><tr><td>Example</td><td>PSTN</td><td>Internet Protocol; IP</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="不可靠的時鐘">不可靠的時鐘<a href="#不可靠的時鐘" class="hash-link" aria-label="Direct link to 不可靠的時鐘" title="Direct link to 不可靠的時鐘">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="生活時鐘-time-of-day-clock">生活時鐘 Time-of-day clock<a href="#生活時鐘-time-of-day-clock" class="hash-link" aria-label="Direct link to 生活時鐘 Time-of-day clock" title="Direct link to 生活時鐘 Time-of-day clock">​</a></h3><ul><li>直觀上的時間，表示一台機器上的時間戳記</li><li>通常與NTP同步 - 從另一台機器上將時間同步過來<ul><li>不一定向前走，<strong>有可能退後</strong></li></ul></li><li>Example:<!-- --> <span>2024-06-12T03:18:30.038Z</span></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="單調時鐘-monotonic-clock">單調時鐘 Monotonic clock<a href="#單調時鐘-monotonic-clock" class="hash-link" aria-label="Direct link to 單調時鐘 Monotonic clock" title="Direct link to 單調時鐘 Monotonic clock">​</a></h3><ul><li>用來測量時間間隔<ul><li>透過檢查時間戳記的「差值」來得知經過多少時間</li></ul></li><li><strong>總是保證向前移動</strong><ul><li>但是在多CPU的系統中，作業系統可能會對不同的CPU維護單獨的單調時鐘</li><li>讓這個向前移動的「保證」只在單一執行緒中發生</li><li>明智的做法仍須保持謹慎</li></ul></li><li>NTP也有能力調整單調時鐘<ul><li>如果檢測到本地的石英時鐘筆NTP Server更快或慢，可以做時鐘調速 (Slewing the clock)</li><li>可以加速、減慢，但無法對單調時鐘往前跳躍</li><li>一般來說，單調時鐘維護在本地機器，不需要同步</li></ul></li><li>Example: 開機到目前的秒數</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="同步與精準度不可靠的時鐘">同步與精準度，不可靠的時鐘<a href="#同步與精準度不可靠的時鐘" class="hash-link" aria-label="Direct link to 同步與精準度，不可靠的時鐘" title="Direct link to 同步與精準度，不可靠的時鐘">​</a></h3><ul><li>電腦的石英鐘不是很準確，可能受到溫度而變化<ul><li>Google的Server假設石英鐘的飄移為 200ppm (百萬分之一秒)</li><li>每30秒與伺服器同步一次，時鐘飄移可能會達到6ms</li><li>每天與伺服器同步一次，時鐘飄移可以達到17s</li></ul></li><li>如果電腦的時間與NTP server差異過大，可能會拒絕同步<ul><li>導致程式看到的時間向前或向後跳躍</li></ul></li><li>如果與NTP Server之間的網路被意外隔離開來<ul><li>時間同步會失效</li><li>當下不會有問題而不容易被注意到，但最終會導致不可預期的嚴重問題</li></ul></li><li>NTP也受限於網路延遲<ul><li>NTP的設計，假設了網路延遲的差異不會有太過劇烈的變化</li><li>從Internet進行NTP同步，最小誤差可以達到35ms；偶爾的延遲放大會導致超過1s的誤差</li></ul></li><li>NTP Server的配置錯誤<ul><li>NTP client都聽信server的時間</li><li>你怎麼知道你「聽信的」NTP Server是可信的？</li></ul></li><li>閏秒<ul><li>一分鐘有可能是59秒或61秒<ul><li>地球自轉速度不是固定的</li><li>天文時鐘與原子時鐘的誤差</li></ul></li><li>打亂程式的計時假設</li><li>閏秒的調整最好的方式，是讓NTP Server說謊<ul><li>將這個秒差，分散在一段長時間(例如，一天)逐步地調整</li><li>稱為彌平 Smearing</li></ul></li></ul></li><li>虛擬的時鐘<ul><li>在虛擬機器中，其硬體時鐘也是被「虛擬化」出來的</li><li>CPU核心在VM之間共享時，有可能導致數十毫秒的暫停</li></ul></li><li>不可控的終端設備<ul><li>設備的硬體時鐘可能根本就不能被信任</li><li>Candy Crush遊戲，30分鐘補一顆愛心<ul><li><a href="https://forum.gamer.com.tw/C.php?bsn=23846&amp;snA=47" target="_blank" rel="noopener noreferrer">愛心要等四萬多分鐘！</a></li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="提升時鐘的精度與其困難之處">提升時鐘的精度，與其困難之處<a href="#提升時鐘的精度與其困難之處" class="hash-link" aria-label="Direct link to 提升時鐘的精度，與其困難之處" title="Direct link to 提升時鐘的精度，與其困難之處">​</a></h3><p>要精確地同步時鐘，可以非常複雜跟困難，但發揮鈔能力，投資大量的資源來關心你的時鐘就有可能</p><ul><li>針對金融機構的MiFID II，針對歐洲監管草案要求高頻交易基金，必須將其時鐘同步到UTC 100微秒內</li><li>高精度的GPS接收器，透過PTP進行時間同步<ul><li>PTP可以達到ns等級的精度</li></ul></li><li><a href="https://engineering.fb.com/2022/11/21/production-engineering/precision-time-protocol-at-meta/" target="_blank" rel="noopener noreferrer">How PTP is being deployed at Meta</a></li><li>航海家一號<ul><li>配備兩個石英時鐘，一個作為備用使用</li><li>定期與地球的深空網路(DSN)同步時間<ul><li>Latency仍是可控的：2d+r</li></ul></li><li>但因為時間是相對的...<ul><li>假設航海家一號速度一直維持在3.595 AU/Year</li><li>狹義相對論：時間膨脹，相對於一個慣性系統移動的時鐘都會走得比較慢<ul><li>2024年時，會比地球上的時鐘慢<a href="https://www.wolframalpha.com/input?i=%2847+years%29%281-1%2Fsqrt%281-%283.595+AU+per+year%29%5E2%2Fc%5E2%29%29" target="_blank" rel="noopener noreferrer">2.398秒</a></li></ul></li><li>廣義相對論：重力時間膨脹，重力導致時空的扭曲率越大，時間就過得越慢<ul><li>2024年時，會比地球上的時鐘快<a href="https://www.wolframalpha.com/input?i=%2847+years%29*%28%281+-+2*G*%28mass+of+sun%29%2F%28%281+AU%29*c%5E2%29%29%5E0.5-%281+-+2*G*%28mass+of+sun%29%2F%28%28125+AU%29*c%5E2%29%29%5E0.5%29" target="_blank" rel="noopener noreferrer">14.5秒</a></li></ul></li><li><a href="https://www.quora.com/Is-the-time-set-on-the-Voyager-2-still-the-same-as-the-time-on-Earth" target="_blank" rel="noopener noreferrer">(參考出處)</a></li></ul></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="依靠時鐘的問題---事件排序的時間戳記">依靠時鐘的問題 - 事件排序的時間戳記<a href="#依靠時鐘的問題---事件排序的時間戳記" class="hash-link" aria-label="Direct link to 依靠時鐘的問題 - 事件排序的時間戳記" title="Direct link to 依靠時鐘的問題 - 事件排序的時間戳記">​</a></h3><ul><li>Multiple-leader的衝突解決策略Last write wins; LWW<ul><li>在時鐘不同步的狀況下，對資料庫的寫入會神秘的消失</li></ul></li><li><a href="/docs/sg/ddia/ch5#multi-leader-replication-topologies">Ch5, Figure 5.9</a> 中，如果Client B的寫入實際上晚於Client A的寫入，但Client B的時間戳記卻比較早，會導致Client B的遞增操作錯誤地丟失</li><li>需要透過「可線性化的暫存器」來解決這個問題<ul><li>相信順序，而不是相信時鐘</li><li>Ch12會進行做法的討論</li></ul></li></ul><p><img loading="lazy" alt="Figure 5.9" src="/assets/images/5-11-wrong-order-arrive-26d40fb44b68434ec82e921c0ba6d4d3.jpg" width="1106" height="714" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="依靠時鐘的問題---全域快照的同步時鐘">依靠時鐘的問題 - 全域快照的同步時鐘<a href="#依靠時鐘的問題---全域快照的同步時鐘" class="hash-link" aria-label="Direct link to 依靠時鐘的問題 - 全域快照的同步時鐘" title="Direct link to 依靠時鐘的問題 - 全域快照的同步時鐘">​</a></h3><ul><li><a href="/docs/sg/ddia/ch7#%E5%BF%AB%E7%85%A7%E9%9A%94%E9%9B%A2%E5%92%8C%E5%8F%AF%E9%87%8D%E8%A4%87%E8%AE%80%E5%8F%96-snapshot-isolation-and-repeatable-read">Ch7 快照隔離和可重複讀取</a>，依靠一個單調遞增的交易ID<ul><li>當資料庫分散在許多機器上，就很難產生一個全域的，單調遞增的ID</li></ul></li><li>Google的Spanner<ul><li>在每個資料中心都部署了GPS接收器或原子鐘</li><li>將時鐘同步的誤差減少至7ms以內</li></ul></li></ul><p><img loading="lazy" alt="Figure 7.6" src="/assets/images/fig7_6-545a0cb7daefe3f4f71fa86f004d93ea.png" width="1762" height="932" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="依靠時鐘的問題---程序暫停">依靠時鐘的問題 - 程序暫停<a href="#依靠時鐘的問題---程序暫停" class="hash-link" aria-label="Direct link to 依靠時鐘的問題 - 程序暫停" title="Direct link to 依靠時鐘的問題 - 程序暫停">​</a></h3><ul><li>假設有一個分散式資料庫：<ul><li>每個分區只有一個Leader</li><li>只有Leader可以接收寫入請求，但節點如何知道目前自己仍是Leader，並且可以安全地接受寫入請求？</li></ul></li></ul><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv codeBlockLinesWithNumbering_o6Pm"><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  request </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getIncomingRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 只有一個節點能持有租約：一個帶有timeout的lock</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 若我目前持有租約，而且有效時間還有低於10sec，要先做renew</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lease</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">expiryTimeMillis </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> System</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">currentTimeMillis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    lease </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lease</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">renew</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain" style="display:inline-block"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 租約至少還有10秒以上，檢查租約是否合法</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lease</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isValid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">    </span><span class="token function" style="color:#d73a49">process</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 我目前仍是leader，進行寫入操作</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><br></span><span class="token-line codeLine_lJS_" style="color:#393A34"><span class="codeLineNumber_Tfdd"></span><span class="codeLineContent_feaV"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>Line 5: 到期時間 <code>lease.expiryTimeMillis</code> 有可能是由其他台機器所設定的，對節點間的時間同步做了假設</li><li>Line 5 <code>System.currentTimeMillis()</code> 到 Line 11 <code>process(request)</code> 之間經過的時間不能超過10s<ul><li>如果剛好直譯器在進行GC</li><li>虛擬機器被suspended</li><li>筆電的蓋子被蓋起來</li><li>OS進行content-switch將資源切換至其他的process</li><li>VM Hypervisor，將資源切換到另一個VM</li><li>執行很慢的同步存取，例如I/O操作</li><li>發生<a href="https://zh.wikipedia.org/zh-tw/%E9%A1%B5%E7%BC%BA%E5%A4%B1" target="_blank" rel="noopener noreferrer">分頁錯誤</a>，從虛擬記憶體(硬碟)中載入page到memory中</li><li>收到SIGSTOP (Ctrl+Z)而被暫停</li></ul></li><li>在同一台機器上，有很多工具可以確保thread safe：互斥鎖、號誌、原子計數器、無鎖資料結構、阻塞佇列。但都這些工具都無法在分散式系統中使用</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="對策回應時間保證">對策：回應時間保證<a href="#對策回應時間保證" class="hash-link" aria-label="Direct link to 對策：回應時間保證" title="Direct link to 對策：回應時間保證">​</a></h3><ul><li>有些使用情境，如果不能在時間內做出回應，會造成嚴重的後果。<ul><li>稱為「硬即時系統」 (Hard real-time system) 。</li><li>例如：安全氣囊。</li></ul></li><li>提供即時保證，需要軟體各層級的堆疊。<ul><li>RTOS，允許Process在指定的時間間隔內獲得CPU的時間分配。</li><li>需要大量的額外工作，而且會嚴重限制可用的程式語言、函式庫、和工具範圍。</li></ul></li><li>在伺服器端的資料處理系統，因為經濟上，或其他考量，必須忍受在非即時環境中運作，帶來的暫停和時鐘不穩定性。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="時鐘的知識真相與謊言">時鐘的知識、真相與謊言<a href="#時鐘的知識真相與謊言" class="hash-link" aria-label="Direct link to 時鐘的知識、真相與謊言" title="Direct link to 時鐘的知識、真相與謊言">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="真相由多數說了算">真相由多數說了算<a href="#真相由多數說了算" class="hash-link" aria-label="Direct link to 真相由多數說了算" title="Direct link to 真相由多數說了算">​</a></h3><ul><li>你覺得自己活著不一定算數，得「大部分的人」「覺得你活著」<ul><li>身為Cluster Leader，發出的訊息沒有被其他節點收到，Timout發生後，其他節點宣告原有的Leader失效</li><li>半斷開的原Leader被拖到墓地，尖叫著我沒死，但送葬隊伍以堅忍的決心繼續進行</li></ul></li></ul><p><img loading="lazy" alt="Figure 8.4" src="/assets/images/fig8_4-cfd454d971061b74e8530cd0c4f88c9f.png" width="1124" height="436" class="img_ev3q"></p><p style="text-align:center;width:100%;margin-top:-1.8em">不正確的分散式鎖實作，Client 1認為它仍是有效的租約，但其實已經過期了。因而損壞了Storage的資料</p><p><img loading="lazy" alt="Figure 8.5" src="/assets/images/fig8_5-b13cfdd0535ef8372cce172084cb9139.png" width="1122" height="436" class="img_ev3q"></p><p style="text-align:center;width:100%;margin-top:-1.8em">只允許遞增的fencing token循序寫入，藉以保證安全的存取<br>在Storage要能發現，並阻止Client 1的token過期；使用遞增鍵可以避免Lock Service與Storage之間額外的資料同步要求</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="拜占庭故障">拜占庭故障<a href="#拜占庭故障" class="hash-link" aria-label="Direct link to 拜占庭故障" title="Direct link to 拜占庭故障">​</a></h3><ul><li>基本上我們目前設計的系統，都是假設節點「不可靠」但都是「誠實的」<ul><li>沒有說謊的風險</li></ul></li><li>但是有些情況下是有理由這麼考慮的<ul><li>太空船的電腦系統遭受輻射破壞，導致以不預期的方式做出回應</li><li>跨公司組成的系統，一些參與者可能會試圖作弊或欺騙其他系統<ul><li>區塊鏈，被認為是一種讓互不信任的多方達成一致共識的系統</li></ul></li><li><strong>軟體Bug</strong></li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="共識演算法與假設">共識演算法與假設<a href="#共識演算法與假設" class="hash-link" aria-label="Direct link to 共識演算法與假設" title="Direct link to 共識演算法與假設">​</a></h3><ul><li>在現實生活中，有許多演算法被設計來解決分散式系統問題，來解決本章討論到的各種故障</li><li>常用的三種系統模型，對於共識演算法在設計來解決的問題，做的假設</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="同步模型">同步模型<a href="#同步模型" class="hash-link" aria-label="Direct link to 同步模型" title="Direct link to 同步模型">​</a></h4><ul><li>假設網路延遲、程序暫停、時鐘偏差都是有限的</li><li>即使有偏差，仍不會超過某個上限</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="部分同步模型">部分同步模型<a href="#部分同步模型" class="hash-link" aria-label="Direct link to 部分同步模型" title="Direct link to 部分同步模型">​</a></h4><ul><li>大多數的時候表現得像是一個同步系統</li><li>一種妥協，也是目前實際上大部分系統的假設</li><li>但要是真的偏差大到某個地步，系統不一定能正常運作</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="非同步模型">非同步模型<a href="#非同步模型" class="hash-link" aria-label="Direct link to 非同步模型" title="Direct link to 非同步模型">​</a></h4><ul><li>不對時間做任何假設，甚至沒有時鐘</li><li>有演算法是真的設計在非同步模型上運作的，但用起來有許多限制</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>共識演算法</div><div class="admonitionContent_S0QG"><p>在本書Ch9有學術上的詳細討論，可以參考之前「鳳凰架構」的<a href="/docs/sg/fenix-architecture/ch6">Ch6</a>作為開始<br>
有興趣深入可以把Ch9讀完，在此列上關鍵字供參考：</p><ul><li>全序廣播</li><li>分散式交易2PC / 3PC / XA</li><li>ZooKeeper</li></ul></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/NoobTechNote/NoobTechNote.github.io/tree/main/docs/sg/ddia/ch8.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-06-12T03:16:35.000Z">Jun 12, 2024</time></b> by <b>Mech</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/sg/ddia/ch7"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ch7: 交易</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/sg/ddia/ch10"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ch10: 批次處理</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#hpc--cloud-computing" class="table-of-contents__link toc-highlight">HPC &amp; Cloud Computing</a></li><li><a href="#不可靠的網路" class="table-of-contents__link toc-highlight">不可靠的網路</a><ul><li><a href="#同步網路與非同步網路" class="table-of-contents__link toc-highlight">同步網路與非同步網路</a></li><li><a href="#非同步網路的不可靠性" class="table-of-contents__link toc-highlight">非同步網路的不可靠性</a></li><li><a href="#現實中的網路故障" class="table-of-contents__link toc-highlight">現實中的網路故障</a></li><li><a href="#檢測故障" class="table-of-contents__link toc-highlight">檢測故障</a></li><li><a href="#合理的timeout" class="table-of-contents__link toc-highlight">合理的Timeout</a></li><li><a href="#網路擁塞和queue" class="table-of-contents__link toc-highlight">網路擁塞和Queue</a></li><li><a href="#不能簡單地讓網路延遲可預測就好嗎" class="table-of-contents__link toc-highlight">不能簡單地讓網路延遲可預測就好嗎？</a></li></ul></li><li><a href="#不可靠的時鐘" class="table-of-contents__link toc-highlight">不可靠的時鐘</a><ul><li><a href="#生活時鐘-time-of-day-clock" class="table-of-contents__link toc-highlight">生活時鐘 Time-of-day clock</a></li><li><a href="#單調時鐘-monotonic-clock" class="table-of-contents__link toc-highlight">單調時鐘 Monotonic clock</a></li><li><a href="#同步與精準度不可靠的時鐘" class="table-of-contents__link toc-highlight">同步與精準度，不可靠的時鐘</a></li><li><a href="#提升時鐘的精度與其困難之處" class="table-of-contents__link toc-highlight">提升時鐘的精度，與其困難之處</a></li><li><a href="#依靠時鐘的問題---事件排序的時間戳記" class="table-of-contents__link toc-highlight">依靠時鐘的問題 - 事件排序的時間戳記</a></li><li><a href="#依靠時鐘的問題---全域快照的同步時鐘" class="table-of-contents__link toc-highlight">依靠時鐘的問題 - 全域快照的同步時鐘</a></li><li><a href="#依靠時鐘的問題---程序暫停" class="table-of-contents__link toc-highlight">依靠時鐘的問題 - 程序暫停</a></li><li><a href="#對策回應時間保證" class="table-of-contents__link toc-highlight">對策：回應時間保證</a></li></ul></li><li><a href="#時鐘的知識真相與謊言" class="table-of-contents__link toc-highlight">時鐘的知識、真相與謊言</a><ul><li><a href="#真相由多數說了算" class="table-of-contents__link toc-highlight">真相由多數說了算</a></li><li><a href="#拜占庭故障" class="table-of-contents__link toc-highlight">拜占庭故障</a></li><li><a href="#共識演算法與假設" class="table-of-contents__link toc-highlight">共識演算法與假設</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024. DEX Study Group</div></div></div></footer></div>
<script src="/assets/js/runtime~main.20c108ea.js"></script>
<script src="/assets/js/main.2d5dd4a1.js"></script>
</body>
</html>