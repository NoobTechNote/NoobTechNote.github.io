<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-sg/ddia/ch5">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Ch5: åˆ†æ•£å¼è³‡æ–™ç³»çµ± | Noob Tech Note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://noobtechnote.github.io/docs/sg/ddia/ch5"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ch5: åˆ†æ•£å¼è³‡æ–™ç³»çµ± | Noob Tech Note"><meta data-rh="true" name="description" content="ç¬¬ä¸€éƒ¨åˆ†æ˜¯å„²å­˜è³‡æ–™çš„æ™‚æ‰€æ‡‰è©²è€ƒæ…®çš„å„ç¨®é¢å‘ï¼Œç¬¬äºŒéƒ¨åˆ†è¨è«–ï¼šå¦‚æœè³‡æ–™å„²å­˜å’Œæª¢ç´¢æ¶‰åŠåˆ°å¤šå°æ©Ÿå™¨ï¼Œæœƒæ€éº¼æ¨£ï¼Ÿ"><meta data-rh="true" property="og:description" content="ç¬¬ä¸€éƒ¨åˆ†æ˜¯å„²å­˜è³‡æ–™çš„æ™‚æ‰€æ‡‰è©²è€ƒæ…®çš„å„ç¨®é¢å‘ï¼Œç¬¬äºŒéƒ¨åˆ†è¨è«–ï¼šå¦‚æœè³‡æ–™å„²å­˜å’Œæª¢ç´¢æ¶‰åŠåˆ°å¤šå°æ©Ÿå™¨ï¼Œæœƒæ€éº¼æ¨£ï¼Ÿ"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://noobtechnote.github.io/docs/sg/ddia/ch5"><link data-rh="true" rel="alternate" href="https://noobtechnote.github.io/docs/sg/ddia/ch5" hreflang="en"><link data-rh="true" rel="alternate" href="https://noobtechnote.github.io/docs/sg/ddia/ch5" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.40771ce4.css">
<link rel="preload" href="/assets/js/runtime~main.a8df846d.js" as="script">
<link rel="preload" href="/assets/js/main.92f7933b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon-144.png" alt="Noob Tech Note" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/icon-144.png" alt="Noob Tech Note" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Noob Tech Note</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/sg">Study Group</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/sg/">Study Group Notes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Study Group Notes&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/clean-architecture/">Clean Architecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Clean Architecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/sg/ddia/ch1">è³‡æ–™å¯†é›†å‹æ‡‰ç”¨ç³»çµ±è¨­è¨ˆ</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch1">Ch1: å¯é ã€å¯æ“´å±•èˆ‡å¯ç¶­è­·çš„ç³»çµ±</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch3">Ch3: å„²å­˜èˆ‡ç´¢å¼•</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch4">Ch4: è³‡æ–™ç·¨ç¢¼èˆ‡æ¼”åŒ–</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/sg/ddia/ch5">Ch5: åˆ†æ•£å¼è³‡æ–™ç³»çµ±</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/ddia/ch5-leaderless">Ch5: è¤‡è£½:ç„¡ä¸»è¤‡è£½</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/fenix-architecture/">é³³å‡°æ¶æ§‹</a><button aria-label="Toggle the collapsible sidebar category &#x27;é³³å‡°æ¶æ§‹&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/five-lines-of-code/">äº”è¡Œç¨‹å¼ç¢¼è¦å‰‡</a><button aria-label="Toggle the collapsible sidebar category &#x27;äº”è¡Œç¨‹å¼ç¢¼è¦å‰‡&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/fundamentals-of-software-architecture/">è»Ÿé«”æ¶æ§‹åŸç† - å·¥ç¨‹æ–¹æ³•</a><button aria-label="Toggle the collapsible sidebar category &#x27;è»Ÿé«”æ¶æ§‹åŸç† - å·¥ç¨‹æ–¹æ³•&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/web-api-the-good-parts/">Web API: The Good Parts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web API: The Good Parts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/sg/"><span itemprop="name">Study Group Notes</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">è³‡æ–™å¯†é›†å‹æ‡‰ç”¨ç³»çµ±è¨­è¨ˆ</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Ch5: åˆ†æ•£å¼è³‡æ–™ç³»çµ±</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ç¬¬äºŒéƒ¨åˆ†: åˆ†æ•£å¼è³‡æ–™ç³»çµ±</h1><p>ç¬¬ä¸€éƒ¨åˆ†æ˜¯å„²å­˜è³‡æ–™çš„æ™‚æ‰€æ‡‰è©²è€ƒæ…®çš„å„ç¨®é¢å‘ï¼Œç¬¬äºŒéƒ¨åˆ†è¨è«–ï¼šå¦‚æœè³‡æ–™å„²å­˜å’Œæª¢ç´¢æ¶‰åŠåˆ°å¤šå°æ©Ÿå™¨ï¼Œæœƒæ€éº¼æ¨£ï¼Ÿ</p><p>è€ƒæ…®ä½¿ç”¨å¤šå°æ©Ÿå™¨çš„æ™‚æ©Ÿ:</p><ul><li>Scalability</li><li>Fault tolerance/High availability</li><li>Latency</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="scaling-to-higher-load">Scaling to Higher Load<a href="#scaling-to-higher-load" class="hash-link" aria-label="Direct link to Scaling to Higher Load" title="Direct link to Scaling to Higher Load">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="scaling-up-vs-scaling-out">Scaling up vs. Scaling out<a href="#scaling-up-vs-scaling-out" class="hash-link" aria-label="Direct link to Scaling up vs. Scaling out" title="Direct link to Scaling up vs. Scaling out">â€‹</a></h4><ul><li><p>Scaling up åˆè¢«ç¨±ç‚º vertical scaling</p><ul><li>Share memory é™åˆ¶: å¾ˆè²´ï¼Œå®¹éŒ¯ä¸å¥½ï¼Œå°±ç®—æä¾›ç†±æ’æ‹”çš„ disk, memoryï¼Œåœ°ç†ä¸Šä¹Ÿä¸€å®šæœƒæœ‰é™åˆ¶</li><li>Share disk é™åˆ¶: race condition æ™‚æœƒæœ‰ lock é–‹éŠ·</li></ul></li><li><p>shared-nothing architectureï¼Œåˆè¢«ç¨±ç‚º horizontal scaling æˆ–ç¨±ç‚º scaling out</p><ul><li>åŸ·è¡Œè³‡æ–™åº«è»Ÿé«”çš„æ¯è‡ºæ©Ÿå™¨ / è™›æ“¬æ©Ÿå™¨éƒ½ç¨±ç‚º ç¯€é»ï¼ˆnodeï¼‰ã€‚æ¯å€‹ç¯€é»åªä½¿ç”¨å„è‡ªçš„è™•ç†å™¨ï¼Œè¨˜æ†¶é«”å’Œç£ç¢Ÿã€‚ç¯€é»ä¹‹é–“çš„ä»»ä½•å”èª¿ï¼Œéƒ½æ˜¯åœ¨è»Ÿé«”å±¤é¢ä½¿ç”¨å‚³çµ±ç¶²è·¯å¯¦ç¾çš„ã€‚</li><li>ç¬¬äºŒéƒ¨åˆ†ä¸»è¦éƒ½åœ¨è¨è«–ç„¡å…±äº«æ¶æ§‹æ‰€æœƒç”¢ç”Ÿçš„å•é¡Œä»¥åŠæ¬Šè¡¡</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="replication-vs-partition">Replication vs. Partition<a href="#replication-vs-partition" class="hash-link" aria-label="Direct link to Replication vs. Partition" title="Direct link to Replication vs. Partition">â€‹</a></h3><p>è³‡æ–™åˆ†ä½ˆåœ¨å¤šå€‹ç¯€é»ä¸Šæœ‰å…©ç¨®å¸¸è¦‹çš„æ–¹å¼ï¼š</p><ul><li>Replication</li></ul><p>åœ¨å¹¾å€‹ä¸åŒçš„ç¯€é»ä¸Šå„²å­˜è³‡æ–™çš„ç›¸åŒå‰¯æœ¬ï¼Œå¯èƒ½æ”¾åœ¨ä¸åŒçš„ä½ç½®ã€‚Replication æä¾›äº†å†—é¤˜ï¼šå¦‚æœä¸€äº›ç¯€é»ä¸å¯ç”¨ï¼Œå‰©é¤˜çš„ç¯€é»ä»ç„¶å¯ä»¥æä¾›è³‡æ–™æœå‹™ã€‚Replication ä¹Ÿæœ‰åŠ©æ–¼æ”¹å–„æ•ˆèƒ½ã€‚ç¬¬äº”ç« å°‡è¨è«– Replicationã€‚</p><ul><li>Partitioning</li></ul><p>å°‡ä¸€å€‹å¤§å‹è³‡æ–™åº«æ‹†åˆ†æˆè¼ƒå°çš„å­é›†ï¼ˆç¨±ç‚º åˆ†å‰²æ§½ï¼Œå³ partitionsï¼‰ï¼Œå¾è€Œä¸åŒçš„åˆ†å‰²æ§½å¯ä»¥æŒ‡æ´¾çµ¦ä¸åŒçš„ ç¯€é»ï¼ˆnodesï¼Œäº¦ç¨± åˆ†ç‰‡ï¼Œå³ shardingï¼‰ã€‚ç¬¬å…­ç« å°‡è¨è«–Partitioningã€‚</p><p>è¤‡è£½å’Œåˆ†å‰²æ§½æ˜¯ä¸åŒçš„æ©Ÿåˆ¶ï¼Œä½†å®ƒå€‘ç¶“å¸¸åŒæ™‚ä½¿ç”¨ã€‚å¦‚ä¸‹åœ–æ‰€ç¤ºã€‚</p><p>ä¸€å€‹ Database åˆ‡åˆ†ç‚ºå…©å€‹ Partitionï¼Œæ¯å€‹ Partition éƒ½æœ‰å…©å€‹ Replication
<img loading="lazy" src="/assets/images/5-1-combine-partition-and-replication-8c142d49bc23362230859996328fb9cd.png" width="1122" height="636" class="img_ev3q"></p><p>ç†è§£äº†é€™äº›æ¦‚å¿µï¼Œå°±å¯ä»¥é–‹å§‹è¨è«–åœ¨åˆ†æ•£å¼ç³»çµ±ä¸­éœ€è¦åšå‡ºçš„å›°é›£æŠ‰æ“‡ã€‚ç¬¬ä¸ƒç«  å°‡è¨è«– äº‹å‹™ï¼ˆTransactionï¼‰ï¼Œé€™å°æ–¼ç­è§£è³‡æ–™ç³»çµ±ä¸­å¯èƒ½å‡ºç¾çš„å„ç¨®å•é¡Œï¼Œä»¥åŠæˆ‘å€‘å¯ä»¥åšäº›ä»€éº¼å¾ˆæœ‰å¹«åŠ©ã€‚ç¬¬å…«ç«  å’Œ ç¬¬ä¹ç«  å°‡è¨è«–åˆ†æ•£å¼ç³»çµ±çš„æ ¹æœ¬ä¾·é™æ€§ã€‚</p><h1>Chapter 5 Replication</h1><p><img loading="lazy" src="/assets/images/5-2-ch5-7a9232a9b9fe741836c5f7b212f02e9c.jpg" width="660" height="816" class="img_ev3q"></p><p>The major difference between a thing that might go wrong and a thing that cannot possibly
go wrong is that when a thing that cannot possibly go wrong goes wrong it usually turns out
to be impossible to get at or repair. â€”Douglas Adams, Mostly Harmless (1992)</p><p>Replication æ„å‘³è‘—åœ¨é€éç¶²è·¯é€£ç·šçš„å¤šè‡ºæ©Ÿå™¨ä¸Šä¿ç•™ç›¸åŒè³‡æ–™çš„å‰¯æœ¬</p><ul><li>To keep data geographically close to your users (and thus reduce latency)</li><li>To allow the system to continue working even if some of its parts have failed (and thus increase availability)</li><li>To scale out the number of machines that can serve read queries (and thus increase read throughput)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">â€‹</a></h2><ul><li><p>Single Leader replication</p><ul><li>Sync vs. Async Replication</li><li>Leader / Follower failure handling<ul><li>Follower failure: catch-up recovery</li><li>Lead failure: Failover</li></ul></li><li>Replication log and its implementation<ul><li>Statement-based replication</li><li>Write-ahead log(WAL) shipping</li><li>Logical (row-based) log replication</li><li>Trigger-based replication</li></ul></li><li>Replication Lag Problems and Solution<ul><li>Reading Your Own Writes</li><li>Monotonic Reads</li><li>Consistent Prefix Reads</li><li>Solutions for Replication Lag</li></ul></li></ul></li><li><p>Multi Leader replication</p><ul><li>Client offline edit / collaborative editing</li><li>Conflict detection / avoidance / resolve</li><li>Conflict definition</li><li>Multi-leader topology</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="leader-and-follower">Leader and Follower<a href="#leader-and-follower" class="hash-link" aria-label="Direct link to Leader and Follower" title="Direct link to Leader and Follower">â€‹</a></h2><p><img loading="lazy" src="/assets/images/5-3-leader-based-replication-4dfc89caadd89f8be2800015eccba2e1.jpg" width="1116" height="434" class="img_ev3q">
é€™ç¨®è¤‡è£½æ¨¡å¼æ˜¯è¨±å¤šé—œä¿‚è³‡æ–™åº«çš„å…§å»ºåŠŸèƒ½ï¼Œå¦‚ PostgreSQLï¼ˆå¾ 9.0 ç‰ˆæœ¬é–‹å§‹ï¼‰ã€MySQLã€Oracle Data Guard å’Œ SQL Server çš„ AlwaysOn Availability Groupsã€‚å®ƒä¹Ÿè¢«ç”¨æ–¼ä¸€äº› Nonrelational DBï¼ŒåŒ…æ‹¬ MongoDBã€‚æœ€å¾Œï¼ŒåŸºæ–¼é ˜å°è€…çš„è¤‡è£½ä¸¦ä¸åƒ…é™æ–¼è³‡æ–™åº«ï¼šåƒ Kafkaå’Œ RabbitMQ high available queues é€™æ¨£çš„åˆ†æ•£å¼message brokers ä¹Ÿä½¿ç”¨å®ƒã€‚æŸäº›ç¶²è·¯æª”æ¡ˆç³»çµ±ï¼Œä¾‹å¦‚ DRBD é€™æ¨£çš„replicated block devicesä¹Ÿèˆ‡ä¹‹é¡ä¼¼ã€‚</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sync-vs-async-replication">Sync vs. Async Replication<a href="#sync-vs-async-replication" class="hash-link" aria-label="Direct link to Sync vs. Async Replication" title="Direct link to Sync vs. Async Replication">â€‹</a></h3><p><img loading="lazy" src="/assets/images/5-4-sync-versus-async-follower-2cc0f2137c4981f53cbc92a8a449e2b5.jpg" width="1122" height="552" class="img_ev3q">
<strong>Special case:</strong>
<a href="https://www.cs.cornell.edu/home/rvr/papers/OSDI04.pdf" target="_blank" rel="noopener noreferrer">Chain Replication</a>
(used in Azure Storage and Amazon EBS)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting-up-new-followers">Setting Up New Followers<a href="#setting-up-new-followers" class="hash-link" aria-label="Direct link to Setting Up New Followers" title="Direct link to Setting Up New Followers">â€‹</a></h3><p>ç°¡å–®åœ°å°‡è³‡æ–™æª”æ¡ˆå¾ä¸€å€‹ç¯€é»è¤‡è£½åˆ°å¦ä¸€å€‹ç¯€é»é€šå¸¸æ˜¯ä¸å¤ çš„ï¼šå› ç‚ºå®¢æˆ¶ç«¯æœƒä¸æ–·å‘è³‡æ–™åº«å¯«å…¥è³‡æ–™</p><p>å¯ä»¥é€é Lock è³‡æ–™åº«ä¾†ä½¿ç£ç¢Ÿä¸Šçš„æª”æ¡ˆä¿æŒä¸€è‡´(åƒéŠ€è¡Œç³»çµ±) ï¼Œä½†æ˜¯é€™æœƒé•èƒŒé«˜å¯ç”¨çš„ç›®æ¨™ã€‚</p><p>å¥½éšªè¨­å®šæ–° Follower é€šå¸¸ä¸¦ä¸éœ€è¦åœæ©Ÿï¼š</p><ol><li>Take a consistent snapshot of the leader&#x27;s database</li><li>Copy snapshot to follower</li><li>å¾ follower é€£ç·šåˆ° leaderï¼Œä¸¦æ‹‰å–å¿«ç…§ä¹‹å¾Œç™¼ç”Ÿçš„æ‰€æœ‰è³‡æ–™è®Šæ›´ã€‚é€™è¦æ±‚å¿«ç…§èˆ‡leader replication log ä¸­çš„ä½ç½®ç²¾ç¢ºé—œè¯ã€‚PostgreSQL å°‡å…¶ç¨±ç‚º log sequence numberï¼ŒMySQL å°‡å…¶ç¨±ç‚º binlog coordinatesã€‚</li></ol><p>ç•¶ follower è™•ç†å®Œå¿«ç…§ä¹‹å¾Œç©ç´¯çš„è³‡æ–™è®Šæ›´ï¼Œæˆ‘å€‘å°±èªªå®ƒ caught up äº†</p><p>å»ºç«‹followerçš„å¯¦éš›æ­¥é©Ÿå› è³‡æ–™åº«è€Œç•°ã€‚æœ‰å¯èƒ½æ‰‹å‹•æˆ–è‡ªå‹•æˆ–è€…ä¸€äº›ç¥ç§˜çš„å·¥ä½œæµç¨‹</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="follower-failure-catch-up-recovery">Follower failure: Catch-up recovery<a href="#follower-failure-catch-up-recovery" class="hash-link" aria-label="Direct link to Follower failure: Catch-up recovery" title="Direct link to Follower failure: Catch-up recovery">â€‹</a></h3><p>æ¯å€‹ Follower åœ¨ disk ä¸Šè¨˜éŒ„å¾ Leader æ”¶åˆ°çš„è³‡æ–™è®Šæ›´ã€‚å¦‚æœ Follower å£æ‰é‡æ–°å•Ÿå‹•æˆ–æ–·ç¶²ï¼Œå‰‡ Follower å¯ä»¥å¾æ—¥èªŒä¸­çŸ¥é“åœ¨ç™¼ç”Ÿæ•…éšœä¹‹å‰è™•ç†çš„æœ€å¾Œä¸€å€‹Transactionã€‚ä¹‹å¾Œ Follower å¯ä»¥é€£ç·šåˆ° Leaderï¼Œä¸¦è«‹æ±‚åœ¨å£æ‰æœŸé–“ç™¼ç”Ÿçš„æ‰€æœ‰è³‡æ–™è®Šæ›´ã€‚</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="leader-failure-failover">Leader failure: Failover<a href="#leader-failure-failover" class="hash-link" aria-label="Direct link to Leader failure: Failover" title="Direct link to Leader failure: Failover">â€‹</a></h3><p>å…¶ä¸­ä¸€å€‹ Follower è¦è¢« promote ç‚ºæ–°çš„ Leaderï¼Œéœ€è¦é‡æ–°é…ç½®å®¢æˆ¶ç«¯ï¼Œä»¥å°‡å®ƒå€‘çš„å¯«æ“ä½œå‚³é€çµ¦æ–°çš„ Leaderï¼Œå…¶ä»– Follower éœ€è¦é–‹å§‹æ‹‰å–ä¾†è‡ªæ–° Leader çš„è³‡æ–™è®Šæ›´ã€‚é€™å€‹éç¨‹è¢«ç¨±ç‚º failover</p><p>failoverå¯ä»¥æ‰‹å‹•æˆ–è‡ªå‹•ã€‚è‡ªå‹•çš„failoveræ­¥é©Ÿï¼š</p><ol><li>ç¢ºèª Leader å¤±æ•ˆã€‚æœ‰å¾ˆå¤šäº‹æƒ…å¯èƒ½æœƒå‡ºéŒ¯ï¼šå´©æ½°ã€åœé›»ã€ç¶²è·¯å•é¡Œç­‰ç­‰ã€‚æ²’æœ‰è¬ç„¡ä¸€å¤±çš„æ–¹æ³•ï¼Œæ‰€ä»¥å¤§å¤šæ•¸ç³»çµ±åªæ˜¯ç°¡å–®ä½¿ç”¨Timeout</li><li>é¸æ“‡ä¸€å€‹æ–°çš„ Leader ã€‚é€™å¯ä»¥é€éé¸èˆ‰éç¨‹ï¼ˆ Leader ç”±å‰©é¤˜ Follower ä»¥å¤šæ•¸é¸èˆ‰ç”¢ç”Ÿï¼‰ä¾†å®Œæˆ(éœ€è¦å…±è­˜æ¼”ç®—æ³•)ã€‚</li><li>é‡æ–°é…ç½®ç³»çµ±ä»¥å•Ÿç”¨æ–°çš„ Leaderã€‚å®¢æˆ¶ç«¯ç¾åœ¨éœ€è¦å°‡å®ƒå€‘çš„å¯«è«‹æ±‚å‚³é€çµ¦æ–° Leaderã€‚å¦‚æœèˆŠ Leader æ¢å¾©ï¼Œå¯èƒ½ä»ç„¶èªç‚ºè‡ªå·±æ˜¯ Leader ï¼Œè€Œæ²’æœ‰æ„è­˜åˆ°å…¶ä»–å‰¯æœ¬å·²ç¶“è®“å®ƒå¤±å»é ˜å°æ¬Šäº†ã€‚ç³»çµ±éœ€è¦ç¢ºä¿èˆŠ Leader æ„è­˜åˆ°æ–° Leader çš„å­˜åœ¨ï¼Œä½µæˆç‚ºä¸€å€‹ Follower ã€‚</li></ol><p>æ•…éšœåˆ‡æ›çš„éç¨‹ä¸­æœ‰å¾ˆå¤šåœ°æ–¹å¯èƒ½å‡ºéŒ¯ï¼š</p><ul><li>æ–° Leader æ²’æœ‰æ”¶åˆ°è€ Leader æ›æ‰å‰æœ€å¾Œçš„å¯«å…¥æ“ä½œã€‚</li><li>å¦‚æœè³‡æ–™åº«éœ€è¦å’Œå…¶ä»–å¤–éƒ¨å„²å­˜ç›¸å”èª¿ï¼Œé‚£éº¼ä¸Ÿæ£„å¯«å…¥å…§å®¹æ˜¯æ¥µå…¶å±éšªçš„æ“ä½œã€‚ Example: ä¾‹å¦‚åœ¨ GitHub çš„ä¸€å ´äº‹æ•…ä¸­ï¼Œä¸€å€‹éæ™‚çš„ MySQL Follower è¢«æå‡ç‚ºLeaderã€‚è³‡æ–™åº«ä½¿ç”¨è‡ªå¢ ID ä½œç‚ºPrimaryï¼Œå› ç‚ºæ–°ä¸»åº«çš„è¨ˆæ•¸å™¨è½å¾Œæ–¼è€ä¸»åº«çš„è¨ˆæ•¸å™¨ï¼Œæ‰€ä»¥æ–°ä¸»åº«é‡æ–°åˆ†é…äº†ä¸€äº›å·²ç¶“è¢«è€ä¸»åº«åˆ†é…æ‰çš„ ID ä½œç‚ºä¸»éµã€‚é€™äº›ä¸»éµä¹Ÿåœ¨ Redis ä¸­ä½¿ç”¨ï¼Œä¸»éµé‡ç”¨ä½¿å¾— MySQL å’Œ Redis ä¸­çš„è³‡æ–™ç”¢ç”Ÿä¸ä¸€è‡´ï¼Œæœ€å¾Œå°è‡´ä¸€äº›ç§æœ‰è³‡æ–™æ´©æ¼åˆ°éŒ¯èª¤çš„ä½¿ç”¨è€…æ‰‹ä¸­ã€‚</li><li>Split brain</li><li>å¦‚ä½•çŸ¥é“ Leader æ˜¯çœŸçš„æ›æ‰äº†ï¼Œå¦‚æœåªæ˜¯Spikeï¼Œåè€ŒæœƒåŠ é‡è² æ“”</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation-of-replication-logs">Implementation of Replication Logs<a href="#implementation-of-replication-logs" class="hash-link" aria-label="Direct link to Implementation of Replication Logs" title="Direct link to Implementation of Replication Logs">â€‹</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-statement-based-replication">ğŸ‘ Statement-based replication<a href="#-statement-based-replication" class="hash-link" aria-label="Direct link to ğŸ‘ Statement-based replication" title="Direct link to ğŸ‘ Statement-based replication">â€‹</a></h4><p>è¤‡è£½æ¯å€‹ statement åˆ° follower åŸ·è¡Œï¼Œåƒ SQL statementï¼Œä½†æ˜¯å¾ˆå¤šæƒ…æ³æœƒå°è‡´ replication å£æ‰</p><ol><li>nondeterministic function, such as NOW() or RAND() is likely to generate a different value on each replica.</li><li>If statements depend on the existing data in the database (e.g., UPDATE ... WHERE ...),  must be executed in exactly the same order on each replica</li><li>side effects (e.g., triggers, stored procedures, user-defined functions)</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-write-ahead-log-wal-shipping">ğŸ‘ Write-ahead log (WAL) shipping<a href="#-write-ahead-log-wal-shipping" class="hash-link" aria-label="Direct link to ğŸ‘ Write-ahead log (WAL) shipping" title="Direct link to ğŸ‘ Write-ahead log (WAL) shipping">â€‹</a></h4><p>usually every write to a database is appended to a log</p><ul><li>In SSTables and LSM-Trees, WAL is the main place for storage. Log segments are compacted in the background.</li><li>In B-tree, every modification is first written to a WAL so that the index can be restored to a consistent state after a crash.</li></ul><p>å¥½è™•ï¼šWAL åŒ…å«äº†æ‰€æœ‰è³‡æ–™åº«å¯«å…¥çš„append-only sequence of bytesã€‚å¯ä»¥ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ—¥èªŒåœ¨å¦ä¸€å€‹ç¯€é»ä¸Šæ§‹å»ºä¸€æ¨¡ä¸€æ¨£çš„ replica</p><p>ç¼ºé»ï¼šéå¸¸åº•å±¤ï¼Œç„¡æ³•çœ‹æ‡‚ï¼Œè·Ÿstorage engineè€¦åˆï¼Œæ›ç‰ˆæœ¬æˆ–æ›storage engineå¯èƒ½æœƒæœ‰downtime</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="-logical-row-based-log-replication">ğŸ‘ Logical (row-based) log replication<a href="#-logical-row-based-log-replication" class="hash-link" aria-label="Direct link to ğŸ‘ Logical (row-based) log replication" title="Direct link to ğŸ‘ Logical (row-based) log replication">â€‹</a></h4><p>ä¸ç¶å®šstorage engineï¼Œå¯ä»¥åªå„²å­˜ä½œreplicationæ‰€éœ€è¦çš„å¿…è¦è³‡è¨Šï¼Œä¹Ÿé©åˆç™¼çµ¦å¤–éƒ¨ç³»çµ±ä½œå®¢è£½åŒ–ç´¢å¼•æˆ–data warehouse
logical log  is usually at the granularity of a row:</p><ul><li>For an inserted row, the log contains the new values of all columns.</li><li>For a deleted row, the log contains enough information to uniquely identify the
row that was deleted. Typically this would be the primary key, but if there is no
primary key on the table, the old values of all columns need to be logged.</li><li>For an updated row, the log contains enough information to uniquely identify
the updated row, and the new values of all columns (or at least the new values of
all columns that changed).</li></ul><p>Ref:</p><ul><li><a href="https://www.postgresql.org/docs/current/logical-replication.html" target="_blank" rel="noopener noreferrer">https://www.postgresql.org/docs/current/logical-replication.html</a></li><li><a href="https://dev.mysql.com/doc/refman/8.0/en/replication.html" target="_blank" rel="noopener noreferrer">https://dev.mysql.com/doc/refman/8.0/en/replication.html</a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="-trigger-based-replication">ğŸ˜ Trigger-based replication<a href="#-trigger-based-replication" class="hash-link" aria-label="Direct link to ğŸ˜ Trigger-based replication" title="Direct link to ğŸ˜ Trigger-based replication">â€‹</a></h3><p>å®¢è£½åŒ–å·¥å…·ï¼Œåªéœ€è¤‡è£½è‡ªå·±æŒ‡å®šç¯„åœçš„è³‡æ–™ï¼Œæˆ–è€…åœ¨è‡ªå·±æƒ³è¦çš„æ™‚é–“trigger</p><p>For Example:</p><ul><li><a href="https://www.oracle.com/integration/goldengate/" target="_blank" rel="noopener noreferrer">Oracle GoldenGate</a></li><li>Store procedure</li><li>triggers</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="problems-with-replication-lag">Problems with Replication Lag<a href="#problems-with-replication-lag" class="hash-link" aria-label="Direct link to Problems with Replication Lag" title="Direct link to Problems with Replication Lag">â€‹</a></h2><p>Leader-based replication é©åˆç”¨åœ¨å¤šè®€å°‘å¯«çš„æƒ…æ³ï¼Œå¯ä»¥åˆ†æ•£è®€å–çš„å·¥ä½œè² è¼‰ï¼Œä½†å°±æœƒé‡åˆ°å¿…é ˆä½¿ç”¨Async Replicationæ‰€ç”¢ç”Ÿçš„Lagå•é¡Œ</p><p>Term: Eventual consistency</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="read-your-own-writes">Read Your Own Writes<a href="#read-your-own-writes" class="hash-link" aria-label="Direct link to Read Your Own Writes" title="Direct link to Read Your Own Writes">â€‹</a></h3><p><img loading="lazy" src="/assets/images/5-5-write-but-read-nothing-33c88ccb0b133045f329a9822b1314f9.jpg" width="1114" height="542" class="img_ev3q"></p><p>Read-your-writes (Read-after-write) consistency: ç•¶ä½¿ç”¨è€…é‡æ–°è¼‰å…¥é é¢ï¼Œé‡æ–°æ•´ç†æ™‚ï¼Œç¢ºä¿ä¸€å®šçœ‹åˆ°è‡ªå·±å‰›å‰›æäº¤çš„æ›´æ–°ï¼Œä½†ä¸ä¿è­‰çœ‹åˆ°å…¶ä»–ä½¿ç”¨è€…çš„æœ€æ–°æ›´æ–°</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="solutions">Solutions:<a href="#solutions" class="hash-link" aria-label="Direct link to Solutions:" title="Direct link to Solutions:">â€‹</a></h4><ul><li>å¦‚æœæ˜¯è®€è‡ªå·±å¯«çš„æ±è¥¿ï¼Œå¾ leader è®€ï¼Œå¦å‰‡å¾ follower è®€. e.g., twitter, teams</li><li>å¯ä»¥æ ¹æ“šç‰©ä»¶çš„last updated timeï¼Œç„¶å¾Œå†åƒè€ƒ follower latencyï¼Œä¾†æ±ºå®šå¹¾åˆ†é˜ä»¥å…§æ›´æ–°çš„è³‡æ–™å» leader è®€å–ï¼Œ</li><li>ç´€éŒ„ä½¿ç”¨è€…æœ€å¾Œä¸€æ¬¡åŸ·è¡Œå¯«å…¥çš„æ™‚é–“ï¼Œå¦‚æœfollowerä¸å¤ æ–°ï¼Œå°±å»æ‰¾å…¶ä»–å¯èƒ½æ¯”è¼ƒæ–°çš„followerï¼Œä½†é€™å¾ˆä¾é æ™‚é–“åŒæ­¥</li><li>å¦‚æœReplicaåœ¨ä¸åŒçš„data center æœƒå¢åŠ è¤‡é›œæ€§</li></ul><p>å¦‚æœæ˜¯è·¨è£ç½®ï¼Œåƒé›»è…¦è·Ÿæ‰‹æ©Ÿè¦ç¢ºä¿èƒ½å³æ™‚çœ‹åˆ°å¦ä¸€é‚Šçš„updateï¼Œé€™ç¨®çš„ read-your-writes consistencyå°±æœ‰æ›´å¤šè¦è€ƒæ…®çš„åœ°æ–¹</p><ul><li>ç´€éŒ„ä½¿ç”¨è€…timestampä¸å¯è¡Œï¼Œå› ç‚ºè£ç½®ä¸åŒ</li><li>ç¶²è·¯ä¸åŒï¼Œè¦ç¢ºä¿é€™äº›deviceä½¿ç”¨åˆ°åŒä¸€å€‹leader</li></ul><p><strong>Monotonic Read</strong>
<img loading="lazy" src="/assets/images/5-6-time-go-backward-4867763ad3407dac97f40605b12e16d3.jpg" width="1102" height="660" class="img_ev3q"></p><p>monotonic reads å¯ä»¥ä¿è­‰é€™ç¨®ç•°å¸¸ä¸æœƒç™¼ç”Ÿã€‚é€™æ˜¯ä¸€å€‹æ¯” å¼·ä¸€è‡´æ€§ï¼ˆstrong consistencyï¼‰ æ›´å¼±ï¼Œä½†æ¯” æœ€çµ‚ä¸€è‡´æ€§ï¼ˆeventual consistencyï¼‰ æ›´å¼·çš„ä¿è­‰ã€‚ç•¶è®€å–è³‡æ–™æ™‚ï¼Œä½ å¯èƒ½æœƒçœ‹åˆ°ä¸€ç®‡èˆŠå€¼ï¼›å–®èª¿è®€åƒ…æ„å‘³è‘—å¦‚æœä¸€å€‹ä½¿ç”¨è€…é †åºåœ°é€²è¡Œå¤šæ¬¡è®€å–ï¼Œå‰‡ä»–å€‘ä¸æœƒçœ‹åˆ°æ™‚é–“å›é€€ï¼Œä¹Ÿå°±æ˜¯èªªï¼Œå¦‚æœå·²ç¶“è®€å–åˆ°è¼ƒæ–°çš„è³‡æ–™ï¼Œå¾ŒçºŒçš„è®€å–ä¸æœƒå¾—åˆ°æ›´èˆŠçš„è³‡æ–™ã€‚</p><p>å¯¦ç¾æ–¹æ³•ï¼šæ¯æ¬¡åŒä¸€å€‹followerè®€ï¼Œå¯ä»¥ç”¨hash uidä¾†æŒ‡å®šfollower</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consistent-prefix-reads">Consistent Prefix Reads<a href="#consistent-prefix-reads" class="hash-link" aria-label="Direct link to Consistent Prefix Reads" title="Direct link to Consistent Prefix Reads">â€‹</a></h3><p><img loading="lazy" src="/assets/images/5-7-see-the-future-1d14a50206dd7bedb1e3ba24f0054cff.jpg" width="1104" height="796" class="img_ev3q">
consistent prefix reads: This guarantee says that if a sequence of writes happens in a certain order,
then anyone reading those writes will see them appear in the same order.</p><p>ä¸€ç¨®è§£æ±ºæ–¹æ¡ˆæ˜¯ä¿è­‰è³‡æ–™éƒ½å¯«åˆ°ç›¸åŒçš„partitionï¼Œä½†å¯èƒ½æ²’æœ‰æ•ˆç‡ï¼Œå¾ŒçºŒæœ‰ä¸€äº›æ¼”ç®—æ³•è«–è¨è«–é—œæ–¼é€™ç¨®å› æœé—œä¿‚(causality)çš„å•é¡Œ</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="solutions-for-replication-lag">Solutions for Replication Lag<a href="#solutions-for-replication-lag" class="hash-link" aria-label="Direct link to Solutions for Replication Lag" title="Direct link to Solutions for Replication Lag">â€‹</a></h3><p>åœ¨ä½¿ç”¨æœ€çµ‚ä¸€è‡´çš„ç³»çµ±æ™‚ï¼Œå¦‚æœè¤‡è£½å»¶é²å¢åŠ åˆ°å¹¾åˆ†é˜ç”šè‡³å¹¾å°æ™‚ï¼Œå‰‡æ‡‰è©²è€ƒæ…®æ‡‰ç”¨ç¨‹å¼çš„è¡Œç‚ºã€‚å¦‚æœç­”æ¡ˆæ˜¯ â€œæ²’å•é¡Œâ€ï¼Œé‚£å¾ˆå¥½ã€‚ä½†å¦‚æœçµæœå°æ–¼ä½¿ç”¨è€…ä¾†èªªæ˜¯ä¸å¥½çš„é«”é©—ï¼Œé‚£éº¼è¨­è¨ˆç³»çµ±ä¾†æä¾›æ›´å¼·çš„ä¿è­‰æ˜¯å¾ˆé‡è¦çš„ã€‚æ˜æ˜æ˜¯éåŒæ­¥è¤‡è£½å»å‡è¨­è¤‡è£½æ˜¯åŒæ­¥çš„ï¼Œé€™æ˜¯å¾ˆå¤šéº»ç…©çš„æ ¹æºã€‚</p><p>ä½†åœ¨æ‡‰ç”¨ç¨‹å¼ç¨‹å¼ç¢¼ä¸­è™•ç†é€™äº›å•é¡Œæ˜¯è¤‡é›œçš„ï¼Œå®¹æ˜“å‡ºéŒ¯ã€‚</p><p>å¦‚æœæ‡‰ç”¨ç¨‹å¼é–‹ç™¼äººå“¡ä¸å¿…æ“”å¿ƒå¾®å¦™çš„è¤‡è£½å•é¡Œï¼Œä¸¦å¯ä»¥ä¿¡è³´ä»–å€‘çš„è³‡æ–™åº« â€œåšäº†æ­£ç¢ºçš„äº‹æƒ…â€ï¼Œé‚£è©²å¤šå¥½å‘€ã€‚é€™å°±æ˜¯ transaction å­˜åœ¨çš„åŸå› ï¼šè³‡æ–™åº«é€éäº‹å‹™æä¾›å¼·å¤§çš„ä¿è­‰ï¼Œæ‰€ä»¥æ‡‰ç”¨ç¨‹å¼å¯ä»¥æ›´åŠ ç°¡å–®ã€‚</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="multi-leader-replication">Multi-Leader Replication<a href="#multi-leader-replication" class="hash-link" aria-label="Direct link to Multi-Leader Replication" title="Direct link to Multi-Leader Replication">â€‹</a></h2><p>Leader-based replication has one major downside: there is only one leader, and all
writes must go through it.</p><p>Multi-leader allow more than one node to accept writes.</p><p>multi-leader (also known as masterâ€“master or active/active replication).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="use-cases-for-multi-leader-replication">Use Cases for Multi-Leader Replication<a href="#use-cases-for-multi-leader-replication" class="hash-link" aria-label="Direct link to Use Cases for Multi-Leader Replication" title="Direct link to Use Cases for Multi-Leader Replication">â€‹</a></h3><p>åœ¨å–®å€‹æ•¸æ“šä¸­å¿ƒå…§éƒ¨ä½¿ç”¨å¤šå€‹ä¸»åº«çš„é…ç½®æ²’æœ‰å¤ªå¤§æ„ç¾©ï¼Œå› ç‚ºå…¶å°è‡´çš„è¤‡é›œæ€§å·²ç¶“è¶…éäº†èƒ½å¸¶ä¾†çš„å¥½è™•ã€‚ä½†åœ¨ä¸€äº›æƒ…æ³ä¸‹ï¼Œé€™ç¨®é…ç½®ä¹Ÿæ˜¯åˆç†çš„ã€‚</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="multi-datacenter-operation">Multi-datacenter operation<a href="#multi-datacenter-operation" class="hash-link" aria-label="Direct link to Multi-datacenter operation" title="Direct link to Multi-datacenter operation">â€‹</a></h4><p><img loading="lazy" src="/assets/images/5-8-multi-leader-52a90b584cbdb2766d087faeb81aa70a.jpg" width="1102" height="596" class="img_ev3q">
æ¥ä¸‹ä¾†æ¯”è¼ƒå¤šè³‡æ–™ä¸­å¿ƒæƒ…æ³ä¸‹ï¼Œsingle-leaderè·Ÿmulti-leaderçš„é©æ‡‰æƒ…æ³</p><ul><li>Performance</li></ul><table><thead><tr><th></th><th>Single-leader</th><th>Multi-leader</th></tr></thead><tbody><tr><td>Performance</td><td>æ¯å€‹å¯«å…¥éƒ½è¦è·¨regionå¯«å…¥åˆ°Leaderæ‰€åœ¨çš„datacenterï¼Œé•åäº†ä½¿ç”¨å¤šdatacenterçš„ç›®çš„</td><td>ç›´æ¥å¯«å…¥åˆ°æœ€è¿‘çš„datacenterï¼Œå†replicateåˆ°å…¶ä»–datacenter</td></tr><tr><td>Tolerance of datacenter outages</td><td>Failover æŠŠå…¶ä»–datacenterçš„followeræå‡æˆ Leader</td><td>å…¶ä»–datacenter leaderæ­£å¸¸åŸ·è¡Œï¼Œå£æ‰çš„datacenterå¾Œä¾†å†catch-up</td></tr><tr><td>Tolerance of network problems</td><td>è·¨Datacenterçš„ç¶²è·¯é€šå¸¸è¦ç¶“épublic internetæœƒå¾ˆä¸ç©©å®š</td><td>é€šå¸¸æœƒæ¯”è·¨datacenterå‚³è¼¸ç©©å®š</td></tr></tbody></table><p>å„è³‡æ–™åº«å¤šä½¿ç”¨å¤–éƒ¨å·¥å…·ä¾†æ”¯æ´</p><ul><li>Tungsten Replicator for MySQL</li><li>BDR for PostgreSQL</li><li>GoldenGate for Oracle</li></ul><p>é›–ç„¶multi-leaderæœ‰å¾ˆå¤šå¥½è™•ï¼Œä½†æœ‰ä¸€å€‹å¤§ç¼ºé»ï¼šç›¸åŒè³‡æ–™å¯èƒ½åœ¨ä¸åŒdatacentersåŒæ™‚è¢«ä¿®æ”¹ï¼Œå¿…é ˆè¦è§£conflict
ç”±æ–¼å¤šä¸»è¤‡è£½åœ¨è¨±å¤šè³‡æ–™åº«ä¸­éƒ½å±¬æ–¼æ”¹è£çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å¸¸å¸¸å­˜åœ¨å¾®å¦™çš„é…ç½®ç¼ºé™·ï¼Œä¸”ç¶“å¸¸èˆ‡å…¶ä»–è³‡æ–™åº«åŠŸèƒ½ä¹‹é–“å‡ºç¾æ„å¤–çš„åæ‡‰ã€‚
æ¯”å¦‚</p><ul><li>autoincrementing keys</li><li>triggers</li><li>integrity constraint</li></ul><p>ç­‰éƒ½å¯èƒ½æœƒæœ‰éº»ç…©ã€‚å› æ­¤ï¼Œå¤šä¸»è¤‡è£½å¾€å¾€è¢«èªç‚ºæ˜¯å±éšªçš„é ˜åŸŸï¼Œæ‡‰å„˜å¯èƒ½é¿å…</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="clients-with-offline-operation">Clients with offline operation<a href="#clients-with-offline-operation" class="hash-link" aria-label="Direct link to Clients with offline operation" title="Direct link to Clients with offline operation">â€‹</a></h4><p>Example: Calendar, notion
æ¯å€‹deviceå°±åƒä¸€å€‹datacenter</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="collaborative-editing">Collaborative editing<a href="#collaborative-editing" class="hash-link" aria-label="Direct link to Collaborative editing" title="Direct link to Collaborative editing">â€‹</a></h4><p>Example: Google doc, Wiki</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-write-conflicts">Handling Write Conflicts<a href="#handling-write-conflicts" class="hash-link" aria-label="Direct link to Handling Write Conflicts" title="Direct link to Handling Write Conflicts">â€‹</a></h3><p><img loading="lazy" src="/assets/images/5-9-write-conflict-2944fc788bb4e7790fce1d8fdcbcb699.jpg" width="1104" height="544" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="synchronous-versus-asynchronous-conflict-detection">Synchronous versus asynchronous conflict detection<a href="#synchronous-versus-asynchronous-conflict-detection" class="hash-link" aria-label="Direct link to Synchronous versus asynchronous conflict detection" title="Direct link to Synchronous versus asynchronous conflict detection">â€‹</a></h4><p>åŸºæœ¬ä¸Šä¸å¯èƒ½ç”¨sync conflict detectionï¼Œé‚£ä½ ä¹¾è„†ç”¨single-leader</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="conflict-avoidance">Conflict avoidance<a href="#conflict-avoidance" class="hash-link" aria-label="Direct link to Conflict avoidance" title="Direct link to Conflict avoidance">â€‹</a></h4><p>å¦‚æœèƒ½ä¿è­‰æŸäº›ç‰¹å®šå¯«å…¥åªæœƒåˆ°åŒå€‹Leaderï¼Œé€™æ¨£å°±æ²’æœ‰conflictäº†
èˆ‰ä¾‹åƒæŸäº›å®¢æˆ¶æ°¸é åªå¯«å…¥ç‰¹å®šçš„Leaderï¼Œå°å–®ä¸€å€‹å®¢æˆ¶ä¾†èªªï¼Œä»–åªæœ‰single-leader
ä½†å®¢æˆ¶æœ‰å¯èƒ½æœƒå‡ºåœ‹ï¼Œé€™æ™‚å€™å°±æœ‰å¯èƒ½è¦æ›datacenter</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="converging-toward-a-consistent-state">Converging toward a consistent state<a href="#converging-toward-a-consistent-state" class="hash-link" aria-label="Direct link to Converging toward a consistent state" title="Direct link to Converging toward a consistent state">â€‹</a></h4><p>è®“conflict æ”¶æ–‚åˆ°ä¸€å€‹å€¼</p><ul><li>çµ¦æ¯å€‹writeä¸€å€‹unique ID (e.g., timestamp, UUID, hash value)ï¼Œå€¼æ¯”è¼ƒé«˜çš„ç²å‹ï¼Œå¦‚æœä½¿ç”¨timestampï¼Œé€™ç¨®æ–¹æ³•å«åš last write win (LWW)ï¼Œé›–ç„¶LWWå¾ˆæµè¡Œï¼Œä½†æœ‰å¯èƒ½æœƒé€ æˆdata loss</li><li>çµ¦æ¯å€‹replicaä¸€å€‹ID, é«˜çš„è´ï¼Œä¸€æ¨£æœ‰å¯èƒ½æœ‰data loss</li><li>æŠŠå€¼mergeæˆ–concatèµ·ä¾† (e.g., B/C)</li><li>é€šé€šå¯«é€²å»ï¼Œè®€å‡ºä¾†çš„æ™‚å€™è®“useråšé¸æ“‡</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="custom-conflict-resolution-logic">Custom conflict resolution logic<a href="#custom-conflict-resolution-logic" class="hash-link" aria-label="Direct link to Custom conflict resolution logic" title="Direct link to Custom conflict resolution logic">â€‹</a></h4><ul><li>On Write: åµæ¸¬åˆ°conflictï¼Œtrigger conflict handlerï¼Œè®“ç”¨æˆ¶è‡ªå·±å¯«é‚è¼¯å»è§£ (e.g., <a href="https://bucardo.org/Bucardo/operations/conflict_handling" target="_blank" rel="noopener noreferrer">Bucardo</a>)</li><li>On Read: all the conflicting writes are stored. When the data is read, app resolve the conflict, and write the result back to the database. CouchDB works this way.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-conflict-resolution">Automatic Conflict Resolution<a href="#automatic-conflict-resolution" class="hash-link" aria-label="Direct link to Automatic Conflict Resolution" title="Direct link to Automatic Conflict Resolution">â€‹</a></h4><ul><li>Conflict-free replicated datatypes (CRDTs)<ul><li><a href="https://zh.wikipedia.org/zh-tw/%E6%97%A0%E5%86%B2%E7%AA%81%E5%A4%8D%E5%88%B6%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B" target="_blank" rel="noopener noreferrer">https://zh.wikipedia.org/zh-tw/%E6%97%A0%E5%86%B2%E7%AA%81%E5%A4%8D%E5%88%B6%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B</a></li><li><a href="https://redis.io/active-active/" target="_blank" rel="noopener noreferrer">https://redis.io/active-active/</a></li></ul></li><li>Mergeable persistent data structures</li><li>Operational transformation<ul><li><a href="https://en.wikipedia.org/wiki/Operational_transformation" target="_blank" rel="noopener noreferrer">https://en.wikipedia.org/wiki/Operational_transformation</a></li></ul></li></ul><p>ä»€éº¼æ˜¯conflicté€™ä»¶äº‹æœƒåœ¨Transactioné‚£å¼µæ·±åˆ»è¨è«–</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi-leader-replication-topologies">Multi-Leader Replication Topologies<a href="#multi-leader-replication-topologies" class="hash-link" aria-label="Direct link to Multi-Leader Replication Topologies" title="Direct link to Multi-Leader Replication Topologies">â€‹</a></h3><p><img loading="lazy" src="/assets/images/5-10-topology-7a0187f0bcf726fd9e69c27e8dfd032a.jpg" width="1104" height="376" class="img_ev3q">
The most general topology is all-to-all.
MySQL by default supports only a circular topology
<img loading="lazy" src="/assets/images/5-11-wrong-order-arrive-26d40fb44b68434ec82e921c0ba6d4d3.jpg" width="1106" height="714" class="img_ev3q">
problem of causality</p><p>conflict detection techniques are poorly implemented in many multi-leader
replication systems. For example, PostgreSQL BDR does not
provide causal ordering of writes, and Tungsten Replicator for MySQL doesnâ€™t
even try to detect conflicts <!-- -->[34]<!-- -->.</p><p>If you are using a system with multi-leader replication, it is worth being aware of
these issues, carefully reading the documentation, and thoroughly testing your database
to ensure that it really does provide the guarantees you believe it to have.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/NoobTechNote/NoobTechNote.github.io/tree/main/docs/sg/ddia/ch5.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-05-14T04:28:20.000Z">May 14, 2024</time></b> by <b>Mech</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/sg/ddia/ch4"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ch4: è³‡æ–™ç·¨ç¢¼èˆ‡æ¼”åŒ–</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/sg/ddia/ch5-leaderless"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ch5: è¤‡è£½:ç„¡ä¸»è¤‡è£½</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#scaling-to-higher-load" class="table-of-contents__link toc-highlight">Scaling to Higher Load</a></li><li><a href="#replication-vs-partition" class="table-of-contents__link toc-highlight">Replication vs. Partition</a></li><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#leader-and-follower" class="table-of-contents__link toc-highlight">Leader and Follower</a><ul><li><a href="#sync-vs-async-replication" class="table-of-contents__link toc-highlight">Sync vs. Async Replication</a></li><li><a href="#setting-up-new-followers" class="table-of-contents__link toc-highlight">Setting Up New Followers</a></li><li><a href="#follower-failure-catch-up-recovery" class="table-of-contents__link toc-highlight">Follower failure: Catch-up recovery</a></li><li><a href="#leader-failure-failover" class="table-of-contents__link toc-highlight">Leader failure: Failover</a></li><li><a href="#implementation-of-replication-logs" class="table-of-contents__link toc-highlight">Implementation of Replication Logs</a></li><li><a href="#-trigger-based-replication" class="table-of-contents__link toc-highlight">ğŸ˜ Trigger-based replication</a></li></ul></li><li><a href="#problems-with-replication-lag" class="table-of-contents__link toc-highlight">Problems with Replication Lag</a><ul><li><a href="#read-your-own-writes" class="table-of-contents__link toc-highlight">Read Your Own Writes</a></li><li><a href="#consistent-prefix-reads" class="table-of-contents__link toc-highlight">Consistent Prefix Reads</a></li><li><a href="#solutions-for-replication-lag" class="table-of-contents__link toc-highlight">Solutions for Replication Lag</a></li></ul></li><li><a href="#multi-leader-replication" class="table-of-contents__link toc-highlight">Multi-Leader Replication</a><ul><li><a href="#use-cases-for-multi-leader-replication" class="table-of-contents__link toc-highlight">Use Cases for Multi-Leader Replication</a></li><li><a href="#handling-write-conflicts" class="table-of-contents__link toc-highlight">Handling Write Conflicts</a></li><li><a href="#multi-leader-replication-topologies" class="table-of-contents__link toc-highlight">Multi-Leader Replication Topologies</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2024. DEX Study Group</div></div></div></footer></div>
<script src="/assets/js/runtime~main.a8df846d.js"></script>
<script src="/assets/js/main.92f7933b.js"></script>
</body>
</html>