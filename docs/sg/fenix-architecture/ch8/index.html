<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-sg/fenix-architecture/ch8">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Ch8: 流量治理 | Noob Tech Note</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://noobtechnote.github.io/docs/sg/fenix-architecture/ch8"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ch8: 流量治理 | Noob Tech Note"><meta data-rh="true" name="description" content="容錯性的設計應該被視為微服務架構設計預期就需要注意到的點"><meta data-rh="true" property="og:description" content="容錯性的設計應該被視為微服務架構設計預期就需要注意到的點"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://noobtechnote.github.io/docs/sg/fenix-architecture/ch8"><link data-rh="true" rel="alternate" href="https://noobtechnote.github.io/docs/sg/fenix-architecture/ch8" hreflang="en"><link data-rh="true" rel="alternate" href="https://noobtechnote.github.io/docs/sg/fenix-architecture/ch8" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.40771ce4.css">
<link rel="preload" href="/assets/js/runtime~main.e984117f.js" as="script">
<link rel="preload" href="/assets/js/main.10b554c0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/icon-144.png" alt="Noob Tech Note" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/icon-144.png" alt="Noob Tech Note" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Noob Tech Note</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/sg">Study Group</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/sg/">Study Group Notes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Study Group Notes&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/clean-architecture/">Clean Architecture</a><button aria-label="Toggle the collapsible sidebar category &#x27;Clean Architecture&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/sg/fenix-architecture/">鳳凰架構</a><button aria-label="Toggle the collapsible sidebar category &#x27;鳳凰架構&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch0">Ch0: 前言</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch1">Ch1: 服務架構演進史</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch2">Ch2: 存取遠端服務</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch3">Ch3: 交易處理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch4">Ch4: 透明多級分流系統</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch4.5-6">Ch4.5~6: 負載均衡和服務端緩存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch5">Ch5: 架構安全性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch6">Ch6: 分佈式共識算法</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch7">Ch7: 從函式庫到服務</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/sg/fenix-architecture/ch8">Ch8: 流量治理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch9">Ch9: 可靠通信</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch10">Ch10: 可觀測性</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch11">Ch11: 虛擬化容器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch12">Ch12: 容器間網路</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch13">Ch13: 持久化存储</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch14">Ch14: 資源與調度</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch15">Ch15: 服務網格</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/sg/fenix-architecture/ch16">Ch16: 向微服務邁進</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/five-lines-of-code/">五行程式碼規則</a><button aria-label="Toggle the collapsible sidebar category &#x27;五行程式碼規則&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/fundamentals-of-software-architecture/">軟體架構原理 - 工程方法</a><button aria-label="Toggle the collapsible sidebar category &#x27;軟體架構原理 - 工程方法&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/sg/web-api-the-good-parts/">Web API: The Good Parts</a><button aria-label="Toggle the collapsible sidebar category &#x27;Web API: The Good Parts&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/sg/"><span itemprop="name">Study Group Notes</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/sg/fenix-architecture/"><span itemprop="name">鳳凰架構</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Ch8: 流量治理</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ch8: 流量治理</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="容錯性的設計應該被視為微服務架構設計預期就需要注意到的點">容錯性的設計應該被視為微服務架構設計預期就需要注意到的點<a href="#容錯性的設計應該被視為微服務架構設計預期就需要注意到的點" class="hash-link" aria-label="Direct link to 容錯性的設計應該被視為微服務架構設計預期就需要注意到的點" title="Direct link to 容錯性的設計應該被視為微服務架構設計預期就需要注意到的點">​</a></h2><p>應該把 process crash, 網路中斷, 當機這些狀況視為意料中。
原系統重構或使用分散式架構就是期望提高可用性，最低限度也應該保證分散式後最地限度的可用性不能下降，否則何必重做？</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="雪崩效應錯誤從一個點開始層層影響相關的微服務">雪崩效應：錯誤從一個點開始層層影響相關的微服務。<a href="#雪崩效應錯誤從一個點開始層層影響相關的微服務" class="hash-link" aria-label="Direct link to 雪崩效應：錯誤從一個點開始層層影響相關的微服務。" title="Direct link to 雪崩效應：錯誤從一個點開始層層影響相關的微服務。">​</a></h4><blockquote><p>如何防止雪崩效應就是容錯性設計原則的具體實踐，否則服務化越高系統越不穩定</p><p>防止雪崩效應 = 實踐容錯性設計，否則微服務架構 = 搬石頭砸自己的腳</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="堵塞未預期流量服務能力有限面臨超出預期的突發請求時需要很長的時間才恢復">堵塞/未預期流量：服務能力有限，面臨超出預期的突發請求時需要很長的時間才恢復。<a href="#堵塞未預期流量服務能力有限面臨超出預期的突發請求時需要很長的時間才恢復" class="hash-link" aria-label="Direct link to 堵塞/未預期流量：服務能力有限，面臨超出預期的突發請求時需要很長的時間才恢復。" title="Direct link to 堵塞/未預期流量：服務能力有限，面臨超出預期的突發請求時需要很長的時間才恢復。">​</a></h4><p>對以上的問題：服務容錯，流量控制解決。但這些方法的實踐需要與前面 registry, gateway, load balancer 配合。
所以本章說明他們的關聯＆工作原理。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>微服務 9 特徵</div><div class="admonitionContent_S0QG"><ol><li>圍繞事務建立</li><li>分散治理</li><li>自治的組件</li><li>產品思維</li><li>DB 去中心化</li><li>強終端，弱管道</li><li>容錯能力</li><li>可演進性</li><li>Infra 自動化</li></ol></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="服務容錯">服務容錯<a href="#服務容錯" class="hash-link" aria-label="Direct link to 服務容錯" title="Direct link to 服務容錯">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="容錯策略">容錯策略<a href="#容錯策略" class="hash-link" aria-label="Direct link to 容錯策略" title="Direct link to 容錯策略">​</a></h3><ul><li><strong>容錯策略：面對故障要怎麼處裡</strong></li><li>設計模式：如何實現容錯策略</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="故障轉移-failover">故障轉移 Failover<a href="#故障轉移-failover" class="hash-link" aria-label="Direct link to 故障轉移 Failover" title="Direct link to 故障轉移 Failover">​</a></h4><ul><li>對於重要的服務（經常被其他服所依赖）部署有多个副本，如果實際運行中原服務出現故障，系統自動切換到副本維持服務品質，而不會向 caller return 失敗</li><li>可能部署在不同 node, region</li><li>轉移需要有限制 ex.轉移次數 以防造成更多成本的消耗 or 轉移過程早已違反原 caller 的限制，即時回傳也是無效</li></ul><blockquote><p><img loading="lazy" alt="caller time limit" src="/assets/images/8-1-350dad821990eefeae3268cdb93face3.png" width="336" height="63" class="img_ev3q"></p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="快速失敗-failfast">快速失敗 Failfast<a href="#快速失敗-failfast" class="hash-link" aria-label="Direct link to 快速失敗 Failfast" title="Direct link to 快速失敗 Failfast">​</a></h4><ul><li>Failover 可以用於冪等的服務，但如果服務非冪等，遇到問題時就應儘速讓 caller 知道。“堅決避免重試，盡快拋出異常”</li></ul><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>idempotence 冪等性</div><div class="admonitionContent_S0QG"><p>數學：f(x) = f(f(x)) or f(n) = 1^n</p><p>軟體：對一同一個 api 發出多次同樣的請求，能保證實際只操作一次</p></div></div><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Mech 碎碎念</div><div class="admonitionContent_S0QG"><p>是否為冪等性的討論放在查詢類型的功能上沒有意義，應該把角度思索成怎麼把新增或是修改的功能修正成冪等性的</p></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="安全失敗-failsafe">安全失敗 Failsafe<a href="#安全失敗-failsafe" class="hash-link" aria-label="Direct link to 安全失敗 Failsafe" title="Direct link to 安全失敗 Failsafe">​</a></h4><ul><li>完整的服務流程通常包含主線任務和支線任務，有些支線任務沒打也可以去打王，所以對支線任務可以採用 failsafe 策略，即使支線任務失敗了也可暫時忽略</li><li>支線任務特性：沒有回傳值或回傳值不影響後續處理的結果</li><li>如果需要回傳值的話也可以還傳一個符合spec的空物件</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="沈默失敗-failsilent">沈默失敗 Failsilent<a href="#沈默失敗-failsilent" class="hash-link" aria-label="Direct link to 沈默失敗 Failsilent" title="Direct link to 沈默失敗 Failsilent">​</a></h4><ul><li>如果大量請求都需要等到超時後才失敗，很容易因為這些請求佔據大量的資源，進而影響整個系統的問定性。</li><li>當出現第一個失敗的請求的時候就當這個服務一段時間都不能用了，改調用其他服務，不再對他分配流量。</li><li>熔斷思路(?)</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="故障恢復-failback">故障恢復 Failback<a href="#故障恢復-failback" class="hash-link" aria-label="Direct link to 故障恢復 Failback" title="Direct link to 故障恢復 Failback">​</a></h4><ul><li>與 failfast 一起看</li><li>當服務出錯後將這次 request 失敗的資料塞進 queue 由系統再次消化，盡量讓失敗的 request 可以被正常執行。</li><li>冪等性，不需要即時響應的，用於對時效沒有嚴格限制的主線任務 or 不需 return 的支線任務</li><li>同 Failover 重試需要有限制</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="forking">Forking<a href="#forking" class="hash-link" aria-label="Direct link to Forking" title="Direct link to Forking">​</a></h4><ul><li>在錯誤發生前就考量怎麼做才有最大的成功可能性</li><li>一開始就呼叫多服務副本，只要一個成功就代表這個呼叫行為成功</li><li>以高成本換去成功的策略</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="broadcast">Broadcast<a href="#broadcast" class="hash-link" aria-label="Direct link to Broadcast" title="Direct link to Broadcast">​</a></h4><ul><li>同 Forking，但要每個都回傳成功才算是成功</li><li>Broadcast 通常用於 refresh distributed cache(?)</li></ul><p><img loading="lazy" alt="table" src="/assets/images/8-2-66cbf05f93ea27a6e2daea0b8066aa9e.png" width="1233" height="405" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="容錯設計模式">容錯設計模式<a href="#容錯設計模式" class="hash-link" aria-label="Direct link to 容錯設計模式" title="Direct link to 容錯設計模式">​</a></h3><ul><li>容錯策略：面對故障要怎麼處裡</li><li><strong>設計模式：如何實現容錯策略</strong></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="斷路器">斷路器<a href="#斷路器" class="hash-link" aria-label="Direct link to 斷路器" title="Direct link to 斷路器">​</a></h4><ul><li>Failfast</li><li>通過代理（斷路器對象）來一對一地(一個服務對應一個斷路器對象)接管服務 caller 的 request</li><li>斷路器會持續監控並統計服務返回的各種結果，當出現故障（失敗、超時、拒絕）的次數達到斷路器的閾值時，它狀態就自動變為“OPEN”，後續此斷路器代理的 request 都將直接返回調用失敗，而不會發出真正的 request。</li></ul><p><img loading="lazy" alt="斷路器工作時序" src="/assets/images/8-3-e3e4ced4a5b807252405eae37e61bd59.png" width="572" height="805" class="img_ev3q"></p><ul><li>斷路器就是一種有限狀態機，根據自身狀態變化自動調整代理請求策略。一般有三種狀態：<ul><li>CLOSED：表示斷路器關閉，此時 request 會真正發送給服務。</li><li>OPEN：表示斷路器開啟，此時不會進行真正 request，直接給服務 caller 返回調用失敗的信息。</li><li>HALF OPEN：這是一種中間狀態。當進入 OPEN 狀態一段時間以後，會放行一次遠程調用，然後根據這次調用的結果成功與否，轉換為 CLOSED 或者 OPEN 狀態，以實現斷路器的彈性恢復。</li></ul></li></ul><p><img loading="lazy" alt="斷路器狀態轉換" src="/assets/images/8-4-36a58eeee856c5541058eec30b5285ad.png" width="575" height="271" class="img_ev3q"></p><ul><li><p>閾值定義：在以下兩個條件<strong>同時</strong>滿足時，斷路器狀態轉變為 OPEN：</p><ul><li><p>一段時間（譬如 10 秒以內）內請求數量達到一定閾值（譬如 20 個請求）。這個條件的意思是如果請求本身就很少，那就用不著斷路器介入。</p></li><li><p>一段時間（譬如 10 秒以內）內請求的故障率（發生失敗、超時、拒絕的統計比例）到達一定閾值（譬如 50%）。這個條件的意思是如果請求本身都能正確返回，也用不著斷路器介入。</p><blockquote><blockquote><p>括號中舉例的數值是 Netflix Hystrix 的默認值，其他服務治理的工具，譬如 Resilience4j、Envoy 等也同樣會包含有類似的設置。</p></blockquote></blockquote></li></ul></li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Discuess</div><div class="admonitionContent_S0QG"><p>Ｑ：斷路器是 Failfast 或是 Failsilent?</p><p>Ａ：沒人回答。Failfast：因為他代理了服務快速的回覆“壞了”。Failsilent：第一個失敗的請求就不再給後面的服務。</p><p>Ｑ：兩個 client 的角色呼叫一個 server 的角色，斷路器會有幾個？</p><p>Ａ：看你要保護什麼。以保護 DB 的例子來說是保護 DB，所以斷路器就一個。client 也可以自己做斷路器。想成 k8s 的 service ex. nginxs, Envoy 可以限制 in-bound and out-bound </p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>熔斷 V.S 降級</div><div class="admonitionContent_S0QG"><p>A -&gt; B</p><p>B熔斷後A可能需要降級</p><p>下游服務回復了故障訊息给上游服務後，上游服務必須主動<strong><em>處理</em></strong>呼叫失敗的後果，而不能讓故障擴散。</p><p><strong>處理</strong>就是服務降級的演算法，他不只包含使用者介面的通知，還需要盡力的去透過其他路徑解決問題，ex.重試就是最低限度的降級邏輯</p><p>服務降級不一定要在錯誤發生後被動執行，他可能是主動執行的 ex.定期停機 or 可預期的流量高峰，這就屬於下面的流量控制</p></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="艙壁隔離">艙壁隔離<a href="#艙壁隔離" class="hash-link" aria-label="Direct link to 艙壁隔離" title="Direct link to 艙壁隔離">​</a></h4><ul><li>Failsilent</li><li>不讓某一個服務的局部失敗演變成全局性的影響，就必須設置某種止損方案，這便是服務隔離的意義。<ul><li>雞蛋不要放在同一個籃子</li><li>目前主流的 network access 是以 Thread per Request 來實現，只要請求一直不結束，就要一直佔用著某個 thread 不能釋放，而 thread is global resource</li></ul></li><li>為每個服務單獨設立 thread pool，這些 thread pool 只用來控制單個服務的最大連接數，也就是當這個服務因超時故障時就只會最多阻塞 thread pool 內的連線，而不至於影響全局的連線數</li><li>使用局部的 thread pool 來控制服務的最大連接數有許多好處，當服務出問題時能夠隔離影響，當服務恢復後，還可以通過清理掉局部 thread pool，瞬間恢復該服務的功能</li><li>但是局部 thread pool 增加了 CPU 的開銷，每個獨立的 thread pool 都要進行排隊、調度和下文切換工作</li><li>Semaphore 是一種可以用來控制服務最大連接數的辦法，並不需要建立局部 thread pool 只需要 counter，性能損耗可以忽略不計</li><li>在更宏觀的場景中，不是按調用 thread，可能是按功能、按子系統、按用戶類型等條件來隔離資源</li><li>一般來說，將服務層面的隔離實現在服務調用端或者 side car 代理上，將系統層面的隔離實現在 DNS 或者 gateway。</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="重試">重試<a href="#重試" class="hash-link" aria-label="Direct link to 重試" title="Direct link to 重試">​</a></h4><ul><li><p>實踐 Failover or Failback</p></li><li><p>解決系統中的瞬時故障</p><ul><li>有可能自己恢復（Resilient）的臨時性失靈</li><li>網絡抖動、服務的臨時過載（HTTP 503 Bad Gateway）</li></ul></li><li><p>重试模式面临的风险反而大多来源于太过简单而导致的滥用。</p></li><li><p>使用時機為下列條件<strong>同時</strong>滿足</p><ul><li>在主線任務的關鍵服務做<strong>同步</strong>的重試</li><li>只對於瞬時故障的失敗重試，至少不會是 HTTP 401 時重試<ul><li>功能完善的工具可以設定重試的演算法 ex.Retry Policy in Envoy 可以根據各種具體條件來設定不同的重試参數，其中就包含了 HTTP response status code</li></ul></li><li>只對冪等性的服務 or api 重試，ex. RESTful api POST、PUT、DELETE 通常是非幂等的，而 GET、HEAD、OPTIONS、TRACE 應該被設計成幂等的</li><li>有明確的終止條件<ul><li>最久時間：同 Failover 的例子</li><li>最大次數：通常最多 2 ~ 5，注意 response header 是否有帶 Retry-After</li></ul></li></ul></li><li><p>重試可能對系統帶來很大的負擔，因為重試可以在整個服務網路的多個環節去重試，ex.start from user client、gateway、load balancer，另外現在的微服務框架都很方便</p><blockquote><blockquote><p>Netflix OSS 如果同時在 Zuul、Feign 和 Ribbon 上都打开了重試功能，且不考虑重試被超時终止的话，那總重試次數就是每個部分次數的乘機。假設他們都重試 4 次，且 Ribbon 可以轉移 4 个服務副本，理論上就會執行 4×4×4×4=256 次。</p></blockquote></blockquote></li></ul><p>以上的設計模式都仰賴開發人員對服務邏輯的了解 &amp; 運維人員的經驗去靜態調整配置參數和閾值，但不足以應付 Auto Scale 的大型分佈式系統。
需要系統不僅可以自動依據負載來調整數量規模，還要有能力<strong>根據服務被使用的統計結果，或者啟發式搜索的結果來自動變更容錯策略和參數</strong>，但這方面研究還處於摸索的階段，是服務治理的發展方向之一。</p><p>以上策略與設計目的是<strong>避免雪崩效應</strong>，但只讓故障不擴散不夠。我們要讓系統或至少核心功能能主動掌握流量決定服務量。</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>啟發式搜索</div><div class="admonitionContent_S0QG"><p>在解決問題的過程中，藉由啟發函數來量化目前解法與預期解決的目標的距離，進而增加解決方法的效率。</p></div></div><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>短板效應</div><div class="admonitionContent_S0QG"><p>又稱木桶效應，影響一個團隊的關鍵因子，不在於團隊裡最強的人，而是程度最落後的那一位。
一套服務群裡面會影響到整個服務可用性的是效能最低的那個。</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="流量控制">流量控制<a href="#流量控制" class="hash-link" aria-label="Direct link to 流量控制" title="Direct link to 流量控制">​</a></h2><p>當系統資源不足以支撐外部超過預期的突發流量時，建立自我保護的機制：限流。</p><ul><li>依據什麼限流：是否要控制，控制哪些流量，控制力度多大。通常需要一段時間營運來動態決定</li><li>如何限流</li><li>超額的流量如何處理：429 (否決式限流) or 讓請求排隊 (阻塞式限流)</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="流量統計指標">流量統計指標<a href="#流量統計指標" class="hash-link" aria-label="Direct link to 流量統計指標" title="Direct link to 流量統計指標">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="transactions-per-secondtps">Transactions per Second(TPS)<a href="#transactions-per-secondtps" class="hash-link" aria-label="Direct link to Transactions per Second(TPS)" title="Direct link to Transactions per Second(TPS)">​</a></h4><ul><li>Transactions 具備原子性的操作邏輯</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="hits-per-secondhps">Hits per Second(HPS)：<a href="#hits-per-secondhps" class="hash-link" aria-label="Direct link to Hits per Second(HPS)：" title="Direct link to Hits per Second(HPS)：">​</a></h4><ul><li>hit = request</li><li>如果一個 request 就可以完成所有操作邏輯，TPS = HPS</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="queries-per-secondqps">Queries per Second(QPS)<a href="#queries-per-secondqps" class="hash-link" aria-label="Direct link to Queries per Second(QPS)" title="Direct link to Queries per Second(QPS)">​</a></h4><ul><li>一台 server 可以響應的查詢次數</li><li>如果整個系統只有一台 server，HPS = QPS</li><li>在分散式系統裡，一個業務邏輯操作你會向多個 server 發出 request，也就有多個 query</li></ul><p>TPS 是我們最直覺實際衡量流量的指標。因為我們不會要使用者來去理解他買本書打了多少個 api 用了幾個 server。</p><p>但實際上不同功能操作對於系統的壓力不同，無法類比，生活應用也不是壓力測試不會有固定腳本自動化執行，還要配合著神奇的 UX。</p><p>所以主流還是用 HPS 作為指標，因為他相對容易觀察，並可以反應系統當下與接下來一段時間的壓力走向。</p><p>不過限流指標沒有標準，實際可以根據系通需求定義。ex.同時在線人數 or 單位時間上下檔案大小</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="限流設計模式">限流設計模式<a href="#限流設計模式" class="hash-link" aria-label="Direct link to 限流設計模式" title="Direct link to 限流設計模式">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="counter">Counter<a href="#counter" class="hash-link" aria-label="Direct link to Counter" title="Direct link to Counter">​</a></h4><ul><li>設置一個計算器，根據當下的計數是否超過閾值來決定是否限流</li><li>它並不嚴謹，它只是針對時間點進行離散的統計<ul><li>每一秒計數器都沒有超過閾值，也不代表系統沒有遇到過大於閾值的壓力</li><li>即使連續若干秒都超過了閾值，也不能代表流量壓力就一定超過了系統的承受能力</li></ul></li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Mech 碎碎念</div><div class="admonitionContent_S0QG"><p>Counter 是由某個非接受 request 的 cron job 去 clean cache 裡面記錄的東西</p></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sliding-window">Sliding Window<a href="#sliding-window" class="hash-link" aria-label="Direct link to Sliding Window" title="Direct link to Sliding Window">​</a></h4><ul><li>以 Sliding Window 統計服務請求的數量，控制 request 不會超過限流的閾值</li><li>演算法：<ul><li>定義 Window 總大小(時間長度) &amp; 統計週期(時間長度) &amp; 閾值(X時間長度的Ｙ項指標)</li><li>定期在每個統計週期執行以下動作<ol><li>將最後一位的數組丟掉，元素都往後移一位，然後在開頭插入一個新的空元素 =&gt; slide window</li><li>將計數器中所有統計的數字寫入到開頭的空元素中</li><li>對數組中所有元素進行統計，並 reset 計數器數據供下一個統計週期使用</li></ol></li><li><img loading="lazy" alt="sliding window" src="/assets/images/sliding_window-a4f43f2c8a553e5973e9eb7102881fd7.png" width="1698" height="612" class="img_ev3q"></li></ul></li><li>只適用於否決式限流，超過閾值的流量就必須強制失敗或降級，很難在細粒度上對流量曲線進行整形，無法削峰填谷</li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Discuess</div><div class="admonitionContent_S0QG"><p>Sliding Window 分成兩種</p><p>Sliding Window Counter: 用更小的力度去做 counter</p><p>Sliding Window Log: server 收到 request 的時候去比較與前一個 request 的時間差，以及這端時間內的 request 數量是否到達閥值</p><p>from System Design Interview – An insider&#x27;s guide</p></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="leaky-bucket">Leaky Bucket<a href="#leaky-bucket" class="hash-link" aria-label="Direct link to Leaky Bucket" title="Direct link to Leaky Bucket">​</a></h4><ul><li>Traffic Shaping：限製網路設備的流量突變，使得 context 以比較均勻的速度向外發送，通常都需要用到緩衝區來實現</li><li>Leaky Bucket Algorithm &amp; Token Bucket Algorithm 為了達成 Traffic Shaping</li><li>演算法：<ul><li>請求 = 水</li><li>緩衝區 = 池子</li><li>處理 = 水流出</li><li>水都先放進池子裡再慢慢流出，不過請求總是有時限的，所以緩衝區大小也必須是有限度</li><li>池子滿了 = 有部分請求會遭遇失敗和降級。流量整形的角度來說是部分數據包被丟棄</li><li><img loading="lazy" alt="leaky bucket" src="/assets/images/leaky_bucket-63058508e2a871264e011e3ece1b0003.png" width="750" height="227" class="img_ev3q"></li></ul></li><li>通常以 FIFO Queue 作為緩衝區，控制池子大小與消化速度，消化速度通常是固定的，池大 = 還是可能遇到流量太大問題，池小 = 誤殺掉一部分正常的請求</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="token-bucket">Token Bucket<a href="#token-bucket" class="hash-link" aria-label="Direct link to Token Bucket" title="Direct link to Token Bucket">​</a></h4><ul><li>Leaky Bucket 以流出水來代表處理需求，而流出水的速度是固定的。Token Bucket 以放入多少 token 來代表可以處理多少需求</li><li>演算法：<ol><li>系統決定限流閥值後定期向 bucket 放入 token。 ex. 100 request/second =&gt; 每個 token 放入 bucket 的間隔為 1/100=10 毫秒</li><li>bucket 可放的 token 有最大數量上限，多的會丟掉。最大數量上限由時限和服務處理能力共同決定的</li><li>當有請求進來時，首先要從 bucket 中取得一個准入的 token，然後才能進入系統處理，當需求發現 bucket 沒有 token 的時候就代表他遭遇失敗和降級</li></ol></li><li><img loading="lazy" alt="token bucket" src="/assets/images/token_bucket-cdda80c20626b0fc993745febeecb049.png" width="750" height="574" class="img_ev3q"></li><li>在 token 中增加一個 timestamp，每次獲取 token 前，比較一下 timestamp 與當前時間，就可以計算出這段時間需要放多少 token 進去</li></ul><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>Discuess</div><div class="admonitionContent_S0QG"><p>Ｑ：Token 由誰放回去？
Ａ：由設計決定，可以是定時把新 token 放到桶子裡去，也可以是前面處理完的人再把 token 還回桶子去。</p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分散式限流">分散式限流<a href="#分散式限流" class="hash-link" aria-label="Direct link to 分散式限流" title="Direct link to 分散式限流">​</a></h3><ul><li><p>微服務架構下，前面的限流設計模式就最多只能應用於集群最入口處的 gateway 上，對整個服務集群進行流量控制，而無法細粒度地管理流量在內部微服務節點中的流轉情況</p></li><li><p>能夠精細控制分散式集群中每個服務消耗量的限流算法才是分散式限流，需要讓各個服務節點的協同限流</p></li><li><p>只要可以共享統計數據，原本用於單機的限流模式理論上也是可以應用於分佈式環境中</p><ul><li>將所有服務的流量統計指標結果都存入集中式 cache 中</li><li>並通過分佈式鎖、信號量等機制，解決這些數據的讀寫訪問時並發控制的問題</li><li>代價是每次服務調用都必須要額外增加一次網絡開銷，所以流量壓力大時，限流本身反倒會顯著降低系統的處理能力</li></ul></li><li><p>修改 Token Bucket</p><ul><li><p>當 request 進入 cluster 前在 gateway 取得一定數額的 token 作為“貨幣”</p></li><li><p>不同等級 client 可能有不同初始額度</p></li><li><p>每個服務時都要求消耗一定量的“貨幣”額度</p></li><li><p>剩餘額度小於等於 0 時，就不再允許訪問其他服務了</p></li><li><p>此時必須先發生一次網絡請求，重新向 Token Bucket 申請一次額度，成功後才能繼續訪問，不成功則進入降級邏輯</p><blockquote><blockquote><p><img loading="lazy" alt="内部限流的指标計算方法" src="data:image/png;base64,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" width="267" height="61" class="img_ev3q"></p><p>A 的額度 QuanityA</p><p>服務 X 要消耗的額度 CostX</p><p>A 訪問了 N 個服務以後，他剩餘的額度 LimitN</p></blockquote></blockquote></li><li><p>剩餘額度 LimitN 就可以作為內部限流的指標</p></li><li><p>可能存在業務操作已經執行到一半，卻無法從 Token Bucket 中再獲取到新額度而失敗，這種失敗的代價是比較高昂的，它浪費了部分已經完成了的服務資源，但 Z &gt; B</p></li></ul></li><li><p>分散式系統容錯是必須要有的，但分散式限流從不追求“越徹底越好”，往往需要權衡方案的代價與收益</p></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/NoobTechNote/NoobTechNote.github.io/tree/main/docs/sg/fenix-architecture/ch8.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2024-01-21T14:20:22.000Z">Jan 21, 2024</time></b> by <b>ChenTsungYu</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/sg/fenix-architecture/ch7"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Ch7: 從函式庫到服務</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/sg/fenix-architecture/ch9"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ch9: 可靠通信</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#容錯性的設計應該被視為微服務架構設計預期就需要注意到的點" class="table-of-contents__link toc-highlight">容錯性的設計應該被視為微服務架構設計預期就需要注意到的點</a></li><li><a href="#服務容錯" class="table-of-contents__link toc-highlight">服務容錯</a><ul><li><a href="#容錯策略" class="table-of-contents__link toc-highlight">容錯策略</a></li><li><a href="#容錯設計模式" class="table-of-contents__link toc-highlight">容錯設計模式</a></li></ul></li><li><a href="#流量控制" class="table-of-contents__link toc-highlight">流量控制</a><ul><li><a href="#流量統計指標" class="table-of-contents__link toc-highlight">流量統計指標</a></li><li><a href="#限流設計模式" class="table-of-contents__link toc-highlight">限流設計模式</a></li><li><a href="#分散式限流" class="table-of-contents__link toc-highlight">分散式限流</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024. DEX Study Group</div></div></div></footer></div>
<script src="/assets/js/runtime~main.e984117f.js"></script>
<script src="/assets/js/main.10b554c0.js"></script>
</body>
</html>