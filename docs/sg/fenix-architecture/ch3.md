---
title: 'Ch3: äº‹å‹™è™•ç†'
tsidebar_label: 'Ch3: äº‹å‹™è™•ç†'
sidebar_position: 3
---

# äº¤æ˜“è™•ç† (Transaction)
ä¸€å€‹æ‡‰ç”¨ç¨‹å¼çš„ç³»çµ±å¯èƒ½é‡åˆ°çš„å¹¾ç¨®éŒ¯èª¤ï¼š
- è³‡æ–™åº«æ•…éšœ
- æ‡‰ç”¨ç¨‹å¼å´©æ½°
- æ‡‰ç”¨ç¨‹å¼èˆ‡è³‡æ–™åº«é–“çš„ç¶²è·¯é€£ç·šä¸­æ–·
- ~~å„ç¨®é¬¼æ•…äº‹~~......

è³‡æ–™åº«çš„äº¤æ˜“(Transaction)æ¶ˆé™¤è³‡æ–™æ˜¯å¦æ›´æ–°çš„ç–‘æ…®ï¼Œä¿®æ”¹è³‡æ–™å¿…é ˆæ»¿è¶³å®šç¾©å¥½çš„è¦å‰‡ï¼ŒåŒ…å«è³‡æ–™çš„å®Œæ•´æ€§ã€å¤±æ•—æ™‚è§¸ç™¼å›æ»¾ (rollback) ç­‰ç­‰ã€‚

**Transaction(TX):**
- SQL èªå¥çš„é›†åˆï¼Œè¦–ç‚ºä¸€å€‹å·¥ä½œå–®å…ƒï¼Œè³‡æ–™åº«è™•ç†çš„é‚è¼¯å–®ä½
- é€±æœŸï¼šBegin â†’ Commit (or Rollback)

:::infoç›®çš„
ä¿æŒè³‡æ–™åº«ä¸­è³‡æ–™ç‹€æ…‹çš„ã€Œä¸€è‡´æ€§ã€**C**onsistency
:::

è³‡æ–™åº«çš„ç¶“å…¸ç†è«–ï¼ŒTX å…·å‚™çš„ç‰¹æ€§ï¼š
- **åŸå­æ€§**ï¼ˆ**A**tomicï¼‰: æ¯å€‹ TX æœ‰å…©ç¨®å¯èƒ½çµæœ â†’ å…¨éƒ¨åŸ·è¡ŒæˆåŠŸ or å…¨éƒ¨å¤±æ•—ä¸åŸ·è¡Œ(åªè¦å…¶ä¸­ä¸€å€‹å¤±æ•—å°±è®“ä¿®æ”¹çš„è³‡æ–™å…¨éƒ¨ rollback åˆ° TX é–‹å§‹å‰çš„ç‹€æ…‹)
- **éš”é›¢æ€§**ï¼ˆ**I**solationï¼‰ï¼š ç¢ºä¿æ¯å€‹ TX åœ¨é€²è¡Œæ™‚ä¸æœƒäº’ç›¸å¹²æ“¾
- **æŒä¹…æ€§ï¼ˆD**urabilityï¼‰: TX ä¿è­‰æ‰€æœ‰æˆåŠŸè¢« commit çš„è³‡æ–™ä¿®æ”¹éƒ½èƒ½å¤ æ­£ç¢ºåœ°è¢«æ°¸ä¹…å„²å­˜(æˆåŠŸå¯«åˆ°ç¡¬ç¢Ÿæˆ– SSD ä¸Š)

:::infoè£œå……
å„²å­˜é» (save point):

SAVEPOINT æŒ‡ä»¤å®šç¾©ä¸€å€‹ TX å„²å­˜é»ï¼Œå…è¨±å–æ¶ˆéƒ¨ä»½TXï¼Œè€Œåªæäº¤(commit)å‰©é¤˜çš„éƒ¨ä»½ï¼Œå¯ä»¥åœ¨äº¤æ˜“ä¸­æ’å…¥å„²å­˜é»ï¼Œæœ‰éœ€è¦æ™‚å¯ä»¥ rollback åˆ°å„²å­˜é»ï¼Œè€Œä¸ç”¨ rollback æ•´å€‹ TXã€‚
:::

èˆ‰ä¾‹ï¼š
- éŠ€è¡Œè½‰å¸³
- è¦çš®è³¼ç‰©

TX çš„æ¦‚å¿µå»¶ä¼¸åˆ°æ‰€æœ‰éœ€è¦ä¿è­‰è³‡æ–™ä¸€è‡´æ€§çš„æ‡‰ç”¨å ´æ™¯ e.g. å¿«å–æ©Ÿåˆ¶ã€Message Queueã€åˆ†æ•£å¼çš„å„²å­˜æ¶æ§‹ã€‚

ä¸Šè¿°çš„æ‡‰ç”¨å ´æ™¯èˆ‡è³‡æ–™åº«çš„ TX ä¸€è‡´æ€§éå®Œå…¨ç›¸åŒçš„æ¦‚å¿µï¼š
- å…§éƒ¨ä¸€è‡´æ€§ï¼šä¸€å€‹æœå‹™ä½¿ç”¨ä¸€å€‹è³‡æ–™æºï¼Œé€é Aã€Iã€D ä¾†ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
- å¤–éƒ¨ä¸€è‡´æ€§ï¼šä¸€å€‹æœå‹™ä½¿ç”¨å¤šå€‹è³‡æ–™æºã€å¤šå€‹æœå‹™ä½¿ç”¨å¤šå€‹ä¸åŒè³‡æ–™æºï¼Œæ¶‰åŠå¤šå€‹è³‡æ–™æºçš„ TX ä¸€è‡´æ€§ â†’ åˆ†æ•£å¼ç³»çµ±é‡åˆ°çš„é›£é¡Œ

è³‡æ–™ä¸€è‡´æ€§åˆ†ä¸‰ç¨®ç‰¹æ€§:
- å¼·ä¸€è‡´æ€§ï¼šå¯«å®Œä¹‹å¾Œï¼Œä»»ä½•è®€å–çš„è³‡æ–™éƒ½æ˜¯æœ€æ–°çš„å€¼
- å¼±ä¸€è‡´æ€§ï¼šå¯«å®Œä¹‹å¾Œï¼Œç„¡æ³•ä¿è­‰éƒ½èƒ½è®€å–åˆ°æœ€æ–°çš„è³‡æ–™
- æœ€çµ‚ä¸€è‡´æ€§(å¾Œé¢è«‡ CAP ç†è«–)ï¼šå¯«å®Œä¹‹å¾Œï¼Œæœ€å¾Œä¸€å®šèƒ½è®€åˆ°æœ€æ–°çš„å€¼

## 3.1ã€€æœ¬åœ°äº¤æ˜“(Local Transaction)
åˆä½œã€ŒLocal Transactionã€ï¼Œé©ç”¨æ–¼å–®å€‹æœå‹™ä½¿ç”¨å–®å€‹è³‡æ–™æºçš„å ´æ™¯ã€‚

å¯¦ç¾åŸç†æºè‡ªæ–¼ [ARIES](https://en.wikipedia.org/wiki/Algorithms_for_Recovery_and_Isolation_Exploiting_Semantics) ç†è«–ï¼Œç¾ä»£é—œä¿‚å‹è³‡æ–™åº«çš„ç†è«–åŸºç¤ã€‚
## 3.1.1 å¯¦ç¾åŸå­æ€§å’ŒæŒä¹…æ€§
æ»¿è¶³åŸå­æ€§å’ŒæŒä¹…æ€§çš„æœ€å¤§å›°é›£é»ï¼š
ã€Œå¯«å…¥ç¡¬ç¢Ÿã€é€™å€‹å‹•ä½œä¸¦éåŸå­çš„ï¼Œé™¤äº†æœ‰ã€Œå¯«å…¥ã€èˆ‡ã€Œæœªå¯«å…¥ã€ç‹€æ…‹ï¼Œé‚„å­˜åœ¨ã€Œæ­£åœ¨å¯«ã€åå‘ä¸­é–“çš„ç‹€æ…‹ã€‚

å¯èƒ½ç™¼ç”Ÿå¹¾ç¨®æƒ…å½¢ï¼š

**æœªæäº¤ TXï¼Œå¯«å…¥å¾Œ crash**:

æ‡‰ç”¨ç¨‹å¼é‚„æ²’ä¿®æ”¹å®Œè³‡æ–™ï¼Œä½†è³‡æ–™åº«å·²å°‡éƒ¨åˆ†è³‡æ–™çš„è®Šå‹•å¯«å…¥ç¡¬ç¢Ÿï¼Œç™¼ç”Ÿæ•…éšœçš„ç‹€æ³ï¼Œç¶“é‡å•Ÿå¾Œï¼Œè³‡æ–™åº«å¿…é ˆè¦æœ‰è¾¦æ³•å¾—çŸ¥æ•…éšœå‰ç™¼ç”Ÿéä¸€æ¬¡ã€Œä¸å®Œæ•´ã€çš„æ“ä½œï¼Œå°‡å·²ä¿®æ”¹éçš„è³‡æ–™å¾ç¡¬ç¢Ÿä¸­æ¢å¾©æˆæ²’æœ‰æ”¹éçš„æ¨£å­ï¼Œç¢ºä¿åŸå­æ€§ã€‚
    
**å·²æäº¤ TXï¼Œå¯«å…¥å‰ crash**:

æ‡‰ç”¨ç¨‹å¼ä¿®æ”¹å®Œæ‰€æœ‰è³‡æ–™ä¸¦å®Œæˆ commitï¼Œä½†è³‡æ–™åº«é‚„æœªå°‡æ‰€æœ‰è®Šå‹•è³‡æ–™å¯«å…¥ç¡¬ç¢Ÿï¼Œç™¼ç”Ÿæ•…éšœæ™‚ç¶“éé‡å•Ÿï¼Œè³‡æ–™åº«å¿…é ˆå°‡æœªå®Œæˆçš„è³‡æ–™é‡æ–°å¯«å…¥ç¡¬ç¢Ÿï¼Œæ»¿è¶³æŒä¹…æ€§ã€‚

### Commit Logging 
ä»¥ã€Œæ—¥èªŒã€çš„å½¢å¼ä¾åºå°‡ä¿®æ”¹è³‡æ–™çš„æ“ä½œåŒ…å«çš„æ‰€æœ‰è¨Šæ¯(e.g. ä¿®æ”¹å“ªç­†è³‡æ–™ã€è³‡æ–™ä¿å­˜åœ¨ç¡¬ç¢Ÿè£¡çš„å“ªå€‹å€å¡Šç­‰)ï¼Œéƒ½å…ˆè¨˜éŒ„åˆ°ç¡¬ç¢Ÿè£¡ï¼Œä¿éšœè³‡æ–™æŒä¹…æ€§ã€åŸå­æ€§å…©å€‹ç‰¹æ€§ã€‚

åªæœ‰åœ¨ commit log æˆåŠŸç´€éŒ„åœ¨ç¡¬ç¢Ÿè£¡ï¼Œè³‡æ–™åº«åœ¨æ—¥èªŒä¸­çœ‹åˆ°ä»£è¡¨ TX æˆåŠŸçš„æäº¤ç´€éŒ„ï¼ˆCommit Recordï¼‰å¾Œï¼Œæ‰æœƒæ ¹æ“šæ—¥èªŒä¸Šçš„è¨Šæ¯å°çœŸæ­£çš„è³‡æ–™é€²è¡Œä¿®æ”¹ã€‚

ä¿®æ”¹å®Œæˆå¾Œï¼Œåœ¨æ—¥èªŒä¸­åŠ å…¥ä¸€æ¢â€œçµæŸè¨˜éŒ„â€ ï¼ˆEnd Recordï¼‰è¡¨ç¤º TX æ»¿è¶³æŒä¹…æ€§ã€‚

#### æ—¥èªŒä¸€æ—¦æˆåŠŸå¯«å…¥æäº¤ç´€éŒ„(Commit Record): 

æ•´å€‹ TX è¦–ç‚ºæˆåŠŸï¼Œå³ä¾¿çœŸæ­£ä¿®æ”¹è³‡æ–™æ™‚ç™¼ç”Ÿæ•…éšœï¼Œè³‡æ–™åº«é‡å•Ÿå¾Œæ ¹æ“šå·²ç¶“å¯«å…¥ç¡¬ç¢Ÿçš„æ—¥èªŒé€²è¡Œæ¢å¾©ã€ç¹¼çºŒä¿®æ”¹è³‡æ–™å³å¯ï¼Œä¿è­‰æŒä¹…æ€§ã€‚
#### æ—¥èªŒæ²’æœ‰æˆåŠŸå¯«å…¥æäº¤ç´€éŒ„(Commit Record)å°±ç™¼ç”Ÿæ•…éšœï¼š 

æ•´å€‹ TX å°±æ˜¯å¤±æ•—çš„ï¼Œè³‡æ–™åº«é‡å•Ÿå¾Œæœƒçœ‹åˆ°ä¸€éƒ¨åˆ†æ²’æœ‰ commit ç´€éŒ„çš„æ—¥èªŒï¼Œæ¨™è¨˜ç‚º rollback ç‹€æ…‹ï¼Œé€€å›åˆ° TX é–‹å§‹ä¹‹å‰ï¼Œä¿è­‰åŸå­æ€§ã€‚

**ç¼ºé™·ï¼š**

å½±éŸ¿è³‡æ–™åº«çš„æ•ˆèƒ½ã€‚

### Solution: Write-Ahead Logging(WAL)
> åˆä½œã€Œé å¯«æ—¥èªŒã€ï¼Œå…è¨±åœ¨ TX commit ä¹‹å‰ï¼Œæå‰å¯«å…¥è®Šå‹•è³‡æ–™ã€‚

å¯«å…¥è®Šå‹•è³‡æ–™çš„æ™‚é–“é»ä»¥ TX commit æ™‚ç‚ºç•Œå»åŠƒåˆ†ï¼Œåˆ†ä½œ `FORCE` å’Œ `STEAL` å…©é¡ï¼š
- `FORCE` :  TX commit ä¹‹ã€Œå¾Œã€
    - è¦æ±‚è®Šå‹•è³‡æ–™å¿…é ˆåŒæ™‚å®Œæˆå¯«å…¥å‰‡ç¨±ç‚º `FORCE`
    - ä¸å¼·åˆ¶é ˆåŒæ™‚å®Œæˆå¯«å…¥å‰‡ç¨±ç‚º `NO-FORCE`
- `STEAL` : TX commit ä¹‹ã€Œå‰ã€
    - å…è¨±è®Šå‹•è³‡æ–™æå‰å¯«å…¥ç¨±ç‚º `STEAL`
    - ä¸å…è¨±è®Šå‹•è³‡æ–™æå‰å¯«å…¥ç¨±ç‚º `NO-STEAL`

**LSNâ€“Log (Log Sequence Number Log)**
æ¯æ¢ WAL log éƒ½æœƒå¸¶æœ‰ä¸€ä¸²åºè™Ÿï¼Œç¨±ä½œ [LSN] (Log Sequence Number)ï¼Œç´€éŒ„ TX æ”¹å‹•å…§å®¹ã€‚

WAL æä¾›é¡å¤–çš„æ©Ÿåˆ¶: å¢åŠ  **Undo Log** çš„æ—¥èªŒé¡å‹ã€‚
#### Undo Logï¼š
åœ¨æ”¹å‹•çš„è³‡æ–™å¯«å…¥ç¡¬ç¢Ÿå‰ï¼Œé ˆå…ˆè¨˜éŒ„ Undo logï¼Œå¾ŒçºŒé‡åˆ°éœ€è¦ rollback æˆ–æ˜¯æ•…éšœçš„æƒ…æ³ï¼ŒæŠŠé€™äº› Undo log ç´€éŒ„å…§å®¹éƒ½æŠ¹é™¤æ‰ã€‚

#### Redo Logï¼š
ç´€éŒ„ä¿®æ”¹è³‡æ–™çš„æ“ä½œå…§å®¹ã€‚é‡åˆ°æ•…éšœæ™‚ï¼Œè—‰ç”± WAL å¯«å…¥çš„ TX Log ä¾†æ¢å¾©é‡åšã€‚

#### WAL æ•…éšœæ¢å¾©æ™‚æœƒåŸ·è¡Œä¸‰å€‹éšæ®µï¼š
- Analysis(åˆ†æ)ï¼šå¾ç¡¬ç¢Ÿè£¡å°‹æ‰¾æœ€å¾Œ(æ–°)ä¸€æ¬¡çš„æª¢æŸ¥é»(å·²æˆåŠŸåœ°å¯«å…¥ç¡¬ç¢Ÿè£¡æ»¿è¶³æŒä¹…åŒ–)ï¼Œé–‹å§‹å°æ—¥èªŒé€²è¡Œæƒæï¼Œæ‰¾å‡ºæ²’æœ‰çµæŸè¨˜éŒ„çš„ TXï¼Œçµ„æˆé›†åˆå¾…æ¢å¾©çš„ TXã€‚
- Redo(é‡åš)ï¼šåˆ†æéšæ®µä¸­ç”¢ç”Ÿçš„å¾…æ¢å¾©çš„ TX é›†åˆä¾†é‚„åŸç‹€æ…‹ã€‚
- Undo(å›æ»¾)ï¼šç¶“éåˆ†æã€é‡åšéšæ®µå¾Œå‰©é¤˜å¾…æ¢å¾©çš„ TX é›†åˆï¼Œå³éœ€è¦å›æ»¾çš„ TXï¼Œä¾ Undo Log å…§å®¹å°‡æå‰å¯«å…¥ç¡¬ç¢Ÿçš„è³‡æ–™æ”¹é‡æ–°å¯«å›å»ã€‚

![FORCE å’ŒSTEAL çš„å››ç¨®çµ„åˆé—œä¿‚](./ch3/ch3-1-2.png)

## 3.1.2 å¯¦ç¾éš”é›¢æ€§
è³‡æ–™åº«é‡åˆ°å¤šå€‹ TX çš„ä½µç™¼(Concurrency)å•é¡Œï¼š

ä»¥ä¸‹çš†ä»¥å‡å®šã€Œå…©å€‹ä¸¦è¡Œã€çš„ TX ç‚ºä¾‹

**Dirty Read:**

ä¸€å€‹ TX è™•ç†éç¨‹ä¸­è®€å–åˆ°å¦ä¸€å€‹ TX æœª `committed` çš„è³‡æ–™

**Phantom Read:**

å…©å€‹å®Œå…¨ç›¸åŒçš„ç¯„åœ TXï¼Œé€£çºŒå…©æ¬¡è®€å–æ™‚ï¼Œè®€å–å‡ºä¾†çš„ **ã€Œç­†æ•¸ã€** è·Ÿä¸Šæ¬¡ä¸åŒ

**Non-repeatable Read (Read Skew):**

åŒä¸€å€‹ Transaction ä¸­ï¼Œé‡è¤‡è®€å–æ™‚æœƒæ‹¿åˆ°ä¸ä¸€è‡´çš„è³‡æ–™

**Lost updates:**

TX1 çš„ UPDATE é­åˆ° TX2 è¦†å¯«ï¼Œå°è‡´æ›´æ–°çš„è³‡æ–™ä¸ä¸€æ¨£

> å¸¸è¦‹æ‰‹æ®µï¼šåŠ é–ğŸ”’
> - **å¯«é–ï¼ˆWrite Lock; Exclusive Lock -> X-Lockï¼‰ï¼š**
>   åªæœ‰æ‹¿åˆ°å¯«é–çš„ TX æ‰èƒ½å°è³‡æ–™åšå¯«å…¥ï¼Œæœªé‡‹æ”¾é–çš„éšæ®µï¼Œå…¶ä»– TX ä¸èƒ½å¯«å…¥è³‡æ–™ï¼Œä¹Ÿä¸èƒ½åŠ è®€é–
> - **è®€é–ï¼ˆRead Lock; Shared Lock -> S-Lockï¼‰ï¼š**
> å¤šå€‹ TX å¯å°åŒç­†è³‡æ–™åŠ å¤šå€‹è®€é–ï¼Œè¢«åŠ ä¸Šè®€é–çš„è³‡æ–™å°±ä¸èƒ½å†è¢«åŠ ä¸Šå¯«é–ï¼Œæ‰€ä»¥å…¶ä»– TX ä¸èƒ½å°è©²ç­†è³‡æ–™é€²è¡Œå¯«å…¥ï¼Œ
> ä½†ä»ç„¶å¯è®€å–ã€‚
> - **ç¯„åœé–ï¼ˆRange Lockï¼‰:**
> å°æ–¼æŸå€‹ç¯„åœç›´æ¥åŠ æ’ä»–é–ï¼Œåœ¨é€™å€‹ç¯„åœå…§çš„è³‡æ–™éƒ½ä¸èƒ½è¢«å¯«å…¥
> e.g.
>
```sql
SELECT * FROM purchases FOR UPDATE;
```

### å¸¸è¦‹çš„éš”é›¢å±¤ç´šï¼š
### Read Uncommitted
å…è¨±è®€å–å°šæœªè¢« `committed` çš„è³‡æ–™ï¼Œå±¬æ–¼æœ€ä½å±¤ç´šã€‚

é–çš„çµ„åˆï¼šå¯«é–
### Read Committed
åªå…è¨±è®€å–å·²è¢« `committed` çš„è³‡æ–™ï¼Œå¯è§£æ±º Dirty Read çš„å•é¡Œã€‚

é–çš„çµ„åˆï¼šå¯«é–+è®€é–(è®€å®Œä¹‹å¾Œé‡‹æ”¾é–)
### Repeatable Read 
è®€åˆ°çš„è³‡æ–™åªæœƒæ˜¯ transaction é–‹å§‹å‰å·²ç¶“ `committed` çš„è³‡æ–™ï¼Œä¸æœƒè®€å–åˆ°å°šæœª `committed` çš„è³‡æ–™ï¼Œæˆ–è€…åœ¨ TX æœŸé–“è¢«å…¶ä»–ä¸¦è¡Œçš„ TX å®Œæˆ `committed` çš„è®Šæ›´

é–çš„çµ„åˆï¼šå¯«é–+è®€é–(æŒçºŒ)
### Serializable
æ¡åºåˆ—åŒ–ï¼Œæœ€åš´æ ¼çš„éš”é›¢å±¤ç´šï¼Œå¤šå€‹ TXs è®Šæˆä¸€å€‹å€‹ã€Œæ¥çºŒåŸ·è¡Œã€ï¼Œæ•ˆèƒ½ä¹Ÿæœ€å·®ã€‚

é–çš„çµ„åˆï¼šå¯«é–+è®€é–+ç¯„åœé–

**TX è€—æ™‚ç¨‹åº¦:**

SERIALIZABLE > REPEATABLE READ > READ COMMITTED > READ UNCOMMITTED

### Snapshot(MVCC)
å°æ¯å€‹ç”¢ç”Ÿçš„æ–°è³‡æ–™åš snapshotï¼Œç”¢ç”Ÿä¸€å€‹æ–°ç‰ˆæœ¬ï¼ŒåŒæ™‚ä¿ç•™èˆŠçš„ç‰ˆæœ¬ï¼Œå…è¨± TX è®€å–é€™äº› snapshot çš„æœ€æ–°ç‰ˆæœ¬ => Multi-Version Concurrency Control (MVCC) çš„æ–¹å¼å¯¦ç¾
- å¥½è™•: ä¸é ˆåœ¨è³‡æ–™è¡¨è£¡è¨­ç½®é–(lock)ä¾†é¿å…è¡çª
- ç¼ºé»: æ¯ç­†ç´€éŒ„éƒ½éœ€è¦é¡å¤–çš„å„²å­˜ç©ºé–“

:::info Discussion
æ¨‚è§€é–ï¼ˆOptimistic Lockingï¼‰vs. æ‚²è§€é–ï¼ˆPessimistic Lockingï¼‰
:::
## 3.2 å…¨å±€äº¤æ˜“
