---
title: 'Ch3: äº‹å‹™è™•ç†'
tsidebar_label: 'Ch3: äº‹å‹™è™•ç†'
sidebar_position: 3
---

# äº¤æ˜“è™•ç† (Transaction)
ä¸€å€‹æ‡‰ç”¨ç¨‹å¼çš„ç³»çµ±å¯èƒ½é‡åˆ°çš„å¹¾ç¨®éŒ¯èª¤ï¼š
- è³‡æ–™åº«æ•…éšœ
- æ‡‰ç”¨ç¨‹å¼å´©æ½°
- æ‡‰ç”¨ç¨‹å¼èˆ‡è³‡æ–™åº«é–“çš„ç¶²è·¯é€£ç·šä¸­æ–·
- ~~å„ç¨®é¬¼æ•…äº‹~~......

è³‡æ–™åº«çš„äº¤æ˜“(Transaction)æ¶ˆé™¤è³‡æ–™æ˜¯å¦æ›´æ–°çš„ç–‘æ…®ï¼Œä¿®æ”¹è³‡æ–™å¿…é ˆæ»¿è¶³å®šç¾©å¥½çš„è¦å‰‡ï¼ŒåŒ…å«è³‡æ–™çš„å®Œæ•´æ€§ã€å¤±æ•—æ™‚è§¸ç™¼å›žæ»¾ (rollback) ç­‰ç­‰ã€‚

**Transaction(TX):**
- SQL èªžå¥çš„é›†åˆï¼Œè¦–ç‚ºä¸€å€‹å·¥ä½œå–®å…ƒï¼Œè³‡æ–™åº«è™•ç†çš„é‚è¼¯å–®ä½
- é€±æœŸï¼šBegin â†’ Commit (or Rollback)

:::infoç›®çš„
ä¿æŒè³‡æ–™åº«ä¸­è³‡æ–™ç‹€æ…‹çš„ã€Œä¸€è‡´æ€§ã€**C**onsistency
:::

è³‡æ–™åº«çš„ç¶“å…¸ç†è«–ï¼ŒTX å…·å‚™çš„ç‰¹æ€§ï¼š
- **åŽŸå­æ€§**ï¼ˆ**A**tomicï¼‰: æ¯å€‹ TX æœ‰å…©ç¨®å¯èƒ½çµæžœ â†’ å…¨éƒ¨åŸ·è¡ŒæˆåŠŸ or å…¨éƒ¨å¤±æ•—ä¸åŸ·è¡Œ(åªè¦å…¶ä¸­ä¸€å€‹å¤±æ•—å°±è®“ä¿®æ”¹çš„è³‡æ–™å…¨éƒ¨ rollback åˆ° TX é–‹å§‹å‰çš„ç‹€æ…‹)
- **éš”é›¢æ€§**ï¼ˆ**I**solationï¼‰ï¼š ç¢ºä¿æ¯å€‹ TX åœ¨é€²è¡Œæ™‚ä¸æœƒäº’ç›¸å¹²æ“¾
- **æŒä¹…æ€§ï¼ˆD**urabilityï¼‰: TX ä¿è­‰æ‰€æœ‰æˆåŠŸè¢« commit çš„è³‡æ–™ä¿®æ”¹éƒ½èƒ½å¤ æ­£ç¢ºåœ°è¢«æ°¸ä¹…å„²å­˜(æˆåŠŸå¯«åˆ°ç¡¬ç¢Ÿæˆ– SSD ä¸Š)

:::infoè£œå……
å„²å­˜é»ž (save point):

SAVEPOINT æŒ‡ä»¤å®šç¾©ä¸€å€‹ TX å„²å­˜é»žï¼Œå…è¨±å–æ¶ˆéƒ¨ä»½TXï¼Œè€Œåªæäº¤(commit)å‰©é¤˜çš„éƒ¨ä»½ï¼Œå¯ä»¥åœ¨äº¤æ˜“ä¸­æ’å…¥å„²å­˜é»žï¼Œæœ‰éœ€è¦æ™‚å¯ä»¥ rollback åˆ°å„²å­˜é»žï¼Œè€Œä¸ç”¨ rollback æ•´å€‹ TXã€‚
:::

èˆ‰ä¾‹ï¼š
- éŠ€è¡Œè½‰å¸³
- è¦çš®è³¼ç‰©

TX çš„æ¦‚å¿µå»¶ä¼¸åˆ°æ‰€æœ‰éœ€è¦ä¿è­‰è³‡æ–™ä¸€è‡´æ€§çš„æ‡‰ç”¨å ´æ™¯ e.g. å¿«å–æ©Ÿåˆ¶ã€Message Queueã€åˆ†æ•£å¼çš„å„²å­˜æž¶æ§‹ã€‚

ä¸Šè¿°çš„æ‡‰ç”¨å ´æ™¯èˆ‡è³‡æ–™åº«çš„ TX ä¸€è‡´æ€§éžå®Œå…¨ç›¸åŒçš„æ¦‚å¿µï¼š
- å…§éƒ¨ä¸€è‡´æ€§ï¼šä¸€å€‹æœå‹™ä½¿ç”¨ä¸€å€‹è³‡æ–™æºï¼Œé€éŽ Aã€Iã€D ä¾†ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§
- å¤–éƒ¨ä¸€è‡´æ€§ï¼šä¸€å€‹æœå‹™ä½¿ç”¨å¤šå€‹è³‡æ–™æºã€å¤šå€‹æœå‹™ä½¿ç”¨å¤šå€‹ä¸åŒè³‡æ–™æºï¼Œæ¶‰åŠå¤šå€‹è³‡æ–™æºçš„ TX ä¸€è‡´æ€§ â†’ åˆ†æ•£å¼ç³»çµ±é‡åˆ°çš„é›£é¡Œ

è³‡æ–™ä¸€è‡´æ€§åˆ†ä¸‰ç¨®ç‰¹æ€§:
- å¼·ä¸€è‡´æ€§ï¼šå¯«å®Œä¹‹å¾Œï¼Œä»»ä½•è®€å–çš„è³‡æ–™éƒ½æ˜¯æœ€æ–°çš„å€¼
- å¼±ä¸€è‡´æ€§ï¼šå¯«å®Œä¹‹å¾Œï¼Œç„¡æ³•ä¿è­‰éƒ½èƒ½è®€å–åˆ°æœ€æ–°çš„è³‡æ–™
- æœ€çµ‚ä¸€è‡´æ€§(å¾Œé¢è«‡ CAP ç†è«–)ï¼šå¯«å®Œä¹‹å¾Œï¼Œæœ€å¾Œä¸€å®šèƒ½è®€åˆ°æœ€æ–°çš„å€¼

## 3.1ã€€æœ¬åœ°äº¤æ˜“(Local Transaction)
åˆä½œã€ŒLocal Transactionã€ï¼Œé©ç”¨æ–¼å–®å€‹æœå‹™ä½¿ç”¨å–®å€‹è³‡æ–™æºçš„å ´æ™¯ã€‚

å¯¦ç¾åŽŸç†æºè‡ªæ–¼ [ARIES](https://en.wikipedia.org/wiki/Algorithms_for_Recovery_and_Isolation_Exploiting_Semantics) ç†è«–ï¼Œç¾ä»£é—œä¿‚åž‹è³‡æ–™åº«çš„ç†è«–åŸºç¤Žã€‚
### 3.1.1 å¯¦ç¾åŽŸå­æ€§å’ŒæŒä¹…æ€§
æ»¿è¶³åŽŸå­æ€§å’ŒæŒä¹…æ€§çš„æœ€å¤§å›°é›£é»žï¼š
ã€Œå¯«å…¥ç¡¬ç¢Ÿã€é€™å€‹å‹•ä½œä¸¦éžåŽŸå­çš„ï¼Œé™¤äº†æœ‰ã€Œå¯«å…¥ã€èˆ‡ã€Œæœªå¯«å…¥ã€ç‹€æ…‹ï¼Œé‚„å­˜åœ¨ã€Œæ­£åœ¨å¯«ã€åå‘ä¸­é–“çš„ç‹€æ…‹ã€‚

å¯èƒ½ç™¼ç”Ÿå¹¾ç¨®æƒ…å½¢ï¼š

**æœªæäº¤ TXï¼Œå¯«å…¥å¾Œ crash**:

æ‡‰ç”¨ç¨‹å¼é‚„æ²’ä¿®æ”¹å®Œè³‡æ–™ï¼Œä½†è³‡æ–™åº«å·²å°‡éƒ¨åˆ†è³‡æ–™çš„è®Šå‹•å¯«å…¥ç¡¬ç¢Ÿï¼Œç™¼ç”Ÿæ•…éšœçš„ç‹€æ³ï¼Œç¶“é‡å•Ÿå¾Œï¼Œè³‡æ–™åº«å¿…é ˆè¦æœ‰è¾¦æ³•å¾—çŸ¥æ•…éšœå‰ç™¼ç”ŸéŽä¸€æ¬¡ã€Œä¸å®Œæ•´ã€çš„æ“ä½œï¼Œå°‡å·²ä¿®æ”¹éŽçš„è³‡æ–™å¾žç¡¬ç¢Ÿä¸­æ¢å¾©æˆæ²’æœ‰æ”¹éŽçš„æ¨£å­ï¼Œç¢ºä¿åŽŸå­æ€§ã€‚
    
**å·²æäº¤ TXï¼Œå¯«å…¥å‰ crash**:

æ‡‰ç”¨ç¨‹å¼ä¿®æ”¹å®Œæ‰€æœ‰è³‡æ–™ä¸¦å®Œæˆ commitï¼Œä½†è³‡æ–™åº«é‚„æœªå°‡æ‰€æœ‰è®Šå‹•è³‡æ–™å¯«å…¥ç¡¬ç¢Ÿï¼Œç™¼ç”Ÿæ•…éšœæ™‚ç¶“éŽé‡å•Ÿï¼Œè³‡æ–™åº«å¿…é ˆå°‡æœªå®Œæˆçš„è³‡æ–™é‡æ–°å¯«å…¥ç¡¬ç¢Ÿï¼Œæ»¿è¶³æŒä¹…æ€§ã€‚

### Commit Logging 
ä»¥ã€Œæ—¥èªŒã€çš„å½¢å¼ä¾åºå°‡ä¿®æ”¹è³‡æ–™çš„æ“ä½œåŒ…å«çš„æ‰€æœ‰è¨Šæ¯(e.g. ä¿®æ”¹å“ªç­†è³‡æ–™ã€è³‡æ–™ä¿å­˜åœ¨ç¡¬ç¢Ÿè£¡çš„å“ªå€‹å€å¡Šç­‰)ï¼Œéƒ½å…ˆè¨˜éŒ„åˆ°ç¡¬ç¢Ÿè£¡ï¼Œä¿éšœè³‡æ–™æŒä¹…æ€§ã€åŽŸå­æ€§å…©å€‹ç‰¹æ€§ã€‚

åªæœ‰åœ¨ commit log æˆåŠŸç´€éŒ„åœ¨ç¡¬ç¢Ÿè£¡ï¼Œè³‡æ–™åº«åœ¨æ—¥èªŒä¸­çœ‹åˆ°ä»£è¡¨ TX æˆåŠŸçš„æäº¤ç´€éŒ„ï¼ˆCommit Recordï¼‰å¾Œï¼Œæ‰æœƒæ ¹æ“šæ—¥èªŒä¸Šçš„è¨Šæ¯å°çœŸæ­£çš„è³‡æ–™é€²è¡Œä¿®æ”¹ã€‚

ä¿®æ”¹å®Œæˆå¾Œï¼Œåœ¨æ—¥èªŒä¸­åŠ å…¥ä¸€æ¢â€œçµæŸè¨˜éŒ„â€ ï¼ˆEnd Recordï¼‰è¡¨ç¤º TX æ»¿è¶³æŒä¹…æ€§ã€‚

#### æ—¥èªŒä¸€æ—¦æˆåŠŸå¯«å…¥æäº¤ç´€éŒ„(Commit Record): 

æ•´å€‹ TX è¦–ç‚ºæˆåŠŸï¼Œå³ä¾¿çœŸæ­£ä¿®æ”¹è³‡æ–™æ™‚ç™¼ç”Ÿæ•…éšœï¼Œè³‡æ–™åº«é‡å•Ÿå¾Œæ ¹æ“šå·²ç¶“å¯«å…¥ç¡¬ç¢Ÿçš„æ—¥èªŒé€²è¡Œæ¢å¾©ã€ç¹¼çºŒä¿®æ”¹è³‡æ–™å³å¯ï¼Œä¿è­‰æŒä¹…æ€§ã€‚
#### æ—¥èªŒæ²’æœ‰æˆåŠŸå¯«å…¥æäº¤ç´€éŒ„(Commit Record)å°±ç™¼ç”Ÿæ•…éšœï¼š 

æ•´å€‹ TX å°±æ˜¯å¤±æ•—çš„ï¼Œè³‡æ–™åº«é‡å•Ÿå¾Œæœƒçœ‹åˆ°ä¸€éƒ¨åˆ†æ²’æœ‰ commit ç´€éŒ„çš„æ—¥èªŒï¼Œæ¨™è¨˜ç‚º rollback ç‹€æ…‹ï¼Œé€€å›žåˆ° TX é–‹å§‹ä¹‹å‰ï¼Œä¿è­‰åŽŸå­æ€§ã€‚

**ç¼ºé™·ï¼š**

å½±éŸ¿è³‡æ–™åº«çš„æ•ˆèƒ½ã€‚

### Solution: Write-Ahead Logging(WAL)
> åˆä½œã€Œé å¯«æ—¥èªŒã€ï¼Œå…è¨±åœ¨ TX commit ä¹‹å‰ï¼Œæå‰å¯«å…¥è®Šå‹•è³‡æ–™ã€‚

å¯«å…¥è®Šå‹•è³‡æ–™çš„æ™‚é–“é»žä»¥ TX commit æ™‚ç‚ºç•ŒåŽ»åŠƒåˆ†ï¼Œåˆ†ä½œ `FORCE` å’Œ `STEAL` å…©é¡žï¼š
- `FORCE` :  TX commit ä¹‹ã€Œå¾Œã€
    - è¦æ±‚è®Šå‹•è³‡æ–™å¿…é ˆåŒæ™‚å®Œæˆå¯«å…¥å‰‡ç¨±ç‚º `FORCE`
    - ä¸å¼·åˆ¶é ˆåŒæ™‚å®Œæˆå¯«å…¥å‰‡ç¨±ç‚º `NO-FORCE`
- `STEAL` : TX commit ä¹‹ã€Œå‰ã€
    - å…è¨±è®Šå‹•è³‡æ–™æå‰å¯«å…¥ç¨±ç‚º `STEAL`
    - ä¸å…è¨±è®Šå‹•è³‡æ–™æå‰å¯«å…¥ç¨±ç‚º `NO-STEAL`

**LSNâ€“Log (Log Sequence Number Log)**
æ¯æ¢ WAL log éƒ½æœƒå¸¶æœ‰ä¸€ä¸²åºè™Ÿï¼Œç¨±ä½œ [LSN] (Log Sequence Number)ï¼Œç´€éŒ„ TX æ”¹å‹•å…§å®¹ã€‚

WAL æä¾›é¡å¤–çš„æ©Ÿåˆ¶: å¢žåŠ  **Undo Log** çš„æ—¥èªŒé¡žåž‹ã€‚
#### Undo Logï¼š
åœ¨æ”¹å‹•çš„è³‡æ–™å¯«å…¥ç¡¬ç¢Ÿå‰ï¼Œé ˆå…ˆè¨˜éŒ„ Undo logï¼Œå¾ŒçºŒé‡åˆ°éœ€è¦ rollback æˆ–æ˜¯æ•…éšœçš„æƒ…æ³ï¼ŒæŠŠé€™äº› Undo log ç´€éŒ„å…§å®¹éƒ½æŠ¹é™¤æŽ‰ã€‚

#### Redo Logï¼š
ç´€éŒ„ä¿®æ”¹è³‡æ–™çš„æ“ä½œå…§å®¹ã€‚é‡åˆ°æ•…éšœæ™‚ï¼Œè—‰ç”± WAL å¯«å…¥çš„ TX Log ä¾†æ¢å¾©é‡åšã€‚

#### WAL æ•…éšœæ¢å¾©æ™‚æœƒåŸ·è¡Œä¸‰å€‹éšŽæ®µï¼š
- Analysis(åˆ†æž)ï¼šå¾žç¡¬ç¢Ÿè£¡å°‹æ‰¾æœ€å¾Œ(æ–°)ä¸€æ¬¡çš„æª¢æŸ¥é»ž(å·²æˆåŠŸåœ°å¯«å…¥ç¡¬ç¢Ÿè£¡æ»¿è¶³æŒä¹…åŒ–)ï¼Œé–‹å§‹å°æ—¥èªŒé€²è¡ŒæŽƒæï¼Œæ‰¾å‡ºæ²’æœ‰çµæŸè¨˜éŒ„çš„ TXï¼Œçµ„æˆé›†åˆå¾…æ¢å¾©çš„ TXã€‚
- Redo(é‡åš)ï¼šåˆ†æžéšŽæ®µä¸­ç”¢ç”Ÿçš„å¾…æ¢å¾©çš„ TX é›†åˆä¾†é‚„åŽŸç‹€æ…‹ã€‚
- Undo(å›žæ»¾)ï¼šç¶“éŽåˆ†æžã€é‡åšéšŽæ®µå¾Œå‰©é¤˜å¾…æ¢å¾©çš„ TX é›†åˆï¼Œå³éœ€è¦å›žæ»¾çš„ TXï¼Œä¾ Undo Log å…§å®¹å°‡æå‰å¯«å…¥ç¡¬ç¢Ÿçš„è³‡æ–™æ”¹é‡æ–°å¯«å›žåŽ»ã€‚

![FORCE å’ŒSTEAL çš„å››ç¨®çµ„åˆé—œä¿‚](./Ch3/ch3-1-2.png)

## 3.1.2 å¯¦ç¾éš”é›¢æ€§
å¸¸è¦‹æ‰‹æ®µï¼šåŠ éŽ–ðŸ”’
- å¯«éŽ–ï¼ˆWrite Lock; Exclusive Lock -> X-Lockï¼‰
- è®€éŽ–ï¼ˆRead Lock; Shared Lock -> S-Lockï¼‰ï¼š
- ç¯„åœéŽ–ï¼ˆRange Lockï¼‰

### å¸¸è¦‹çš„éš”é›¢å±¤ç´šï¼š
### Read Uncommitted
å…è¨±è®€å–å°šæœªè¢« committed çš„è³‡æ–™ï¼Œå±¬æ–¼æœ€ä½Žå±¤ç´šã€‚
### Read Committed
åªå…è¨±è®€å–å·²è¢« Commit çš„è³‡æ–™ï¼Œå¯è§£æ±º Dirty Read çš„å•é¡Œã€‚
### Repeatable Read 
è®€åˆ°çš„è³‡æ–™åªæœƒæ˜¯ transaction é–‹å§‹å‰å·²ç¶“ committed çš„è³‡æ–™ï¼Œä¸æœƒè®€å–åˆ°å°šæœª committed çš„è³‡æ–™æˆ–è€…åœ¨ transaction æœŸé–“è¢«å…¶ä»–ä¸¦è¡Œçš„ transaction å®Œæˆ committed çš„è®Šæ›´ 
### Snapshot
å°æ¯å€‹ç”¢ç”Ÿçš„æ–°è³‡æ–™åš snapshotï¼Œç”¢ç”Ÿä¸€å€‹æ–°ç‰ˆæœ¬ï¼Œå…è¨± TX è®€å–é€™äº› snapshot çš„æœ€æ–°ç‰ˆæœ¬ => Multi-Version Concurrency Control (MVCC) çš„æ–¹å¼å¯¦ç¾
- å¥½è™•: ä¸é ˆåœ¨è³‡æ–™è¡¨è£¡è¨­ç½®éŽ–(lock)ä¾†é¿å…è¡çª
- ç¼ºé»ž: æ¯ç­†ç´€éŒ„éƒ½éœ€è¦é¡å¤–çš„å„²å­˜ç©ºé–“

### Serializable
æŽ¡åºåˆ—åŒ–ï¼Œæœ€åš´æ ¼çš„éš”é›¢å±¤ç´šï¼Œå¤šå€‹ TXs è®Šæˆä¸€å€‹å€‹ã€ŒæŽ¥çºŒåŸ·è¡Œã€ã€‚

**TX è€—æ™‚ç¨‹åº¦:**

SERIALIZABLE > REPEATABLE_READ > READ_COMMITTED > READ_UNCOMMITTED

## 3.2 å…¨å±€äº¤æ˜“
