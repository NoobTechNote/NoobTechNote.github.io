---
title: "Ch6: 分佈式共識算法"
tsidebar_label: "Ch6: 分佈式共識算法"
sidebar_position: 7
---

# 分佈式共識算法
這節會介紹兩三種具代表性的分佈式共識算法，為後續打好基礎。
先從一個淺顯的場景，因出本章的主題
>  如果你有一份很重要的数据，要确保它长期存储在电脑上不会丢失，你会怎么做？
A: 多買幾塊硬碟。假設一塊硬碟每年損壞的機率是5％，那把文件複製到另外一塊硬碟上，
兩個硬碟同時壞掉而損失資料的機率只有0.25％，3個0.0125％，4個0.000625％，
也就是一年內有超過99.999％的機率是不會同時損失數據的。

軟體系統裡，保障可靠性跟可用性會面臨的困難：
**可靠性** 

* 程序出錯
* 硬碟損壞
* 網路分區
* 電源故障
**可用性**

> 如果你有一份会随时变动的数据，要确保它正确地存储于网络中的几台不同机器之上，你会怎么做？
最容易想到的答案: 數據同步
* 2PC/3PC
* MySQL Cluster
以同步為代表的數據複製方法，被稱為狀態轉移 (State Transfer)，但通常會犧牲可用性。
這往往不能夠接受，一些系統可能要求要99.999999％可靠，同時也要達到99.999％可用

> 如果你有一份会随时变动的数据，要确保它正确地存储于网络中的几台不同机器之上，并且要尽可能保证数据是随时可用的，你会怎么做？

:::info
额外知识：状态机复制
状态机有一个特性：任何初始状态一样的状态机，如果执行的命令序列一样，则最终达到的状态也一样。如果将此特性应用在多参与者进行协商共识上，可以理解为系统中存在多个具有完全相同的状态机（参与者），这些状态机能最终保持一致的关键就是起始状态完全一致和执行命令序列完全一致。
:::
考虑到分布式环境下网络分区现象是不可能消除的，甚至允许不再追求系统内所有节点在任何情况下的数据状态都一致，而是采用“少数服从多数”的原则，
一旦系统中过半数的节点中完成了状态的转换，就认为数据的变化已经被正确地存储在系统当中，這種思想稱為[Quorum](https://en.wikipedia.org/wiki/Quorum_(distributed_computing))機制

Quorum 是法定人數的意思

能够让分布式系统内部暂时容忍存在不同的状态，但最终能够保证大多数节点的状态达成一致；同时，能够让分布式系统在外部看来始终表现出整体一致的结果。这个让系统各节点不受局部的网络分区、机器崩溃、执行性能或者其他因素影响，都能最终表现出整体一致的过程，就被称为各个节点的协商共识（Consensus）。
一致性(Consistency)是指数据不同副本之间的差异
共识（Consensus）是指达成一致性的方法与过程

## 6.1 Paxos 
發明者 Leslie Lamport (LaTeX 的 La)，Paxos 幾乎就是 Consensus 的代名詞，
### 算法流程
* 提案节点：称为 Proposer，提出对某个值进行设置操作的节点，设置值这个行为就被称之为提案（Proposal），值一旦设置成功，就是不会丢失也不可变的。，应该类比成日志记录操作，在后面介绍的 Raft 算法中就直接把“提案”叫作“日志”了。
* 决策节点：称为 Acceptor，是应答提案的节点，决定该提案是否可被投票、是否可被接受。提案一旦得到过半数决策节点的接受，即称该提案被批准（Accept），提案被批准即意味着该值不能再被更改，也不会丢失，且最终所有节点都会接受该它。
* 记录节点：被称为 Learner，不参与提案，也不参与决策，只是单纯地从提案、决策节点中学习已经达成共识的提案，譬如少数派节点从网络分区中恢复时，将会进入这种状态。
