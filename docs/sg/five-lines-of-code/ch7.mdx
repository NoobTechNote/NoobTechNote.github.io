---
title: "Ch7: èˆ‡ç·¨è­¯å™¨åˆä½œ"
sidebar_position: 7
---

## 7.1 äº†è§£ç·¨è­¯å™¨
### 7.1.1 å¼±å‹¢ï¼šåœæ©Ÿå•é¡Œé™åˆ¶äº†ç·¨è­¯æ™‚æœŸçš„çŸ¥è­˜

:::tip
åœæ©Ÿå•é¡Œï¼ˆhalting problemï¼‰å°±æ˜¯åˆ¤æ–·ä»»æ„ä¸€å€‹ç¨‹å¼æ˜¯å¦èƒ½åœ¨æœ‰é™çš„æ™‚é–“ä¹‹å…§çµæŸåŸ·è¡Œçš„å•é¡Œï¼Œ
å·²ç¶“åœ¨ 1936 å¹´è¢« Alan Turing è­‰æ˜é€™å€‹å•é¡Œçš„è§£æ³•æ˜¯ä¸å­˜åœ¨çš„ã€‚

æ›å¥è©±èªªï¼Œç¨‹å¼æ˜¯ä¸å¯é æ¸¬çš„ã€‚
:::

```typescript title="Listing 7.1 ç¨‹å¼æ²’æœ‰åŸ·è¡Œæ™‚æœŸéŒ¯èª¤"
if (new Date().getDay() === 35) {
  5.foo();
}
```

getDay ä¸å¯èƒ½è¿”å› 35ï¼Œå› æ­¤ä¸è«– if å…§éƒ¨æ˜¯ä»€éº¼ç¨‹å¼ç¢¼éƒ½ä¸æœƒè¢«åŸ·è¡Œã€‚

#### ä¿å®ˆåˆ†æ (conservative analysis)

æœ‰äº›ç¨‹å¼æœƒæ˜ç¢ºå¤±æ•ˆè€Œè¢«ç·¨è­¯å™¨æ‹’çµ•ï¼Œè€Œå¦å¤–ä¸€äº›ç¨‹å¼ä¸€å®šä¸æœƒå¤±æ•ˆï¼Œå› æ­¤æœƒè¢«å…è¨±ã€‚

ç„¶å¾Œï¼Œåœæ©Ÿå•é¡Œæ„å‘³è‘—ç·¨è­¯å™¨å¿…é ˆåˆ¤æ–·æ±ºå®šè¦æ€éº¼è™•ç†å…©è€…ä¹‹é–“çš„ç¨‹å¼ï¼š
* æœ‰æ™‚å€™ç·¨è­¯å™¨æœƒå…è¨±å¯èƒ½ä¸ç¬¦åˆé æœŸï¼ŒåŒ…æ‹¬åœ¨åŸ·è¡Œæ™‚æœŸå¤±æ•ˆçš„ç¨‹å¼
* æœ‰æ™‚å€™å¦‚æœç·¨è­¯å™¨ç„¡æ³•ä¿è­‰ç¨‹å¼æ˜¯å®‰å…¨çš„ï¼Œå°±æœƒæ‹’çµ•è©²ç¨‹å¼ï¼ˆé€™è¢«ç¨±ç‚º**ä¿å®ˆåˆ†æ**ï¼‰

ä¿å®ˆåˆ†æèƒ½è­‰æ˜åœ¨ç¨‹å¼ä¸­æŸäº›ç‰¹å®šéŒ¯èª¤æ˜¯ä¸å¯èƒ½ç™¼ç”Ÿçš„ã€‚

:::tip
ç¨‹å¼èªè¨€å®šç¾©äº†è‡ªå·±çš„èªæ³• (syntax)ï¼Œè€Œç·¨è­¯å™¨æ¡ç”¨ä¿å®ˆåˆ†æï¼Œæª¢æŸ¥èªæ„ (semantic)ï¼Œé€²è€Œæ‰¾å‡ºç¨‹å¼ä¸­çš„æ½›åœ¨éŒ¯èª¤
:::

### 7.1.2 å„ªå‹¢ï¼šå¯é”æ€§ç¢ºä¿äº†æ–¹æ³•çš„è¿”å›

```typescript title="Listing 7.2 å› å¯é”æ€§å¼•èµ·çš„ç·¨è­¯å™¨éŒ¯èª¤"
enum Color {
  RED, GREEN, BLUE
}
function assertExhausted(x: never): never {
  throw new Error("Unexpected object: " + x);
}
function handle(t: Color) {
  if (t === Color.RED) return "#ff0000";
  if (t === Color.GREEN) return "#00ff00";
  assertExhausted(t);
}
```

åˆ©ç”¨äº† TypeScript çš„ never ç‰¹æ€§ï¼Œç•¶ç¨‹å¼åœ¨å¯èƒ½åˆ°é” never çš„æ™‚å€™ï¼Œç·¨è­¯å™¨æœƒæ‹‹å‡ºéŒ¯èª¤ï¼Œè®“æˆ‘å€‘çŸ¥é“ç¨‹å¼åˆ°äº†ä¸è©²åˆ°çš„åœ°æ–¹ã€‚

æ­¤æª¢æŸ¥è¢«ç¨±ç‚ºå®Œæ•´æ€§æª¢æŸ¥ï¼ˆexhaustiveness checkï¼‰ã€‚

```typescript
type Fruit = 'banana' | 'orange' | 'mango';

function exhaustiveCheck(param: never) {}

function makeDessert(fruit: Fruit) {
  switch (fruit) {
    case 'banana': return 'Banana Shake';
    case 'orange': return 'Orange Juice';
  }
  exhaustiveCheck(fruit); // ğŸš« ERROR! `mango` is not assignable to type `never`
}

// from https://dev.to/babak/exhaustive-type-checking-with-typescript-4l3f
```

### 7.1.3 å„ªå‹¢ï¼šå®šç¾©æŒ‡å®šå€¼å¯é˜²æ­¢å­˜å–æœªåˆå§‹åŒ–çš„è®Šæ•¸

```typescript title="7.3 æœªåˆå§‹åŒ–çš„è®Šæ•¸"
let result;
for (let i = 0; i < arr.length; i++)
  if (arr[i].name === "John")
    result = arr[i];
return result; // error TS2454: Variable 'result' is used before being assigned.
```

ç·¨è­¯å™¨æœƒå¹«å¿™æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ•¸åœ¨æŸäº›æƒ…æ³ä¸‹æ²’æœ‰è¢«è³¦äºˆå€¼ã€‚

### 7.1.4 å„ªå‹¢ï¼šå­˜å–æ§åˆ¶æœ‰åŠ©æ–¼å°è£è³‡æ–™

```typescript title="7.4 ç”±æ–¼å­˜å–æ‰€é€ æˆçš„ç·¨è­¯å™¨éŒ¯èª¤"
class Class {
  private sensitiveMethod() {
    // ...
  }
}
let c = new Class();
c.sensitiveMethod(); // error TS2341: Property 'sensitiveMethod' is private and only accessible within class 'Class'.
```

### 7.1.5 å„ªå‹¢ï¼šå‹åˆ¥æª¢æŸ¥è­‰æ˜ç‰¹æ€§

```typescript title="Listing 7.5 ç”±æ–¼å‹åˆ¥æ‰€é€ æˆçš„ç·¨è­¯å™¨éŒ¯èª¤"
interface NonEmptyList<T> {
  head: T;
}
class Last<T> implements NonEmptyList<T> {
  constructor(public readonly head: T) { }
}
class Cons<T> implements NonEmptyList<T> {
  constructor(
    public readonly head: T,
    public readonly tail: NonEmptyList<T>) { }
}
function first<T>(xs: NonEmptyList<T>) {
  return xs.head;
}
first([]); // a very long compile error
```

```typescript title="å¦‚ä½•æ­£ç¢ºä½¿ç”¨"
const singleElementList = new Last(1);
const longerList = new Cons(2, singleElementList);
const firstElement = first(longerList); // Returns 2
```

ç·¨è­¯å™¨æœ‰è¼ƒå¼·çš„å‹åˆ¥æª¢æŸ¥èƒ½åŠ›ï¼Œä½†å¼·å‹åˆ¥ï¼ˆstrongly typedï¼‰ä¸æ˜¯å€‹äºŒå…ƒçš„ç‰¹è¡Œï¼Œè€Œæ˜¯åƒåœ¨å…‰è­œä¸Šï¼Œæœ‰è¼ƒå¼·å’Œè¼ƒå¼±çš„å€åˆ¥ã€‚

æŒ‰å¼·åº¦éå¢ï¼š
* å€Ÿç”¨å‹åˆ¥ï¼ŒBorrowing types (Rust)
* å¤šå‹å‹åˆ¥æ¨æ–·ï¼ŒPolymorphic type inference (OCaml and F#)
* å‹åˆ¥é¡åˆ¥ï¼ŒType classes (Haskell)
* è¯åˆå’Œäº¤é›†å‹åˆ¥ï¼ŒUnion and intersection types (TypeScript, Java, and C#)
* ç›¸ä¾å‹åˆ¥ï¼ŒDependent types (Coq and Agda)

è¶Šé›£è¶Šå®‰å…¨...?

### 7.1.6 å¼±å‹¢ï¼šååƒç…§ null æœƒå°è‡´æ‡‰ç”¨ç¨‹å¼å´©æ½°

```typescript title="Listing 7.6 æ½›åœ¨çš„ null ååƒç…§ï¼Œä½†ç·¨è­¯å™¨ä¸æœƒå›å ±éŒ¯èª¤"
function average(arr: number[]) {
  return sum(arr) / arr.length;
}
```

å¦‚æœä½¿ç”¨ `tsc --strict index.ts`ï¼Œæœƒæ‹¿åˆ°å¦‚ä¸‹éŒ¯èª¤ï¼š
```
index.ts:49:16 - error TS2345: Argument of type 'number[] | undefined' is not assignable to parameter of type 'number[]'.
  Type 'undefined' is not assignable to type 'number[]'.

49     return sum(arr) / arr.length;
                  ~~~

index.ts:49:23 - error TS18048: 'arr' is possibly 'undefined'.

49     return sum(arr) / arr.length;
                         ~~~
```

:::tip
**åå„„ç¾å…ƒçš„éŒ¯èª¤**

Tony Hoare åœ¨ 1965 å¹´è¨­è¨ˆ ALGOL W é€™å€‹ç‰©ä»¶å°å‘ç¨‹å¼èªè¨€æ™‚ï¼Œå°å…¥äº† null çš„æ¦‚å¿µï¼Œå¾ŒçºŒç¨‹å¼èªè¨€ç´›ç´›æ•ˆä»¿ã€‚ä»–åŒæ™‚ä¹Ÿæ˜¯å¿«é€Ÿæ’åºçš„ç™¼æ˜è€…ã€‚

ä»–åœ¨ 2009 å¹´æ™‚æåˆ°ï¼šI call it my billion-dollar mistake.

> æˆ‘åŸå…ˆç›®æ¨™æ˜¯è¦ç¢ºä¿æ‰€æœ‰ reference éƒ½çµ•å°å®‰å…¨ï¼Œç”± compiler è‡ªå‹•æª¢æŸ¥å‹åˆ¥ã€‚ä½†æ˜¯æˆ‘æŠ—æ‹’ä¸äº†æŠŠ null reference åŠ é€²å‹åˆ¥ç³»çµ±è£¡é¢çš„èª˜æƒ‘ï¼Œå› ç‚ºå¯¦ä½œèµ·ä¾†å¯¦åœ¨å¾ˆç°¡å–®ã€‚é€™å°è‡´äº†ä¹‹å¾Œç„¡æ•¸çš„ç¨‹å¼éŒ¯èª¤ã€è³‡å®‰æ¼æ´ã€ç³»çµ±ç•¶æ©Ÿã€‚å¤§æ¦‚åœ¨éå» 40 å¹´é–“é€ æˆäº†æ¥­ç•Œåå„„ç¾å…ƒçš„æå¤±èˆ‡å‚·å®³ã€‚
:::

### 7.1.7 å¼±å‹¢ï¼šç®—è¡“éŒ¯èª¤å°è‡´æº¢ä½æˆ–ç¨‹å¼å´©æ½°

ç·¨è­¯å™¨ä¸æœƒæª¢æŸ¥ç®—è¡“éŒ¯èª¤ç›¸é—œçš„å•é¡Œã€‚

```typescript title="Listing 7.7 æ½›åœ¨é™¤ä»¥ 0 çš„å•é¡Œï¼Œä½†ç·¨è­¯å™¨ä¸æœƒå›å ±éŒ¯èª¤"
function average(arr: number[]) {
  return sum(arr) / arr.length;
}
```

### 7.1.8 å¼±å‹¢ï¼šè¶Šç•ŒéŒ¯èª¤å°è‡´ç¨‹å¼å´©æ½°

```typescript title="Listing 7.8 æ½›åœ¨è¶Šç•Œå­˜å–çš„å•é¡Œï¼Œä½†ç·¨è­¯å™¨ä¸æœƒå›å ±éŒ¯èª¤"
function firstPrime(arr: number[]) {
  return arr[indexOfPrime(arr)];
}
```

å¦‚æœ `indexofPrime` æ‰¾ä¸åˆ°è€Œå›å‚³ -1ï¼Œå‰‡æœƒå¼•èµ·éŒ¯èª¤ã€‚

:::tip
é€™ç¨®è¡Œç‚ºåœ¨ C/C++ çš„åŸ·è¡Œæ™‚æœŸä¸æœƒå¼•ç™¼éŒ¯èª¤ï¼Œæœ‰æ½›åœ¨çš„è³‡è¨Šå®‰å…¨é¢¨éšªï¼ŒåŒæ™‚é€™ä¹Ÿè¢«å®šç¾©åœ¨ CWE-125: Out-of-bounds Read

> Typically, this can allow attackers to read sensitive information from other memory locations or cause a crash. A crash can occur when the code reads a variable amount of data and assumes that a sentinel exists to stop the read operation, such as a NUL in a string. The expected sentinel might not be located in the out-of-bounds memory, causing excessive data to be read, leading to a segmentation fault or a buffer overflow. The product may modify an index or perform pointer arithmetic that references a memory location that is outside of the boundaries of the buffer. A subsequent read operation then produces undefined or unexpected results.
:::

### 7.1.9 å¼±å‹¢ï¼šç„¡çª®è¿´åœˆ

```typescript title="Listing 7.9 æœ‰ç„¡çª®è¿´åœˆçš„å•é¡Œï¼Œä½†ç·¨è­¯å™¨ä¸æœƒå›å ±éŒ¯èª¤"
let insideQuote = false;
let quotePosition = s.indexOf("\"");
while(quotePosition >= 0) {
  insideQuote = !insideQuote;
  quotePosition = s.indexOf("\"");
}
```

é€™æ®µç¨‹å¼ç¢¼æƒ³çœ‹é›™å¼•è™Ÿæ˜¯å¦æˆå°å‡ºç¾ï¼Œä½†å¿˜è¨˜è¨­å®šè¿´åœˆä¸­çš„é–‹å§‹ä½ç½®ï¼Œåªè¦è£¡é¢æœ‰ä¸€å€‹é›™å¼•è™Ÿï¼Œå°±è®Šæˆç„¡é™è¿´åœˆã€‚

é€™é¡å•é¡Œåœ¨ while æœ€å®¹æ˜“å‡ºç¾ï¼Œå¾Œä¾†çš„ forï¼Œå†æ¼”è®Šåˆ° foreachï¼Œæ…¢æ…¢é™ä½é€™å€‹å•é¡Œçš„ç™¼ç”Ÿã€‚

### 7.1.10 å¼±å‹¢ï¼šæ­»é–å’Œç«¶çˆ­æ¢ä»¶å°è‡´æ„å¤–è¡Œç‚º

å¤šåŸ·è¡Œç·’é›–ç„¶èƒ½ææ˜‡ç¨‹å¼æ•ˆèƒ½ï¼Œä½†è¼ƒç‚ºè¤‡é›œçš„ç‹€æ…‹ä¹Ÿå®¹æ˜“å°è‡´å•é¡Œå‡ºç¾ï¼Œä¾‹å¦‚ race cnodition, deadlock, starvation ç­‰ç­‰ã€‚

#### Race Condition

å…©å€‹ thread åŒæ™‚è®€å– `number`ï¼Œæ‹¿åˆ°ä¸€æ¨£çš„å€¼ï¼Œå°å‡ºï¼Œå†åŠ ä¸€ã€‚

<Row>
<Col col={2}>

```typescript title="7.10 ç«¶çˆ­æ¢ä»¶çš„è™›æ“¬ç¨‹å¼ç¢¼"
class Counter implements Runnable {
  private static number = 0;

  run() {
    for (let i = 0; i < 10; i++)
      console.log(this.number++);
  }
}

let a = new Thread(new Counter());
let b = new Thread(new Counter());

a.start();
b.start();
```

</Col>
<Col col={2}>

```typescript title="Listing 7.11 ç¯„ä¾‹è¼¸å‡º"
1
2
3
4
5
5  // éŒ¯èª¤
7
8
...
```

</Col>
</Row>

#### Deadlock

ç‚ºäº†ä¸è¦è®“å…©å€‹ thread åŒæ™‚è®€å–ï¼Œåˆ†åˆ¥åŠ ä¸Šä¸€å€‹é–ï¼Œæ‹¿åˆ°é–çš„äººæ‰èƒ½è®€å–å’Œå¯«å…¥ã€‚

å°è‡´ç•¶å…©å€‹ thread éƒ½å„è‡ªæ‹¿åˆ°è‡ªå·±çš„é–ã€è€Œç­‰ä¸åˆ°å°æ–¹é‡‹æ”¾é–ï¼Œå…©è€…éƒ½ç„¡æ³•ç¹¼çºŒåŸ·è¡Œï¼Œç¨±ç‚ºæ­»é–ã€‚

æœ‰å€‹å¸¸è¦‹çš„æ¯”å–»æ˜¯ï¼Œå…©å€‹äººåœ¨é–€å£ç›¸é‡ï¼Œéƒ½å …æŒå°æ–¹å…ˆé€²å»ã€‚

<Row>
<Col col={2}>

```typescript title="Listing 7.12 æ­»é–çš„è™›æ“¬ç¨‹å¼ç¢¼"
class Counter implements Runnable {
  private static number = 0;
  constructor(private mine: Lock, private other: Lock) {}

  run() {
    for (let i = 0; i < 10; i++) {
      mine.lock();
      other.waitFor();
      console.log(this.number++);
      mine.free();
    }
  }
}

let aLock = new Lock();
let bLock = new Lock();
let a = new Thread(new Counter(aLock, bLock));
let b = new Thread(new Counter(bLock, aLock));

a.start();
b.start();
```

</Col>
<Col col={2}>

```typescript title="Listing 7.13 ç¯„ä¾‹è¼¸å‡º"
1
2
3
4
// å¾Œé¢æ²’æœ‰è¼¸å‡ºï¼Œå¡æ­»äº†
...
```

</Col>
</Row>

#### Starvation

è¼ƒå°‘ç™¼ç”Ÿçš„æƒ…æ³ï¼Œå¯ä»¥æ¯”å–»æˆå–®è¡Œé“çš„æ©‹ï¼Œæœ‰ä¸€å´éœ€è¦ç­‰å¾…ï¼Œè€Œå¦ä¸€å´çš„è»Šæµå¾æœªåœæ­¢ã€‚

<Row>
<Col col={2}>

```typescript title="Listing 7.14 é£¢é¤“çš„è™›æ“¬ç¨‹å¼ç¢¼"
class Printer implements Runnable {
  constructor(private name: string, private mine: Lock, private other: Lock) {}

  run() {
    while(true) {
      other.waitFor();
      mine.lock();
      console.log(this.name);
      mine.free();
    }
  }
}

let aLock = new Lock();
let bLock = new Lock();
let a = new Thread(new Printer("A", aLock, bLock));
let b = new Thread(new Printer("B", bLock, aLock));

a.start();
b.start();
```

</Col>
<Col col={2}>

```typescript title="Listing 7.15 ç¯„ä¾‹è¼¸å‡º"
A
A
A
A
// B ä¸€ç›´æ²’æ©ŸæœƒåŸ·è¡Œï¼Œè¢«é¤“æ­»äº†
...
```

</Col>
</Row>

## 7.2 ä½¿ç”¨ç·¨è­¯å™¨

### 7.2.1 è®“ç·¨è­¯å™¨èƒ½å¥½å¥½å·¥ä½œ

#### æŠŠç·¨è­¯å™¨ç•¶ä½œä»£è¾¦äº‹é …æ¸…å–®ï¼Œå¢åŠ ç¨‹å¼ç¢¼çš„å®‰å…¨æ€§

æƒ³è¦é€²è¡Œä¿®æ”¹æ™‚ï¼Œé‡æ–°å‘½åç¨‹å¼ç¢¼ï¼Œç·¨è­¯å™¨å°±æœƒå‘Šè¨´æˆ‘å€‘å“ªäº›ä½ç½®éœ€è¦èª¿æ•´ã€‚

```typescript title="Listing 7.16 åˆ©ç”¨ç·¨è­¯å™¨çš„éŒ¯èª¤ä¾†å°‹æ‰¾æœ‰ä½¿ç”¨ enum çš„ä½ç½®"
enum Color_handled {
  RED, GREEN, BLUE
}
function toString(c: Color) {
  switch (c) {
    case Color.RED: return "Red";
    default: return "No color";
  }
}
```

#### ä½¿ç”¨å¼·åˆ¶å¾ªåºä¾†å¢åŠ ç¨‹å¼ç¢¼çš„å®‰å…¨æ€§

æŠŠè¦åšçš„äº‹æƒ…å¡é€²å»ºæ§‹å­ï¼Œè®“ç¨‹å¼åœ¨åŸ·è¡Œçš„æ™‚å€™ä¸å¯èƒ½è·³éä»–å€‘ã€‚

ä»¥ä¸‹æ˜¯ç¬¬å…­ç« ä¸­çš„ä¾‹å­ï¼š

<Row>
<Col col={2}>

```typescript title="Listing 7.17 å…§éƒ¨"
class CapitalizedString {
  private value: string;
  constructor(str: string) {
    this.value = capitalize(str);
  }
  print() {
    console.log(this.value);
  }
}
```

</Col>
<Col col={2}>

```typescript title="Listing 7.18 å¤–éƒ¨"
class CapitalizedString {
  public readonly value: string;
  constructor(str: string) {
    this.value = capitalize(str);
  }
}
function print(str: CapitalizedString) {
  console.log(str.value);
}
```

</Col>
</Row>

#### ä½¿ç”¨å¼·åˆ¶å°è£ä¾†å¢åŠ ç¨‹å¼ç¢¼çš„å®‰å…¨æ€§

ä¸€æ¨£æ˜¯å›é¡§ç¬¬å…­ç« çš„è½‰å¸³ç¯„ä¾‹ï¼ŒæŠŠé‚è¼¯åŒ…è£åœ¨é¡åˆ¥è£¡é¢ï¼Œé€éå°å¤–çš„ç•Œé¢ä¾†ç¢ºä¿é–‹ç™¼äººå“¡åœ¨ä½¿ç”¨çš„æ™‚å€™ä¸æœƒæéŒ¯ã€‚

```typescript title="Listing 7.19 ç§äººçš„è¼”åŠ©æ–¹æ³•"
class Transfer {
  constructor(from: string, private amount: number) {
    this.depositHelper(from, -this.amount);
  }
  private depositHelper(to: string, amount: number) {
    let accountId = database.find(to);
    database.updateOne(accountId, { $inc: { balance: amount } });
  }
  deposit(to: string) {
    this.depositHelper(to, this.amount);
  }
}
```

#### åˆ©ç”¨ç·¨è­¯å™¨åˆªé™¤æ²’ç”¨åˆ°çš„ç¨‹å¼ç¢¼ä¾†å¢åŠ å®‰å…¨æ€§

å¦‚æœä¸å°å¿ƒåˆªåˆ°æœ‰ä½¿ç”¨çš„ç¨‹å¼ç¢¼ï¼Œç·¨è­¯å™¨æœƒè·³éŒ¯èª¤ï¼Œå› æ­¤æˆ‘å€‘å¯ä»¥é€éé€™å€‹ç‰¹æ€§ï¼Œæ”¾å¿ƒåˆªé™¤è¦ºå¾—æ²’ç”¨åˆ°çš„ç¨‹å¼ç¢¼ã€‚

ä¾‹å¦‚ä¸‹é¢ interface A çš„ m2 å’Œ class B çš„ m3ã€‚

```typescript title="Listing 7.20 å¯åˆªé™¤æ–¹æ³•çš„ç¯„ä¾‹"
interface A {
  m1(): void;
  m2(): void;
}
class B implements A {
  m1() { console.log("m1"); }
  m2() { this.m3(); }
  m3() { console.log("m3"); }
}
let a = new B();
a.m1();
```

#### åˆ©ç”¨æ˜ç¢ºçš„å€¼ä¾†å¢åŠ ç¨‹å¼ç¢¼çš„å®‰å…¨æ€§

ç”±æ–¼ TypeScript åœ¨å»ºæ§‹å­æœ‰ç‰¹æ®Šçš„èªæ³•ç³–ï¼Œèƒ½ç¢ºä¿å‚³é€²ä¾†çš„åƒæ•¸æœƒè¢«è³¦å€¼åˆ°ç§æœ‰è®Šæ•¸èº«ä¸Šï¼Œä»¥é¿å…ç”¢ç”Ÿä¸€å€‹æœªçŸ¥ç‹€æ…‹çš„ç‰©ä»¶ã€‚

æƒ³å¼·èª¿ç·¨è­¯å™¨èƒ½é€éèªæ³•è¦ç¯„ä¾†å¹«å¿™æª¢æŸ¥ç¨‹å¼ç¢¼ã€‚

```typescript title="Listing 7.21 ä½¿ç”¨å”¯ç¨æ¬„ä½å¯¦ç¾äº†ä¸èƒ½ç‚ºç©ºçš„ä¸²åˆ—"
interface NonEmptyList<T> {
  head: T;
}
class Last<T> implements NonEmptyList<T> {
  constructor(public readonly head: T) {}
}
class Cons<T> implements NonEmptyList<T> {
  constructor(
    public readonly head: T,
    public readonly tail: NonEmptyList<T>,
  ) {}
}
```

### 7.2.2 ä¸è¦å’Œç·¨è­¯å™¨å°æŠ—

#### å‹åˆ¥

å¤§éƒ¨åˆ†çš„äººæœƒä»¥é€™ä¸‰ç¨®æ–¹å¼èª¤ç”¨å‹åˆ¥æª¢æŸ¥å™¨

* å‹åˆ¥è½‰æ›

ä½¿ç”¨å‹åˆ¥è½‰æ›å°±åƒçµ¦ä¸€å€‹é•·æœŸç–¼ç—›çš„äººåƒæ­¢ç—›è—¥ï¼Œå¯ä»¥æš«æ™‚ç·©è§£ç—›æ¥šï¼Œä½†ç„¡æ³•è§£æ±ºæ ¹æœ¬å•é¡Œã€‚

```typescript title="Listing 7.22 å‹åˆ¥è½‰æ›"
let num = <number> JSON.parse(variable);
```

å¦‚æœè¼¸å…¥ä¾†è‡ªç¬¬ä¸‰æ–¹ï¼Œæœ€å®‰å…¨çš„è§£æ±ºæ–¹æ¡ˆæ˜¯**ä½¿ç”¨è‡ªè¨‚è§£æå™¨**ä¾†è™•ç†è¼¸å…¥ã€‚

```typescript title="Listing 7.23 å¾å­—ä¸²è§£æè¼¸å…¥åˆ°è‡ªè¨‚å‹åˆ¥"
window.addEventListener("keydown", e => {
  if (e.key === LEFT_KEY || e.key === "a") inputs.push(new Left());
  else if (e.key === UP_KEY || e.key === "w") inputs.push(new Up());
  else if (e.key === RIGHT_KEY || e.key === "d") inputs.push(new Right());
  else if (e.key === DOWN_KEY || e.key === "s") inputs.push(new Down());
});
```

* å‹•æ…‹å‹åˆ¥

æ¯”å¦‚åœç”¨å‹åˆ¥æª¢æŸ¥ï¼Œæ›´ç³Ÿçš„æ˜¯**çœŸæ­£**åœç”¨å‹åˆ¥æª¢æŸ¥ã€‚ä»¥ TypeScript çš„è§’åº¦ä¾†èªªï¼Œå°±æ˜¯æŠŠæ¯å€‹åƒæ•¸çš„å‹æ…‹æ¨™è¨˜æˆ `any`ï¼Œè®“ç·¨è­¯å™¨è·³ä¸å‡ºéŒ¯èª¤ã€‚

```typescript title="Listing 7.24 ä½¿ç”¨ any å‹åˆ¥"
(<any> arr).findIndex(x => x === 2);
```

* åŸ·è¡Œæ™‚æœŸå‹åˆ¥

æœ€ç³Ÿçš„æ˜¯ï¼Œä½¿ç”¨ map å‚³éæ‰€æœ‰åƒæ•¸ï¼Œè®“ç·¨è­¯å™¨çœ‹ä¸å‡ºæ¯å€‹åƒæ•¸å¯¦éš›çš„å‹åˆ¥ã€‚

```typescript title="Listing 7.25 åŸ·è¡Œæ™‚æœŸå‹åˆ¥"
function stringConstructor(conf: Map<string, string>, parts: string[]) {
  return conf.get("prefix") + parts.join(conf.get("joiner")) + conf.get("postfix");
}
```

è¼ƒå®‰å…¨çš„æ–¹å¼æ˜¯å»ºç«‹ä¸€å€‹å…·æœ‰ç‰¹å®šæ¬„ä½çš„ç‰©ä»¶ã€‚

```typescript title="Listing 7.26 éœæ…‹å‹åˆ¥"
class Configuration {
  constructor(
    public readonly prefix: string,
    public readonly joiner: string,
    public readonly postfix: string,
  ) {}
}

function stringConstructor(conf: Configuration, parts: string[]) {
  return conf.prefix + parts.join(conf.joiner) + conf.postfix;
}
```

#### æ‡¶æƒ°

æˆ‘å€‘å¾ˆæ¨‚æ„èŠ±è²»æ•¸å°æ™‚æˆ–æ•¸å‘¨çš„æ™‚é–“ä¾†è‡ªå‹•åŒ–è™•ç†æ‡¶çš„åšçš„äº‹æƒ…ï¼Œæ‡¶æƒ°è®“æˆ‘å€‘æˆç‚ºæ›´å¥½çš„ç¨‹å¼è¨­è¨ˆå¸«ï¼Œä½†å¦‚æœä¸€ç›´ä¿æŒæ‡¶æƒ°ä¸‹å»ï¼Œæœ‰å¯èƒ½æœƒè®“æˆ‘å€‘æˆç‚ºå¾ˆç³Ÿç³•çš„ç¨‹å¼è¨­è¨ˆå¸«ã€‚

* é è¨­å€¼

æ–°å¢é è¨­å€¼ä¹‹å‰ï¼Œè¦ä»”ç´°æ€è€ƒéä»–çš„åˆç†æ€§ï¼Œå¦å‰‡å¯èƒ½åœ¨ä¹‹å¾Œé€ æˆè² é¢å½±éŸ¿ã€‚

```typescript title="Listing 7.27 ç”±æ–¼é è¨­å¼•æ•¸æ‰€é€ æˆçš„ bug"
class Animal {
  constructor(name: string, isMammal = true) { ... }
}
let nemo = new Animal("Clown fish"); // å°ä¸‘é­šè®Šæˆå“ºä¹³å‹•ç‰©äº†
```

* ç¹¼æ‰¿

ç¹¼æ‰¿å°±æ˜¯æŠŠçˆ¶é¡åˆ¥çš„è¡Œç‚ºç•¶ä½œé è¨­å€¼ã€‚å‘¼æ‡‰åˆ°æœ€ä¸€é–‹å§‹çš„ã€Œç”¨çµ„åˆå–ä»£ç¹¼æ‰¿ã€ã€‚

```typescript title="Listing 7.28 ç”±æ–¼ç¹¼æ‰¿æ‰€é€ æˆçš„å•é¡Œ"
class Mammal {
  laysEggs() { return false; }
}
class Dolphin extends Mammal { }
/// ...
class Platypus extends Mammal { } // é´¨å˜´ç¸æ˜¯å°‘æ•¸æœƒä¸‹è›‹çš„å“ºä¹³é¡å‹•ç‰©
```

* éå—æª¢ä¾‹å¤–

å› ç‚º TypeScript æ²’æœ‰é€™ç¨®æ±è¥¿ï¼Œä»¥ Java èˆ‰ä¾‹ã€‚

å—æª¢ä¾‹å¤–ï¼ˆchecked exceptionï¼‰ï¼šå‡½æ•¸æœƒæ¨™è¨˜å®ƒæœƒæ‹‹å‡ºä»€éº¼ä¾‹å¤–ï¼Œè€Œå‘¼å«æ–¹å¿…é ˆè¦è™•ç†çš„ä¾‹å¤–ï¼Œæ¯”å¦‚èªª Java çš„ IOException

```java title="å—æª¢ä¾‹å¤–"
public class Main {
  private String readFile(String path) throws IOException {
    // read file
  }

  public static void main(String[] args) {
    try {
      System.out.println(readFile("/path/to/file.json"));
    } catch (IOException e) {
      System.out.println("Something wrong when read file", e);
    }
  }
}
```

éå—æª¢ä¾‹å¤–ï¼ˆunchecked exceptionï¼‰ï¼šä¸å¿…æ¨™è¨˜åœ¨å‡½æ•¸ä¸Šçš„ä¾‹å¤–ï¼Œæ¯”å¦‚èªª Java çš„ RuntimeException

```java title="éå—æª¢ä¾‹å¤–"
public class Main {
  private String readFile(String path) {
    try {
      // read file
    } catch (IOExeption e) {
      throw new RuntimeException(e)
    }
  }

  public static void main(String[] args) {
    System.out.println(readFile("/path/to/file.json"));
  }
}
```

éå—æª¢ä¾‹å¤–å¯èƒ½æœƒè®“ç¨‹å¼éŒ¯éä¸€äº›æƒ…æ³ï¼Œè€Œè®“ç³»çµ±å´©æ½°ï¼Œå› æ­¤é‚„æ˜¯å»ºè­°åœ¨æœ‰å—æª¢ä¾‹å¤–çš„èªè¨€ä¸­ï¼Œç›¡é‡ä½¿ç”¨é€™å€‹ç‰¹æ€§ã€‚

* æ¶æ§‹

å¤§å®¶åœ¨å°æŠ—å¦¨ç¤™ç·¨è­¯å™¨å”åŠ©çš„ç¬¬ä¸‰ç¨®æ–¹å¼æ˜¯å› ç‚ºå°æ¶æ§‹ï¼ˆç‰¹åˆ¥æ˜¯å¾®æ¶æ§‹ï¼‰çš„ç†è§£ä¸è¶³ï¼Œå¾®æ¶æ§‹ï¼ˆmicro-architectureï¼‰æ˜¯æœƒå½±éŸ¿è‡ªå·±åœ˜éšŠä½†ä¸æœƒå½±éŸ¿å…¶ä»–åœ˜éšŠçš„æ¶æ§‹ã€‚

```typescript title="Listing 7.31 å¸¶æœ‰ getter çš„ä¸è‰¯å¾®æ¶æ§‹"
class Stack<T> {
  private data: T[];
  getArray() { return this.data; }
}
stack.getArray()[0] = newBottomElement; // é€™è¡Œæ”¹è®Šäº† stack çš„ç‹€æ…‹
```

```typescript title="Listing 7.31 å¸¶æœ‰åƒæ•¸çš„ä¸è‰¯å¾®æ¶æ§‹"
class Stack<T> {
  private data: T[];
  printLast() { printFirst(this.data); }
}
function printFirst<T>(arr: T[]) {
  arr[0] = newBottomElement; // é€™è¡Œæ”¹è®Šäº† stack çš„ç‹€æ…‹
}
```

```typescript title="æ¨è–¦å‚³å…¥ this"
class Stack<T> {
  private data: T[];
  printLast() { printFirst(this); }
}
function printFirst<T>(stack: Stack<T>) {
  ??
}
```

### 7.3 ä¿¡ä»»ç·¨è­¯å™¨

ä¸è¦è¦ºå¾—è‡ªå·±æ¯”ç·¨è­¯å™¨æ›´äº†è§£ç¨‹å¼ï¼Œå¯†åˆ‡æ³¨æ„ç·¨è­¯å™¨å›æ‡‰çš„å…§å®¹ï¼Œæˆ‘å€‘æœƒå› ç‚ºä»˜å‡ºè€Œå¾—åˆ°å›å ±ã€‚

#### 7.3.1 æ•™æœƒç·¨è­¯å™¨ä¸è®Šæ¢ä»¶

```typescript title="Listing 7.34 éš¨æ©ŸæŒ‘é¸ä¸€å€‹å…ƒç´ ï¼ˆéŒ¯èª¤ç‰ˆï¼‰"
class CountingSet {
  randomElement(): string {
    let index = randomInt(this.total);
    for (let key in this.data.keys()) {
      index -= this.data[key];
      if (index <= 0)
        return key;
    }
    // error TS2366: Function lacks ending return statement and return type does not include 'undefined'.
  }
}
```

åŠ ä¸Šä¸€å€‹ä¾‹å¤–ï¼Œè®“ç·¨è­¯å™¨ä¸å†ä¸Ÿå‡ºéŒ¯èª¤ã€‚

```typescript title="Listing 7.35 éš¨æ©ŸæŒ‘é¸ä¸€å€‹å…ƒç´ ï¼ˆä¿®æ­£ç‰ˆï¼‰"
class Impossible {}
class CountingSet {
  randomElement(): string {
    let index = randomInt(this.total);
    for (let key in this.data.keys()) {
      index -= this.data[key];
      if (index <= 0)
        return key;
    }
    throw new Impossible(); // è®“ç·¨è­¯å™¨ä¸å†æŠ±æ€¨
  }
}
```

ç•¶æˆ‘å€‘åœ¨ç¨‹å¼ä¸­æœ‰é€™ç¨®æƒ…æ³å‡ºç¾æ™‚ï¼Œæœ‰å¹¾ç¨®ç­–ç•¥ï¼š

1. æ¶ˆé™¤é€™äº›éŒ¯èª¤/å•é¡Œ
2. æ•™å°ç·¨è­¯å™¨èªè­˜ä»–å€‘ï¼ˆå¦‚ 7.35ï¼‰
3. æ’°å¯«è‡ªå‹•åŒ–æ¸¬è©¦æ¶ˆé™¤ç–‘æ…®
4. å¯«æ–‡ä»¶è®“å…¶ä»–é–‹ç™¼è€…äº†è§£
5. å¢åŠ æ‰‹å‹•æ¸¬è©¦é …ç›®
6. ç¥ˆç¦±

å¦‚æœè»Ÿé«”çš„ç”Ÿå‘½é€±æœŸå¾ˆçŸ­ï¼Œå¯ä»¥é¸æ“‡æ¸…å–®è¼ƒä¸‹æ–¹çš„é¸é …ã€‚æ¯”å¦‚èªª prototype å¯ä»¥ç”¨æ‰‹å‹•æ¸¬è©¦å°±å¥½ï¼Œä¸éœ€è¦èŠ±æ™‚é–“é–‹ç™¼è‡ªå‹•åŒ–æ¸¬è©¦ã€‚

#### 7.3.2 è«‹ç•™æ„è­¦å‘Šçš„è¨Šæ¯

ç›¡é‡æ¶ˆé™¤çœ‹åˆ°çš„è­¦å‘Šï¼Œä¸€æ—¦å‡ºç¾è­¦å ±ç–²å‹ï¼ˆalarm fatigueï¼‰ï¼Œç¨‹å¼å“è³ªå°±æœƒè¶Šä¾†è¶Šå·®äº†

### 7.4 å®Œå…¨ä¿¡ä»»ç·¨è­¯å™¨

ç·¨è­¯å™¨ç„¡æ³•çŸ¥é“ç¨‹å¼ç¢¼æ˜¯å¦è§£æ±ºäº†æˆ‘å€‘æœŸæœ›çš„å•é¡Œï¼Œä½†ä»–èƒ½å‘Šè¨´æˆ‘å€‘é€™éš»ç¨‹å¼æ˜¯å¦æœƒå´©æ½°ç•¶æ‰ã€‚

:::tip
linter ä¹ŸåŒæ¨£é‡è¦
:::

ä½œè€…èªç‚ºæˆ‘å€‘æ‡‰è©²è¦ä¿æŒå¥½å¥‡å¿ƒï¼Œå°Šé‡ç·¨è­¯å™¨çš„è¼¸å‡ºï¼š

> If you're the smartest person in the room, you're in the wrong room.
