---
title: "Ch13: è®“ä¸è‰¯çš„ç¨‹å¼ç¢¼å‡¸é¡¯å‡ºä¾†"
sidebar_position: 13
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';


## åé‡æ§‹

* å°‡ä¸è‰¯çš„ç¨‹å¼ç¢¼å‡¸é¡¯å‡ºä¾†ï¼Œèƒ½ä¸€çœ¼çœ‹å‡ºçš„åšæ³•
* åœ¨ç¢ºä¿ä¸æœƒç ´å£ç¨‹å¼ç¢¼çš„å‰æä¸‹ï¼Œæ•…æ„å°‡ç¨‹å¼å¯«çˆ›

## ç™¼å‡ºæµç¨‹å•é¡Œçš„è¨Šè™Ÿ

* æˆ‘å€‘æ²’è¾¦æ³•ç¸½æ˜¯å°‡ç¨‹å¼å¯«å¾—å¥½
    * ç¨‹å¼ç¢¼æˆ–å•é¡Œæœ¬èº«çš„è¤‡é›œæ€§
    * æ™‚é–“ä¸å¤ 
    * ä¸ç¢ºå®šè©²æ€éº¼åš
* äº¤ä»˜ã€Œç³Ÿç³•çš„ç¨‹å¼ç¢¼ã€æœƒæ¯”äº¤ä»˜ã€Œå°‡å•é¡Œéš±è—èµ·ä¾†çš„ç¨‹å¼ç¢¼ã€ä¾†çš„å¥½

:::info Discussion
ä¸‹åˆ—å…©å€‹ç¯„ä¾‹ï¼Œå“ªå€‹æ¯”è¼ƒå¥½ï¼Ÿ
:::

<Row>
<Col col={2}>

```typescript title="Example1"
function animate() {
    handleChosen();
    handleDisplaying();
    handleCompleted();
    handleMoving();
}

function handleChosen() {
    if (value >= threshold
     && banner.state === "chosen") {
        // ...
    }
}

function handleDisplaying() {
    if (value >= target
     && banner.state === "displaying") {
        // ...
    }
}

function handleCompleted() {
    if (banner.state === "completed") {
        // ...
    }
}
```

</Col>
<Col col={2}>

```typescript title="Example2"
function animate() {
    // FIXME: All concern banner.state
    if (value >= threshold
     && banner.state === State.Chosen) {
        // ...
    }
    if (value >= target
     && banner.state === State.Displaying) {
        // ...
    }
    if (banner.state === State.Completed) {
        // ...
    }
}
```

</Col>
</Row>

## åˆ†é›¢å„ªè³ªå’Œéºç•™ç¨‹å¼ç¢¼

* ç¨‹å¼ç¢¼è¶Šç³Ÿï¼Œå°±è¶Šå®¹æ˜“è¢«ç™¼ç¾
    * ä¸å¯èƒ½å¯«å‡ºæ²’æœ‰å•é¡Œçš„ç¨‹å¼ç¢¼
    * è¿…é€Ÿç™¼ç¾å•é¡Œå¾ˆé‡è¦
* ã€Œå¦‚æœæ²’æœ‰è¾¦æ³•åšå¾—å¾ˆå¥½ï¼Œå°±è®“ä»–é¡¯çœ¼ä¸€é»ã€
* **Quite good > Bad > Good enough**
* é‡æ§‹æ˜¯é€£é–åæ‡‰
    * ç‚ºäº†è®“ç¨‹å¼ç¢¼è®Šå¥½ï¼Œæ„å‘³è‘—éœ€è¦è®“å‘¨åœçš„ç¨‹å¼ç¢¼ä¹Ÿè®Šå¥½
* ç‚ºäº†é¿å…ã€Œç ´çª—æ•ˆæ‡‰ã€
    * ğŸ’” åæ­£é€™è£¡çš„codeå¯«å¾—å¾ˆç³Ÿï¼Œæˆ‘å¯«ç³Ÿåœ¨æ—é‚Šä¹Ÿä¸æœƒæ€éº¼æ¨£
    * âœ… æŠŠå¥½çš„codeå’Œå£çš„codeåˆ†é–‹æ”¾ï¼Œåœ¨å¥½codeçš„æ—é‚Šæœƒæ¸›å°‘å‡ºç¾ç³Ÿç³•çš„codeçš„æ©Ÿæœƒ

## ä¸è‰¯ç¨‹å¼ç¢¼çš„ç‰¹å¾µ

### ç°¡å–®è€Œå…·é«” - æœ¬æ›¸çš„è¦å‰‡

```typescript title="é•èƒŒè‰¯å¥½è¦å‰‡çš„ç¨‹å¼ç¢¼"
function minimum(arr: number[][]) {
    let result = 99999;
    for (let x = 0; x < arr.length; x++) {
        for (let y = 0; y < arr[x].length; y++) {
            if (arr[x][y] < result)
                result = arr[x][y];
            }
    }
    return result;
}
```

* ã€Œ[äº”è¡Œè¦å‰‡](/docs/sg/five-lines-of-code/ch3#311-rule-five-lines)ã€
* ã€Œ[åƒ…åœ¨é–‹é ­ä½¿ç”¨if](/docs/sg/five-lines-of-code/ch3#311-rule-five-lines)ã€


### ç¨‹å¼ç¢¼ç•°å‘³

* ç°¡å–®çš„ç•°å‘³ï¼šã€Œé­”æ³•æ•¸å­—ã€ã€Œé‡è¤‡çš„ç¨‹å¼ç¢¼ã€
* æœ‰çš„å¾ˆé›£ï¼Œéœ€è¦ç·´ç¿’é‡æ§‹ä¸€æ®µæ™‚é–“æ‰æœƒå¸å¼•ä½ çš„ç›®å…‰

```typescript
function minimum(arr: number[][]) {
    let result = 99999;  // Bad smells: Magic number
    for (let x = 0; x < arr.length; x++) {
        for (let y = 0; y < arr[x].length; y++) {
            if (arr[x][y] < result)
                result = arr[x][y];
        }
    }
    return result;
}
```

### å¾ªç’°è¤‡é›œåº¦ - å®¢è§€æŒ‡æ¨™

* ä¸€å€‹è¿´åœˆã€ä¸€å€‹ifï¼Œéƒ½æœƒå¢åŠ å¾ªç’°è¤‡é›œåº¦(cyclomatic complexity)
* é€šå¸¸å¯ä»¥ç”¨ç¸®æ’æ·±åº¦è¨ˆç®—

```typescript
function minimum(arr: number[][]) { // +1
    let result = 99999;
    for (let x = 0; x < arr.length; x++) { // +1
        for (let y = 0; y < arr[x].length; y++) { // +1
            if (arr[x][y] < result) // +1
                result = arr[x][y];
        }
    }
    return result;
}
// total cyclomatic complexity = 4
```

### èªçŸ¥è¤‡é›œåº¦ - ä¸»è§€æŒ‡æ¨™

* ã€Œè®€å–é€™æ®µcodeçš„ç”¨é€”ï¼Œéœ€è¦åœ¨è…¦è¢‹ä¸­è¨˜ä½å¤šå°‘è³‡è¨Šé‡ã€
* æ›´æ¥è¿‘äººå€‘é–±è®€codeçš„è©•ä¼°

```typescript
function minimum(arr: number[][]) {
    let result = 99999;
    for (let x = 0; x < arr.length; x++) { // +1
        for (let y = 0; y < arr[x].length; y++) { // +2
            if (arr[x][y] < result) // +3
                result = arr[x][y];
        }
    }
    return result;
}
// total cognitive complexity = 6
```

## ç ´å£ç¨‹å¼ç¢¼

1. <span style={{color: "#33a8ff"}}>ä¸è¦ç ´å£æ­£ç¢ºçš„è³‡è¨Š</span>
2. <span style={{color: "#33a8ff"}}>ä¸è¦è®“æœªä¾†çš„é‡æ§‹è®Šå›°é›£</span>
3. <span style={{color: "#33a8ff"}}>çµæœæ‡‰è©²è¦å¼•äººæ³¨ç›®</span>


### ä½¿ç”¨enum (4.1.3çš„åé‡æ§‹)

1. enumæœ‰åç¨±ï¼Œå°‡è³‡è¨Šä¿ç•™ä¸‹ä¾†
2. å°enumçš„é‡æ§‹æœ‰æ—¢å®šçš„æ¨™æº–æµç¨‹
    1. ã€Œ[ä½¿ç”¨é¡åˆ¥æ›¿ä»£å‹åˆ¥](/docs/sg/five-lines-of-code/ch4#413-replace-type-code-with-classes)ã€
    2. ã€Œ[æŠŠç¨‹å¼ç¢¼ç§»åˆ°é¡åˆ¥ä¸­](/docs/sg/five-lines-of-code/ch4#414-pushing-code-into-classes)ã€
    3. ã€Œ[å˜—è©¦åˆªé™¤å¾Œå†ç·¨è­¯](/docs/sg/five-lines-of-code/ch4#451-é‡æ§‹æ¨¡å¼åˆªé™¤å¾Œå†ç·¨è­¯try-delete-then-compile)ã€
3. Enumå¾ˆå¼•äººæ³¨ç›®


<Row>
<Col col={2}>

```typescript title="Before"
class Package {
    private priority: boolean; scheduleDispatch() {
        if (this.priority)
            dispatchImmediately(this);
        else
            queue.push(this);
    }
}




```

</Col>
<Col col={2}>

```typescript title="After"
enum Importance {
    Priority,
    Regular
}
class Package {
    private priority: Importance; scheduleDispatch() {
        if (this.priority === Importance.Priority)
            dispatchImmediately(this);
        else
            queue.push(this);
    }
}
```

</Col>
</Row>

### ä½¿ç”¨æ•´æ•¸å’Œå­—ä¸²ä½œç‚ºå‹åˆ¥ç¢¼

<Row>
<Col col={2}>

```typescript title="String as Type"


functionarea(width:number, shape:string) {
    if (shape === "circle")
        return (width/2) * (width/2) * Math.PI;
    else if (shape === "square")
        return width * width;
}
```

</Col>
<Col col={2}>

```typescript title="Integer as Type"
const CIRCLE = 0;
const SQUARE = 1;
function area(width: number, shape: number) {
    if (shape === CIRCLE)
        return (width/2) * (width/2) * Math.PI;
    else if (shape === SQUARE)
        return width * width;
}
```

</Col>
</Row>

### å°‡é­”æ³•æ•¸å­—åŠ å…¥ç¨‹å¼ç¢¼ä¸­

* å¹¾ä¹æ‰€æœ‰äººçœ‹åˆ°magic numberéƒ½æœƒæœ‰åæ‡‰
    * ğŸ’” æœƒä¸æœƒæ„Ÿè¬ä½ çš„ç”¨å¿ƒè‰¯è‹¦å°±é›£èªªäº†
    * âœ… é€™ç¨®codeå¾ˆå®¹æ˜“è¢«æ”¹æ­£

<Row>
<Col col={2}>

```typescript title="Before"
const FOUR_THIRDS = 4/3;
class Sphere {
    volume() {
        let result = FOUR_THIRDS;
        for (let i = 0; i < 3; i++)
            result = result * this.radius;
        return result * Math.PI;
    }
}
```

</Col>
<Col col={2}>

```typescript title="After"
class Sphere {
    volume() {
        let result = 4/3; // Magic
        for (let i = 0; i < 3; i++)
            result = result * this.radius;
        return result * 3.141592653589793; // Magic
    }
}
```

</Col>
</Row>

### æ–°å¢è¨»é‡‹åˆ°ç¨‹å¼ç¢¼ä¸­ (Ch8çš„åé‡æ§‹)

<Row>
<Col col={2}>

```typescript title="Before"
function subMin(arr: number[][]) {

    let min = Number.POSITIVE_INFINITY;
    for (let x = 0; x < arr.length; x++) {
        for(let y = 0; y < arr[x].length; y++) {
            min = Math.min(min, arr[x][y]);
        }
    }
}


for (let x = 0; x < arr.length; x++) {
    for(let y = 0; y < arr[x].length; y++) {
        arr[x][y] -= min;
    }
}
```

</Col>
<Col col={2}>

```typescript title="After"
function subMin(arr: number[][]) {
    // Find miniumn
    let min = Number.POSITIVE_INFINITY;
    for (let x = 0; x < arr.length; x++) {
        for(let y = 0; y < arr[x].length; y++) {
            min = Math.min(min, arr[x][y]);
        }
    }
}

// Sub from each element
for (let x = 0; x < arr.length; x++) {
    for(let y = 0; y < arr[x].length; y++) {
        arr[x][y] -= min;
    }
}
```

</Col>
</Row>

### åœ¨ç¨‹å¼ç¢¼ä¸­åŠ å…¥ç©ºç™½

<Row>
<Col col={2}>

```typescript title="Before"
let cursor = cursor+1 % arr.length;
// å¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„
```

</Col>
<Col col={2}>

```typescript title="After"
let cursor = (cursor + 1) % arr.length;
// å‡¸é¡¯å‡ºå„ªå…ˆåºï¼Œè€Œä¸æ˜¯ä¾è³´é‹ç®—å­æœ¬èº«çš„å„ªå…ˆåº
```

</Col>
</Row>


:::danger Javascriptèˆ‡ç©ºç™½
åœ¨JSä¸­ï¼Œç©ºç™½èˆ‡æ–·è¡Œä¸æœƒè¢«è¦–ç‚ºåŸ·è¡Œçš„ä¸€éƒ¨ä»½
```javascript
// Initial variable
let init = 20

// Run IIFE
((data) => {
    console.log(data+1)
})(init)
```
:::

### ä¾æ“šå‘½åå°äº‹ç‰©åˆ†çµ„ (11.6çš„åæ¨¡å¼)

* é€éå‘½åçš„å…±åŒå­—é¦–ã€å­—å°¾ï¼Œå‡¸é¡¯å‡ºåƒæ•¸é–“çš„é—œä¿‚
* å¾ŒçºŒåŸ·è¡Œè¦å‰‡ã€Œ[å°è£è³‡æ–™](/docs/sg/five-lines-of-code/ch11#é€éå°è£åˆ©ç”¨é€šç”¨çš„å­—é¦–å­—å°¾)ã€é€²è¡Œä¿®æ­£

<Row>
<Col col={2}>

```typescript title="Before"

class PopupWindow {
    private windowPosition: Point2d;
    private hasFocus: number;
    private screenWidth: number;
    private screenHeight: number;
    private windowSize: Point2d;
}
```

</Col>
<Col col={2}>

```typescript title="After"
class PopupWindow {
    private windowPosition: Point2d; // prefix
    private windowSize: Point2d; // prefix
    private hasFocus: number;
    private screenWidth: number; // prefix
    private screenHeight: number; // prefix
}
```

</Col>
</Row>


### åœ¨åç¨±ä¸­åŠ ä¸Šè„ˆçµ¡

<Row>
<Col col={2}>

```typescript title="Before"
function avg(arr: number[]) {
    return sum(arr) / size(arr);
}
function size(arr: number[]) {
    return arr.length;
}
function sum(arr: number[]) {
    let sum = 0;
    for (let i = 0; i < arr.length; i++) {
        sum += arr[i];
    }
    return sum;
}
```

</Col>
<Col col={2}>

```typescript title="After"
function avg_ArrUtil(arr: number[]) {
    return sum(arr) / size(arr);
}
function size_ArrUtil(arr: number[]) {
    return arr.length;
}
function sum_ArrUtil(arr: number[]) {
    let sum = 0;
    for (let i = 0; i < arr.length; i++) {
        sum += arr[i];
    }
    return sum;
}
```

</Col>
</Row>

### å»ºç«‹é•·æ–¹æ³•

* æŒ‡è¡Œæ•¸å¾ˆé•·çš„function
* å¾ˆæ˜é¡¯ï¼Œå¼•äººæ³¨ç›®æƒ³å›ä¾†æ”¹å®ƒ

```typescript
function animate() {
    if (value >= threshold
     && banner.state === State.Chosen) {
        // ...
    }
    if (value >= target
     && banner.state === State.Displaying) {
        // ...
    }
    if (banner.state === State.Completed) {
        // ...
    }
}
```


### è®“æ–¹æ³•æœ‰å¾ˆå¤šåƒæ•¸

* ä½œè€…æœ€å–œæ­¡çš„ä¸€å€‹æé†’çš„æ–¹æ³•

```typescript
function stringConstructor(
    prefix: string, // åƒæ•¸å¾ˆå¤šï¼Œå¼•äººæ³¨ç›®
    joiner: string,
    postfix: string,
    parts: string[]
) {
    return prefix + parts.join(joiner) + postfix;
}
```

### ä½¿ç”¨getterå’Œsetter (Ch6çš„åé‡æ§‹)

* é¿å…ä½¿ç”¨å…¨åŸŸè®Šæ•¸æˆ–å…¬é–‹æ¬„ä½çš„å¦¥å”åšæ³•

```typescript
class Screen {
    constructor(
        private width: number,
        private height: number
    ) {}
    getWidth() { return this.width; }
    getHeight() { return this.height; }
}
let screen: Screen;
```
